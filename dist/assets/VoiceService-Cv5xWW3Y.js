import{_ as e}from"./main-BTanfOAJ.js";import"./vendor-7JQXQzuE.js";class t{constructor(){this.isListening=!1,this.isStarting=!1,this.hasError=!1,this.isProcessingCommand=!1,this.recognition=null,this.currentType=null,this.isModalOpen=!1,this.retryCount=0,this.maxRetries=3,this.microphonePermissionChecked=!1,this.hasReceivedSpeech=!1,this.hasRecognizedSomething=!1,this.shouldKeepListening=!0,this.createModalIfNeeded(),this.inicializarSistemaAprendizagem()}createModalIfNeeded(){const e=document.getElementById("voice-modal");if(e){if(e.querySelector(".voice-content-premium"))return;e.remove()}document.body.insertAdjacentHTML("beforeend",'\n      <div id="voice-modal" class="voice-modal-premium" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);">\n        \n        \x3c!-- Background animado com part√≠culas --\x3e\n        <div class="voice-background" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%), radial-gradient(circle at 40% 80%, rgba(120, 200, 255, 0.3) 0%, transparent 50%), linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%); animation: backgroundShift 8s ease-in-out infinite;"></div>\n        \n        \x3c!-- Part√≠culas flutuantes --\x3e\n        <div class="floating-particles">\n          <div class="particle" style="position: absolute; width: 4px; height: 4px; background: rgba(255,255,255,0.6); border-radius: 50%; animation: float1 6s ease-in-out infinite; top: 20%; left: 10%;"></div>\n          <div class="particle" style="position: absolute; width: 6px; height: 6px; background: rgba(255,255,255,0.4); border-radius: 50%; animation: float2 8s ease-in-out infinite; top: 60%; right: 15%;"></div>\n          <div class="particle" style="position: absolute; width: 3px; height: 3px; background: rgba(255,255,255,0.8); border-radius: 50%; animation: float3 7s ease-in-out infinite; bottom: 30%; left: 20%;"></div>\n          <div class="particle" style="position: absolute; width: 5px; height: 5px; background: rgba(255,255,255,0.5); border-radius: 50%; animation: float4 9s ease-in-out infinite; top: 40%; right: 30%;"></div>\n        </div>\n\n        \x3c!-- Modal principal - OTIMIZADO PARA MOBILE --\x3e\n        <div class="voice-content-premium" style="position: relative; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-radius: 12px; padding: 0; max-width: 320px; width: 85%; max-height: 75vh; text-align: center; box-shadow: 0 8px 16px rgba(0,0,0,0.25), 0 0 0 1px rgba(255,255,255,0.1); transform: scale(0.8) translateY(20px); opacity: 0; transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); overflow: hidden; display: flex; flex-direction: column;">\n          \n          \x3c!-- Header com gradiente - COMPACTO --\x3e\n          <div class="voice-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 8px 6px 6px; position: relative; overflow: hidden;">\n            \x3c!-- Efeito de brilho --\x3e\n            <div class="shine-effect" style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%); animation: shine 3s ease-in-out infinite;"></div>\n            \n            \x3c!-- √çcone principal animado - MENOR --\x3e\n            <div class="voice-icon-container" style="position: relative; display: inline-block; margin-bottom: 2px;">\n              <div class="voice-icon-glow" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 32px; height: 32px; background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%); border-radius: 50%; animation: iconGlow 2s ease-in-out infinite;"></div>\n              <div class="voice-icon" style="font-size: 20px; position: relative; z-index: 2; animation: iconPulse 2s ease-in-out infinite; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));">üé§</div>\n            </div>\n            \n            \x3c!-- T√≠tulo principal - MENOR --\x3e\n            <h3 class="voice-title" style="color: white; font-size: 14px; font-weight: 800; margin-bottom: 1px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); letter-spacing: -0.5px;">Estou te ouvindo!</h3>\n            \n            \x3c!-- Subt√≠tulo - MENOR --\x3e\n            <p class="voice-subtitle" style="color: rgba(255,255,255,0.9); font-size: 9px; margin-bottom: 0; font-weight: 500; line-height: 1.1;">Fale naturalmente como voc√™ gastou ou recebeu dinheiro</p>\n          </div>\n\n          \x3c!-- Corpo do modal - COMPACTO --\x3e\n          <div class="voice-body" style="padding: 6px; background: white; overflow-y: auto; flex: 1; max-height: calc(75vh - 100px); min-height: 120px;">\n            \n            \x3c!-- Indicador de escuta avan√ßado - COMPACTO --\x3e\n            <div class="voice-status-premium" style="display: flex; justify-content: center; align-items: center; gap: 4px; margin-bottom: 6px; padding: 4px; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 6px; border: 1px solid rgba(148, 163, 184, 0.1);">\n              <div class="sound-wave" style="display: flex; gap: 1px; align-items: center;">\n                <div class="wave-bar" style="width: 2px; height: 6px; background: linear-gradient(to top, #667eea, #764ba2); border-radius: 1px; animation: waveBar1 1.2s ease-in-out infinite;"></div>\n                <div class="wave-bar" style="width: 2px; height: 8px; background: linear-gradient(to top, #667eea, #764ba2); border-radius: 1px; animation: waveBar2 1.2s ease-in-out infinite;"></div>\n                <div class="wave-bar" style="width: 2px; height: 7px; background: linear-gradient(to top, #667eea, #764ba2); border-radius: 1px; animation: waveBar3 1.2s ease-in-out infinite;"></div>\n                <div class="wave-bar" style="width: 2px; height: 8px; background: linear-gradient(to top, #667eea, #764ba2); border-radius: 1px; animation: waveBar4 1.2s ease-in-out infinite;"></div>\n                <div class="wave-bar" style="width: 2px; height: 5px; background: linear-gradient(to top, #667eea, #764ba2); border-radius: 1px; animation: waveBar5 1.2s ease-in-out infinite;"></div>\n              </div>\n              <span style="color: #64748b; font-size: 9px; font-weight: 600; margin-left: 4px;">Escutando...</span>\n            </div>\n            \n            \x3c!-- Exemplos com design premium - COMPACTO --\x3e\n            <div class="examples-container" style="background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); border-radius: 6px; padding: 4px; margin-bottom: 4px; border: 1px solid rgba(148, 163, 184, 0.1);">\n              <div style="display: flex; align-items: center; gap: 2px; margin-bottom: 4px;">\n                <span style="font-size: 8px;">üí°</span>\n                <h4 style="color: #1e293b; font-size: 8px; font-weight: 700; margin: 0;">Como falar corretamente</h4>\n              </div>\n              \n              \x3c!-- Exemplos de Transa√ß√£o - ATUALIZADOS --\x3e\n              <div style="margin-bottom: 4px;">\n                <div style="display: flex; align-items: center; gap: 2px; margin-bottom: 2px;">\n                  <span style="font-size: 7px;">üí∞</span>\n                  <h5 style="color: #1e293b; font-size: 7px; font-weight: 600; margin: 0;">Transa√ß√µes:</h5>\n                </div>\n                \n                <div class="example-item" style="background: white; border-radius: 3px; padding: 2px; margin-bottom: 2px; border-left: 1px solid #667eea; box-shadow: 0 1px 1px rgba(0,0,0,0.05);">\n                  <p style="color: #475569; font-size: 6px; margin: 0; font-weight: 500; line-height: 1.1;">\n                    <strong>Despesa:</strong> descri√ß√£o, valor, tipo, categoria\n                  </p>\n                </div>\n                \n                <div class="example-item" style="background: white; border-radius: 3px; padding: 2px; margin-bottom: 2px; border-left: 1px solid #10b981; box-shadow: 0 1px 1px rgba(0,0,0,0.05);">\n                  <p style="color: #475569; font-size: 6px; margin: 0; font-weight: 500; line-height: 1.1;">\n                    <strong>Receita:</strong> descri√ß√£o, valor, tipo, categoria\n                  </p>\n                </div>\n              </div>\n              \n              \x3c!-- Exemplos de Categoria - ATUALIZADOS --\x3e\n              <div>\n                <div style="display: flex; align-items: center; gap: 2px; margin-bottom: 2px;">\n                  <span style="font-size: 7px;">üìÅ</span>\n                  <h5 style="color: #1e293b; font-size: 7px; font-weight: 600; margin: 0;">Categorias:</h5>\n                </div>\n                \n                <div class="example-item" style="background: white; border-radius: 3px; padding: 2px; border-left: 1px solid #764ba2; box-shadow: 0 1px 1px rgba(0,0,0,0.05);">\n                  <p style="color: #475569; font-size: 6px; margin: 0; font-weight: 500; line-height: 1.1;">\n                    <strong>B√°sica:</strong> nome, tipo e limite\n                  </p>\n                </div>\n              </div>\n            </div>\n            \n            \x3c!-- Bot√µes de a√ß√£o --\x3e\n            <div class="action-buttons" style="display: flex; flex-direction: column; gap: 6px; margin-top: 6px;">\n              \x3c!-- Bot√£o para tentar novamente (m√≥vel) --\x3e\n              <button onclick="window.restartVoiceRecognition()" class="restart-btn-mobile" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 10px 16px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3); position: relative; overflow: hidden; width: 100%; display: none;">\n                <span style="position: relative; z-index: 2;">üé§ Falar Novamente</span>\n              </button>\n              \n              \x3c!-- Bot√£o de cancelar premium - MAIOR E MAIS VIS√çVEL --\x3e\n              <button onclick="window.closeVoiceModal()" class="cancel-btn-premium" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 3px 6px rgba(239, 68, 68, 0.4); position: relative; overflow: hidden; width: 100%; flex-shrink: 0; text-transform: uppercase; letter-spacing: 0.5px;">\n                <span style="position: relative; z-index: 2;">‚úï Cancelar</span>\n                <div class="btn-shine" style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s ease;"></div>\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n    ');const t=document.createElement("style");t.textContent="\n      @keyframes backgroundShift {\n        0%, 100% { background-position: 0% 50%; }\n        50% { background-position: 100% 50%; }\n      }\n      \n      @keyframes float1 {\n        0%, 100% { transform: translateY(0px) rotate(0deg); }\n        50% { transform: translateY(-20px) rotate(180deg); }\n      }\n      \n      @keyframes float2 {\n        0%, 100% { transform: translateY(0px) rotate(0deg); }\n        50% { transform: translateY(-30px) rotate(-180deg); }\n      }\n      \n      @keyframes float3 {\n        0%, 100% { transform: translateY(0px) rotate(0deg); }\n        50% { transform: translateY(-25px) rotate(90deg); }\n      }\n      \n      @keyframes float4 {\n        0%, 100% { transform: translateY(0px) rotate(0deg); }\n        50% { transform: translateY(-35px) rotate(-90deg); }\n      }\n      \n      @keyframes shine {\n        0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }\n        100% { transform: translateX(100%) translateY(100%) rotate(45deg); }\n      }\n      \n      @keyframes iconGlow {\n        0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.3; }\n        50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.6; }\n      }\n      \n      @keyframes iconPulse {\n        0%, 100% { transform: scale(1); }\n        50% { transform: scale(1.05); }\n      }\n      \n      @keyframes waveBar1 {\n        0%, 100% { height: 20px; }\n        50% { height: 40px; }\n      }\n      \n      @keyframes waveBar2 {\n        0%, 100% { height: 32px; }\n        50% { height: 50px; }\n      }\n      \n      @keyframes waveBar3 {\n        0%, 100% { height: 24px; }\n        50% { height: 42px; }\n      }\n      \n      @keyframes waveBar4 {\n        0%, 100% { height: 28px; }\n        50% { height: 46px; }\n      }\n      \n      @keyframes waveBar5 {\n        0%, 100% { height: 16px; }\n        50% { height: 34px; }\n      }\n      \n      .voice-modal-open .voice-modal-premium {\n        opacity: 1 !important;\n        pointer-events: auto !important;\n      }\n      \n      .voice-modal-open .voice-content-premium {\n        transform: scale(1) translateY(0) !important;\n        opacity: 1 !important;\n      }\n      \n      .example-item:hover {\n        transform: translateY(-2px) !important;\n        box-shadow: 0 4px 16px rgba(0,0,0,0.1) !important;\n      }\n      \n      .cancel-btn-premium:hover {\n        transform: translateY(-2px) !important;\n        box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4) !important;\n      }\n      \n      .cancel-btn-premium:hover .btn-shine {\n        left: 100% !important;\n      }\n      \n      .cancel-btn-premium:active {\n        transform: translateY(0) !important;\n      }\n      \n      /* === RESPONSIVIDADE MOBILE OTIMIZADA === */\n      @media (max-width: 480px) {\n        .voice-content-premium {\n          max-width: 90vw !important;\n          width: 90vw !important;\n          max-height: 70vh !important;\n          margin: 0 5vw !important;\n        }\n        \n        .voice-body {\n          padding: 4px !important;\n          max-height: calc(70vh - 80px) !important;\n          min-height: 100px !important;\n        }\n        \n        .voice-header {\n          padding: 6px 4px 4px !important;\n        }\n        \n        .voice-title {\n          font-size: 12px !important;\n        }\n        \n        .voice-subtitle {\n          font-size: 8px !important;\n        }\n        \n        .voice-icon {\n          font-size: 18px !important;\n        }\n        \n        .examples-container {\n          padding: 3px !important;\n          margin-bottom: 3px !important;\n        }\n        \n        .cancel-btn-premium {\n          padding: 10px 16px !important;\n          font-size: 13px !important;\n          margin-top: 4px !important;\n        }\n        \n        .voice-status-premium {\n          padding: 3px !important;\n          margin-bottom: 4px !important;\n        }\n        \n        .voice-status-premium span {\n          font-size: 8px !important;\n        }\n      }\n      \n      /* === DISPOSITIVOS MUITO PEQUENOS === */\n      @media (max-width: 360px) {\n        .voice-content-premium {\n          max-width: 95vw !important;\n          width: 95vw !important;\n          max-height: 65vh !important;\n        }\n        \n        .voice-body {\n          max-height: calc(65vh - 70px) !important;\n          min-height: 90px !important;\n        }\n        \n        .cancel-btn-premium {\n          padding: 8px 12px !important;\n          font-size: 12px !important;\n        }\n      }\n    ",document.head.appendChild(t)}init(){if(!this.checkBrowserSupport())return this.showError("Seu navegador n√£o suporta reconhecimento de voz. Use Chrome ou Edge."),!1;if(!this.checkHTTPS())return this.showError("O reconhecimento de voz requer HTTPS. Por favor, acesse o site via HTTPS."),!1;try{this.setupRecognition()}catch(e){return!1}try{this.setupGlobalEvents()}catch(e){}return!0}checkBrowserSupport(){return"webkitSpeechRecognition"in window||"SpeechRecognition"in window}checkHTTPS(){return"https:"===location.protocol||"localhost"===location.hostname}setupRecognition(){try{const e=window.SpeechRecognition||window.webkitSpeechRecognition;this.recognition=new e;const t=/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),a=/Android/i.test(navigator.userAgent);this.recognition.lang="pt-BR",t||a?(this.recognition.continuous=!1,this.recognition.interimResults=!1,this.recognition.maxAlternatives=1):(this.recognition.continuous=!0,this.recognition.interimResults=!0,this.recognition.maxAlternatives=1),void 0!==this.recognition.serviceURI&&(this.recognition.serviceURI="wss://www.google.com/speech-api/v2/recognize"),this.recognition.onstart=()=>this.handleRecognitionStart(),this.recognition.onresult=e=>this.handleRecognitionResult(e),this.recognition.onerror=e=>this.handleRecognitionError(e),this.recognition.onend=()=>this.handleRecognitionEnd(),this.recognition.onspeechstart=()=>this.handleSpeechStart(),this.recognition.onspeechend=()=>this.handleSpeechEnd(),this.recognition.onsoundstart=()=>this.handleSoundStart(),this.recognition.onsoundend=()=>this.handleSoundEnd(),this.recognition.onaudiostart&&(this.recognition.onaudiostart=()=>{this.updateModalStatus("","Microfone ativo...","listening")}),this.recognition.onaudioend&&(this.recognition.onaudioend=()=>{})}catch(e){this.showError("Erro ao configurar reconhecimento de voz")}}handleRecognitionStart(){this.isListening=!0,this.hasReceivedSpeech=!1,this.updateModalStatus("","Aguardando sua voz...","listening")}handleSpeechStart(){this.hasReceivedSpeech=!0,this.updateModalStatus("","Ouvindo...","listening")}handleSpeechEnd(){}handleSoundStart(){}handleSoundEnd(){}handleRecognitionResult(e){this.noSpeechCount=0;const t=/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),a=e.results[e.results.length-1],o=a[0].transcript.trim(),i=a[0].confidence||.8,n=a.isFinal;if(a.length>1)for(let r=0;r<Math.min(a.length,3);r++);this.normalizeText(o);!o||o.length<2||(n?(this.updateModalStatus("",`Voc√™ disse: "${o}"`,"processing"),t?this.isProcessingCommand||this.processCommand(o,i):setTimeout(()=>{this.isProcessingCommand||this.processCommand(o,i)},200)):t||this.updateModalStatus("",`Ouvindo: "${o}..."`,"listening"))}handleRecognitionError(e){this.isListening=!1,this.isStarting=!1;const t=this.getErrorMessage(e.error);if(this.hasError=!0,setTimeout(()=>{this.hasError=!1},5e3),"no-speech"===e.error)return this.noSpeechCount||(this.noSpeechCount=0),this.noSpeechCount++,this.noSpeechCount>=5?(this.updateModalStatus("","üé§ Clique no bot√£o do microfone para tentar novamente","waiting"),void(this.noSpeechCount=0)):void(this.hasReceivedSpeech?setTimeout(()=>{!this.isModalOpen||this.isListening||this.isStarting||this.isProcessingCommand||(this.hasError=!1,this.startListening(this.currentType))},3e3):setTimeout(()=>{!this.isModalOpen||this.isListening||this.isStarting||this.isProcessingCommand||(this.hasError=!1,this.startListening(this.currentType))},1e3));this.updateModalStatus("",t,"error"),this.shouldRetry(e.error)&&this.retryCount<this.maxRetries?(this.retryCount++,setTimeout(()=>{this.isModalOpen&&(this.hasError=!1,this.startListening(this.currentType))},2e3)):setTimeout(()=>{this.closeModal()},3e3)}handleRecognitionEnd(){this.isListening=!1,this.isStarting=!1;if(/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){if(this.isModalOpen&&!this.isProcessingCommand&&!this.hasError){this.updateModalStatus("","Toque no microfone para falar novamente","waiting");const e=document.querySelector(".restart-btn-mobile");e&&(e.style.display="block"),setTimeout(()=>{this.isModalOpen&&!this.isProcessingCommand&&this.closeModal()},5e3)}return}const e=this.hasReceivedSpeech&&!this.isProcessingCommand?1e3:500;!this.isModalOpen||this.isListening||this.hasError||this.isProcessingCommand||setTimeout(()=>{!this.isModalOpen||this.isListening||this.isStarting||this.isProcessingCommand||this.startListening(this.currentType)},e)}async processCommand(e,t){try{this.isProcessingCommand=!0;const t=this.normalizeText(e),a=this.determineCommandType(t);await this.stopAllRecognition();const o=await this.executeCommand(t,a);this.showSuccess(o),setTimeout(()=>{this.closeModal()},1e3)}catch(a){this.showError(`Erro ao processar comando: ${a.message}`),setTimeout(()=>{this.closeModal()},2e3)}finally{this.isProcessingCommand=!1}}normalizeText(e){return e.toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"").trim()}determineCommandType(e){const t=this.detectarComandoExplicito(e);if(t)return t;const a=this.analisarIntencao(e),o=this.analisarEstrutura(e),i=this.analisarContexto(e),n=this.calcularScoresFinais(a,o,i);return this.determinarComandoFinal(n,e)}detectarComandoExplicito(e){const t={query:[/\b(saldo|qual.*saldo|saldo atual|quanto.*tenho|meu saldo)\b/i,/\b(quanto.*gastei|quanto.*recebi|total.*gastos)\b/i,/\b(consultar|verificar|mostrar).*\b(saldo|gastos|receitas)\b/i],navigation:[/\b(ir para|va para|v√° para|mostrar|abrir|navegar).*(dashboard|transacoes|transa√ß√µes|categorias|recorrentes)\b/i,/\b(abrir|mostrar).*(tela|p√°gina).*(dashboard|transacoes|transa√ß√µes|categorias)\b/i],category:[/\b(nova categoria|criar categoria|adicionar categoria|inserir categoria)\b/i,/\b(categoria nova|categoria).*(criar|adicionar|nova)\b/i,/\b(quero|vou|preciso).*(criar|adicionar|fazer).*(categoria)\b/i],transaction:[/\b(nova transacao|nova transa√ß√£o|criar transacao|criar transa√ß√£o|adicionar transacao|adicionar transa√ß√£o)\b/i,/\b(registrar|anotar).*(gasto|despesa|receita|compra)\b/i]};for(const[a,o]of Object.entries(t))for(const t of o)if(t.test(e))return a;return null}analisarIntencao(e){const t={transaction:0,category:0,query:0,navigation:0},a=["gastei","paguei","comprei","recebi","ganhei","custou","custa","pago","despendi","investi","economizei","lucrei","perdi","transferi"];for(const s of a)e.includes(s)&&(t.transaction+=.8);const o=["reais","real","dinheiro","valor","pre√ßo","preco","custou","custa","pagamento","quantia","montante","total"];for(const s of o)e.includes(s)&&(t.transaction+=.4);const i=["categoria","tipo de gasto","classificacao","classifica√ß√£o","grupo","limite","orcamento","or√ßamento"];for(const s of i)e.includes(s)&&(t.category+=.7);const n=["criar","adicionar","inserir","nova","novo","fazer"];for(const s of n)e.includes(s)&&e.includes("categoria")&&(t.category+=.6);const r=["quanto","qual","como est√°","mostrar","verificar","consultar","saber"];for(const s of r)e.includes(s)&&(t.query+=.5);return t}analisarEstrutura(e){const t=this.extractCommandItems(e),a=t.filter(e=>"valor"===e.type),o=t.filter(e=>"tipo"===e.type),i=t.filter(e=>"categoria"===e.type),n=t.filter(e=>"descricao"===e.type),r=t.filter(e=>"comando"===e.type),s={totalItens:t.length,valores:a.length,tipos:o.length,categorias:i.length,descricoes:n.length,comandos:r.length,scores:{transaction:0,category:0,query:0,navigation:0}};return 3===t.length&&(o.length>=1?s.scores.category+=2:s.scores.category+=1.5),t.length>=4&&(s.scores.transaction+=1,a.length>0&&(s.scores.transaction+=.5)),r.some(e=>"categoria"===e.value||"criar"===e.value||"nova"===e.value)&&(s.scores.category+=.8),a.length>0&&!r.some(e=>["categoria","criar","nova"].includes(e.value))&&3!==t.length&&(s.scores.transaction+=.7),n.length>=3&&3!==t.length&&(s.scores.transaction+=.4),o.length>=1&&0===a.length&&t.length<=3&&(s.scores.category+=.5),s}analisarContexto(e){const t={transaction:{locais:["supermercado","restaurante","farmacia","farm√°cia","posto","shopping","loja"],acoes:["compra","pagamento","gasto","despesa","receita","entrada"],temporais:["hoje","ontem","semana","mes","m√™s","dia"]},category:{organizacionais:["organizar","classificar","separar","definir","estabelecer"],planejamento:["planejar","controlar","gerenciar","administrar","limite","or√ßamento","orcamento"]},query:{interrogativos:["quanto","qual","como","onde","quando"],informativos:["situa√ß√£o","situacao","estado","posi√ß√£o","posicao","balan√ßo","balanco"]}},a={transaction:0,category:0,query:0,navigation:0};for(const[o,i]of Object.entries(t))for(const[t,n]of Object.entries(i))for(const i of n)if(e.includes(i)){const e="locais"===t?.3:"acoes"===t?.4:"temporais"===t?.2:"organizacionais"===t?.5:"planejamento"===t?.4:"interrogativos"===t?.6:.3;a[o]+=e}return a}calcularScoresFinais(e,t,a){const o={transaction:0,category:0,query:0,navigation:0},i=.2,n=.6,r=.2;for(const c of Object.keys(o))o[c]=e[c]*i+t.scores[c]*n+a[c]*r;const s=Math.max(...Object.values(o));if(s>1)for(const c of Object.keys(o))o[c]=o[c]/s;return o}determinarComandoFinal(e,t){let a="transaction",o=e[a];for(const[n,r]of Object.entries(e))r>o&&(a=n,o=r);if(o<.3){if(/\b\d+\b/.test(t))return"transaction";if(/categoria/i.test(t))return"category"}const i=Object.entries(e).sort(([,e],[,t])=>t-e);return i[0][1]-i[1][1]<.1&&"category"===i[0][0]&&"transaction"===i[1][0]?"transaction":a}extractCommandItems(e){const t=e.toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"").trim(),a=[];this.detectValues(t).forEach(e=>a.push({type:"valor",value:e,confidence:"high"}));this.detectTypes(t).forEach(e=>a.push({type:"tipo",value:e,confidence:"high"}));this.detectCategories(t).forEach(e=>a.push({type:"categoria",value:e.nome,confidence:e.confidence}));this.detectDescriptions(t,a).forEach(e=>a.push({type:"descricao",value:e,confidence:"medium"}));return this.detectCommands(t).forEach(e=>a.push({type:"comando",value:e,confidence:"high"})),a.forEach((e,t)=>{}),a}detectValues(e){const t=[],a=[/\b\d{1,3}(?:\.\d{3})*(?:,\d{2})?\b/g,/\b\d{1,3}(?:,\d{3})*(?:\.\d{2})?\b/g,/\b\d+[.,]\d{1,2}\b/g,/\b\d+\b/g];for(const i of a){const a=e.match(i);a&&a.forEach(e=>{const a=this.parseNumero(e);a>0&&!t.includes(a.toString())&&t.push(a.toString())})}const o=this.parseNumeroPorExtensoCompleto(e);o>0&&t.push(o.toString());return t.map(e=>parseFloat(e)).sort((e,t)=>t-e).map(e=>e.toString())}parseNumero(e){if(!e)return 0;let t=e.trim();const a=(t.match(/\./g)||[]).length,o=(t.match(/,/g)||[]).length;if(a>0&&o>0)t=t.lastIndexOf(",")>t.lastIndexOf(".")?t.replace(/\./g,"").replace(",","."):t.replace(/,/g,"");else if(o>0&&0===a){const e=t.split(",");t=2===e.length&&e[1].length<=2?t.replace(",","."):t.replace(/,/g,"")}else if(a>0&&0===o){const e=t.split(".");2===e.length&&e[1].length<=2||(t=t.replace(/\./g,""))}const i=parseFloat(t);return isNaN(i)?0:i}parseNumeroPorExtensoCompleto(e){const t={zero:0,um:1,uma:1,dois:2,duas:2,tres:3,"tr√™s":3,quatro:4,cinco:5,seis:6,sete:7,oito:8,nove:9,dez:10,onze:11,doze:12,treze:13,catorze:14,quatorze:14,quinze:15,dezesseis:16,dezessete:17,dezoito:18,dezenove:19,vinte:20,trinta:30,quarenta:40,cinquenta:50,sessenta:60,setenta:70,oitenta:80,noventa:90,cem:100,cento:100,duzentos:200,trezentos:300,quatrocentos:400,quinhentos:500,seiscentos:600,setecentos:700,oitocentos:800,novecentos:900,mil:1e3,milhao:1e6,"milh√£o":1e6};for(const[o,i]of Object.entries(t)){if(new RegExp(`\\b${o}\\b`,"i").test(e))return i}const a=[/\b(vinte|trinta|quarenta|cinquenta|sessenta|setenta|oitenta|noventa)\s+e\s+(um|dois|tres|quatro|cinco|seis|sete|oito|nove)\b/i,/\b(um|dois|tres|quatro|cinco|seis|sete|oito|nove)?\s*mil\s*(e\s*)?(duzentos|trezentos|quatrocentos|quinhentos|seiscentos|setecentos|oitocentos|novecentos|cem|cento)?\b/i,/\b(cento|duzentos|trezentos|quatrocentos|quinhentos|seiscentos|setecentos|oitocentos|novecentos)\s*e\s*(vinte|trinta|quarenta|cinquenta|sessenta|setenta|oitenta|noventa)\b/i];for(const o of a){const t=e.match(o);if(t){const e=this.calcularValorComplexo(t[0]);if(e>0)return e}}return 0}calcularValorComplexo(e){const t={um:1,uma:1,dois:2,duas:2,tres:3,"tr√™s":3,quatro:4,cinco:5,seis:6,sete:7,oito:8,nove:9,dez:10,vinte:20,trinta:30,quarenta:40,cinquenta:50,sessenta:60,setenta:70,oitenta:80,noventa:90,cem:100,cento:100,duzentos:200,trezentos:300,quatrocentos:400,quinhentos:500,seiscentos:600,setecentos:700,oitocentos:800,novecentos:900,mil:1e3},a=e.toLowerCase().split(/\s+/).filter(e=>"e"!==e);let o=0,i=0;for(const n of a){const e=t[n];e&&(1e3===e?(o+=1e3*(i||1),i=0):i+=e)}return o+=i,o}detectTypes(e){const t=[];return/\b(despesa|despesas|gasto|gastos|gastar|gastei|paguei|comprei|compra|pagamento)\b/.test(e)&&t.push("despesa"),/\b(receita|receitas|entrada|entradas|renda|rendas|ganhei|recebi|salario|ganho)\b/.test(e)&&t.push("receita"),t}detectCategories(e){const t=[];if(!window.appState?.categories)return t;for(const a of window.appState.categories){const o=this.analisarCompatibilidadeCategoria(e,a);o.score>.4&&t.push({nome:a.nome,id:a.id,score:o.score,confidence:this.calcularConfiancaCategoria(o.score),existing:!0,motivo:o.motivo,detalhes:o.detalhes})}return t.sort((e,t)=>t.score-e.score),t.forEach((e,t)=>{}),t}analisarCompatibilidadeCategoria(e,t){const a=t.nome.toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,""),o=e.toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"");let i=0,n="";const r=[];o.includes(a)&&(i+=.8,n="correspond√™ncia exata",r.push(`Texto cont√©m "${a}"`));const s=this.calcularSimilaridade(a,o);s>.7&&(i+=.6*s,n=n||"similaridade de string",r.push(`Similaridade: ${(100*s).toFixed(1)}%`));const c=a.split(" ").filter(e=>e.length>2),d=o.split(" ").filter(e=>e.length>2);let l=0;for(const u of c)d.some(e=>e.includes(u)||u.includes(e))&&l++;if(l>0){i+=.5*(l/c.length),n=n||"correspond√™ncia de palavras",r.push(`${l}/${c.length} palavras encontradas`)}const p=this.verificarSinonimos(o,a,t.tipo);p>0&&(i+=p,n=n||"sin√¥nimos detectados",r.push(`Score de sin√¥nimos: ${p.toFixed(2)}`));const m=this.verificarContextoCategoria(o,t.tipo);return m>0&&(i+=.3*m,r.push(`Contexto de ${t.tipo}: ${m.toFixed(2)}`)),{score:Math.min(i,1),motivo:n,detalhes:r}}calcularSimilaridade(e,t){if(e===t)return 1;if(0===e.length||0===t.length)return 0;if(e.includes(t)||t.includes(e))return Math.max(t.length/e.length,e.length/t.length);const a=Math.max(e.length,t.length);let o=0;for(let i=0;i<e.length;i++)for(let a=Math.max(0,i-2);a<=Math.min(t.length-1,i+2);a++)if(e[i]===t[a]){o++;break}return o/a}verificarSinonimos(e,t,a){const o={alimentacao:["comida","restaurante","supermercado","lanche","jantar","almo√ßo","almoco","cafe","caf√©","padaria","mercado","feira","hamburguer","pizza","delivery","ifood"],"alimenta√ß√£o":["comida","restaurante","supermercado","lanche","jantar","almo√ßo","almoco","cafe","caf√©","padaria","mercado","feira","hamburguer","pizza","delivery","ifood"],comida:["alimentacao","alimenta√ß√£o","restaurante","supermercado","lanche","refeicao","refei√ß√£o"],transporte:["uber","taxi","onibus","√¥nibus","metro","metr√¥","gasolina","combustivel","combust√≠vel","posto","viagem","passagem","bilhete"],carro:["gasolina","combustivel","combust√≠vel","posto","estacionamento","mecanico","mec√¢nico","lavagem"],uber:["transporte","taxi","corrida","viagem"],saude:["farmacia","farm√°cia","medico","m√©dico","hospital","remedio","rem√©dio","consulta","exame","dentista"],"sa√∫de":["farmacia","farm√°cia","medico","m√©dico","hospital","remedio","rem√©dio","consulta","exame","dentista"],farmacia:["remedio","rem√©dio","medicamento","saude","sa√∫de"],casa:["luz","agua","√°gua","aluguel","condominio","condom√≠nio","internet","telefone","limpeza","manutencao","manuten√ß√£o"],moradia:["aluguel","casa","apartamento","condominio","condom√≠nio"],energia:["luz","eletricidade","conta de luz"],educacao:["escola","faculdade","curso","livro","material escolar","mensalidade"],"educa√ß√£o":["escola","faculdade","curso","livro","material escolar","mensalidade"],lazer:["cinema","teatro","show","festa","viagem","diversao","divers√£o","jogo","streaming"],entretenimento:["cinema","netflix","streaming","jogo","diversao","divers√£o"],trabalho:["salario","sal√°rio","pagamento","renda","freelance","projeto"],salario:["trabalho","renda","pagamento","vencimento"],"sal√°rio":["trabalho","renda","pagamento","vencimento"]};let i=0;const n=t.toLowerCase(),r=o[n]||[];for(const s of r)e.includes(s)&&(i+=.6);for(const[s,c]of Object.entries(o))e.includes(s)&&c.includes(n)&&(i+=.4);return Math.min(i,.8)}verificarContextoCategoria(e,t){const a=["gastei","paguei","comprei","custou","valor","preco","pre√ßo","dinheiro","reais"],o=["recebi","ganhei","salario","sal√°rio","renda","pagamento","entrada"];let i=0;if("despesa"===t)for(const n of a)e.includes(n)&&(i+=.2);else if("receita"===t)for(const n of o)e.includes(n)&&(i+=.2);return Math.min(i,.6)}calcularConfiancaCategoria(e){return e>=.8?"high":e>=.6?"medium":e>=.4?"low":"very-low"}detectDescriptions(e,t){const a=[],o=["adicionar","nova","novo","criar","inserir","registrar","de","da","do","na","no","em","para","por","com","valor","reais","real","r$","dinheiro","categoria","transacao","despesa","receita","gasto","entrada"],i=t.map(e=>e.value.toLowerCase().replace(/[.,!?;:]/g,"")),n=e.split(/\s+/).filter(e=>e.length>2).filter(e=>{const t=e.toLowerCase().replace(/[.,!?;:]/g,"");return!o.includes(t)}).filter(e=>{const t=e.toLowerCase().replace(/[.,!?;:]/g,"");return!i.includes(t)}).filter(e=>!/^\d+([.,]\d+)?$/.test(e)).filter(e=>e.replace(/[.,!?;:]/g,"").length>0);return a.push(...n),a}detectCommands(e){const t=[];return/\b(adicionar|nova|novo|criar|inserir|registrar)\b/.test(e)&&t.push("adicionar"),/\b(categoria)\b/.test(e)&&t.push("categoria"),/\b(transacao|transa√ß√£o)\b/.test(e)&&t.push("transacao"),t}async executeCommand(e,t){switch(t){case"query":return await this.handleQueryCommand(e);case"transaction":return await this.handleTransactionCommand(e);case"category":return await this.handleCategoryCommand(e);case"navigation":return await this.handleNavigationCommand(e);default:throw new Error("Tipo de comando n√£o reconhecido")}}async handleQueryCommand(e){if(/\b(saldo|qual.*saldo|saldo atual)\b/.test(e)){return`Saldo atual: R$ ${this.calculateBalance().toFixed(2)}`}if(/\b(despesas|gastos)\b/.test(e)){return`Total de despesas: R$ ${this.calculateExpenses().toFixed(2)}`}if(/\b(receitas|entradas)\b/.test(e)){return`Total de receitas: R$ ${this.calculateIncome().toFixed(2)}`}return"Comando de consulta n√£o reconhecido"}async handleTransactionCommand(e){this.extractCommandItems(e);const t=this.parseTransactionCommand(e);if(!t)throw new Error("N√£o foi poss√≠vel entender os dados da transa√ß√£o");const a=t.categoriaExistente?`categoria existente "${t.categoria}"`:`nova categoria "${t.categoria}"`;if(window.showAddTransactionModal){this.lastRecognizedTransaction={descricao:t.descricao,valor:t.valor,tipo:t.tipo,categoriaId:t.categoriaId,data:(new Date).toISOString().split("T")[0]},setTimeout(()=>{window.showAddTransactionModal(),setTimeout(()=>{this.preenchearCamposTransacao(this.lastRecognizedTransaction)},1e3)},500);const e=null!==t.valor?`de R$ ${t.valor.toFixed(2)}`:"(valor a definir)";return`‚úÖ Abrindo modal para transa√ß√£o: ${t.tipo} ${e} na ${a}`}if(window.addTransactionWithConfirmation)return await window.addTransactionWithConfirmation(t),`‚úÖ Transa√ß√£o confirmada: ${t.tipo} de R$ ${t.valor.toFixed(2)} na ${a}`;if(window.addTransaction)return await window.addTransaction(t),`‚úÖ Transa√ß√£o adicionada: ${t.tipo} de R$ ${t.valor.toFixed(2)} na ${a}`;throw new Error("Fun√ß√£o de adicionar transa√ß√£o n√£o dispon√≠vel")}async handleCategoryCommand(e){this.extractCommandItems(e);const t=this.parseCategoryCommand(e);if(!t||!t.nome)throw new Error("Nome da categoria n√£o foi entendido");if(window.showAddCategoryModal){this.lastRecognizedCategory={nome:t.nome,tipo:t.tipo,limite:t.limite||0},setTimeout(()=>{window.showAddCategoryModal(),setTimeout(()=>{this.preenchearCamposCategoria(this.lastRecognizedCategory)},1e3)},500);const e=t.limite>0?` com limite de R$ ${t.limite.toFixed(2)}`:"";return`‚úÖ Abrindo modal para categoria: "${t.nome}" (${t.tipo})${e}`}if(window.addCategory){await window.addCategory(t);const e=t.limite>0?` com limite de R$ ${t.limite.toFixed(2)}`:"";return`‚úÖ Categoria "${t.nome}" (${t.tipo})${e} adicionada com sucesso`}throw new Error("Fun√ß√£o de adicionar categoria n√£o dispon√≠vel")}async handleNavigationCommand(e){return/\b(dashboard|in√≠cio|principal)\b/.test(e)?(window.location.hash="#/dashboard","Navegando para o Dashboard"):/\b(transa√ß√µes|transa√ß√£o)\b/.test(e)?(window.location.hash="#/transactions","Navegando para Transa√ß√µes"):/\b(categorias|categoria)\b/.test(e)?(window.location.hash="#/dashboard","Navegando para Dashboard"):/\b(recorrentes|recorrente)\b/.test(e)?(window.location.hash="#/recorrentes","Navegando para Recorrentes"):"Comando de navega√ß√£o n√£o reconhecido"}parseTransactionCommand(e){const t={tipo:{receita:/\b(receita|receitas|entrada|entradas|ganhei|recebi|salario|ganhar|receber|renda|rendas|ganho|ganhos)\b/i},valor:[/(?:custou|custaram|paguei|gastei|foi|foram)\s*(?:de\s*)?(\d+(?:[.,]\d{1,2})?)\s*(?:reais?|r\$|real)?/i,/(?:de|por|valor)\s*(?:de\s*)?(\d+(?:[.,]\d{1,2})?)\s*(?:reais?|r\$|real)?/i,/(\d+(?:[.,]\d{1,2})?)\s*(?:reais?|r\$|real|dinheiro|pila|pratas?)/i,/(?:valor|custo|custou|pago|gastei|gasto|paguei|de|por)\s+(\d+(?:[.,]\d{1,2})?)/i,/(?:^|\s)(\d+(?:[.,]\d{1,2})?)\s*(?:reais?|r\$|real|dinheiro|pila|pratas?|$)/i,/\b(zero|uma?|dois|duas|tr√™s|tres|quatro|cinco|seis|sete|oito|nove|dez|onze|doze|treze|quatorze|catorze|quinze|dezesseis|dezessete|dezoito|dezenove|vinte|trinta|quarenta|cinquenta|sessenta|setenta|oitenta|noventa|cem|cento|duzentos|trezentos|quatrocentos|quinhentos|seiscentos|setecentos|oitocentos|novecentos|mil)\s*(?:reais?|r\$|real|dinheiro)?\b/i,/(\d+(?:[.,]\d{1,2})?)/g,/foi\s*(\d+)/i,/deu\s*(\d+)/i,/custa\s*(\d+)/i],categoria:[/\b(?:categoria|para|em|de|na categoria|tipo)\s+([a-z√°√†√¢√£√©√®√™√≠√¨√Æ√≥√≤√¥√µ√∫√π√ª√ß\s]+?)(?:\s*$|\s+(?:de|por|valor|reais?|r\$|custou|custa)\s*\d)/i,/\b(?:com|para|em|de)\s+([a-z√°√†√¢√£√©√®√™√≠√¨√Æ√≥√≤√¥√µ√∫√π√ª√ß\s]+?)(?:\s*$|\s+(?:de|por|valor|reais?|r\$|custou|custa))/i,/([a-z√°√†√¢√£√©√®√™√≠√¨√Æ√≥√≤√¥√µ√∫√π√ª√ß]+)\s*$/]};let a="despesa";t.tipo.receita.test(e)&&(a="receita");let o=null,i=null;const n=e.match(/\d+(?:[.,]\d{1,2})?/g);if(n){n.includes("100"),n.includes("200");const e=n.map(e=>({original:e,valor:parseFloat(e.replace(",","."))})).filter(e=>!isNaN(e.valor)&&e.valor>0).sort((e,t)=>t.valor-e.valor);if(e.length>0){o=e[0].valor}}const r={zero:0,um:1,uma:1,dois:2,duas:2,"tr√™s":3,tres:3,quatro:4,cinco:5,seis:6,sete:7,oito:8,nove:9,dez:10,onze:11,doze:12,treze:13,quatorze:14,catorze:14,quinze:15,dezesseis:16,dezessete:17,dezoito:18,dezenove:19,vinte:20,trinta:30,quarenta:40,cinquenta:50,sessenta:60,setenta:70,oitenta:80,noventa:90,cem:100,cento:100,duzentos:200,trezentos:300,quatrocentos:400,quinhentos:500,seiscentos:600,setecentos:700,oitocentos:800,novecentos:900,mil:1e3};if(!o||o<=0)for(let f=0;f<t.valor.length;f++){const a=t.valor[f];if(i=e.match(a),i){const e=i[1]||i[0];if(r[e.toLowerCase()])o=r[e.toLowerCase()];else{const t=e.replace(/[^\d.,]/g,"").replace(",","."),a=parseFloat(t);!isNaN(a)&&a>0&&(o=a,e.includes("100"),e.includes("200"))}if(o&&o>0)break;o=null,i=null}}if(!o){const t={zero:0,um:1,uma:1,dois:2,duas:2,"tr√™s":3,tres:3,quatro:4,cinco:5,seis:6,sete:7,oito:8,nove:9,dez:10,onze:11,doze:12,treze:13,quatorze:14,catorze:14,quinze:15,dezesseis:16,dezessete:17,dezoito:18,dezenove:19,vinte:20,trinta:30,quarenta:40,cinquenta:50,sessenta:60,setenta:70,oitenta:80,noventa:90,cem:100,cento:100,duzentos:200,trezentos:300,quatrocentos:400,quinhentos:500,seiscentos:600,setecentos:700,oitocentos:800,novecentos:900,mil:1e3},a=/\b(zero|uma?|dois|duas|tr√™s|tres|quatro|cinco|seis|sete|oito|nove|dez|onze|doze|treze|quatorze|catorze|quinze|dezesseis|dezessete|dezoito|dezenove|vinte|trinta|quarenta|cinquenta|sessenta|setenta|oitenta|noventa|cem|cento|duzentos|trezentos|quatrocentos|quinhentos|seiscentos|setecentos|oitocentos|novecentos|mil)\b/i,i=e.match(a);if(i){const e=i[1].toLowerCase();t[e]&&(o=t[e])}if(!o){const a=e.split(" ");for(const e of a)if(t[e.toLowerCase()]){o=t[e.toLowerCase()];break}}}o||(o=null);let s="Outros",c=null,d=null,l=e;i&&i[0]&&(l=e.replace(i[0],"").trim());const p=["de","da","do","na","no","em","para","por","com","foi","custou","gastei","paguei","comprei","valor","reais","real","r$","dinheiro","adicionar","nova","criar","inserir","despesa","receita","transacao","gasto","entrada"];l.toLowerCase().split(/\s+/).filter(e=>e.length>2).filter(e=>!p.includes(e)).filter(e=>!/^\d/.test(e));if(window.appState?.categories)for(const f of window.appState.categories){const t=f.nome.toLowerCase(),a=e.toLowerCase();if(a.includes(t)){d=f,s=f.nome;break}const o=t.split(" "),i=a.split(" ");let n=0;for(const e of o)e.length>2&&i.some(t=>t.includes(e)||e.includes(t))&&n++;if(n>0&&n>=.5*o.length){d=f,s=f.nome;break}}if(!d)for(const f of t.categoria)if(c=e.match(f),c&&c[1]){let e=c[1].trim();if(e=e.replace(/\b(de|por|valor|reais?|r\$|real|dinheiro|custou|custa)\b/gi,"").trim(),e.length>2){s=e;break}}const m=e.toLowerCase().split(" "),u=["adicionar","nova","criar","inserir","despesa","receita","transa√ß√£o","gasto","entrada","gastei","comprei","paguei","com","para","em","de","categoria","na","da","tipo","reais","real","dinheiro","valor","custou","custa","custando"];let h,g=null;for(const f of m)if(!/^\d+([.,]\d+)?$/.test(f)&&!u.includes(f)&&(!d||f!==d.nome.toLowerCase())&&f.length>=2){g=f;break}if(g)h=g.charAt(0).toUpperCase()+g.slice(1);else{if(h=e,i&&(h=h.replace(i[0],"")),c&&(h=h.replace(c[0],"")),d){const e=d.nome.toLowerCase(),t=new RegExp(`\\b${e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\b`,"gi");h=h.replace(t,"")}h=h.replace(/\b(adicionar|nova?|criar|inserir|transa√ß√£o|gasto|entrada|gastei|comprei|paguei)\b/gi,"").replace(/\b(com|para|em|de|categoria|na categoria|da categoria|tipo)\b/gi,"").replace(/\b(reais?|r\$|real|dinheiro|valor|custou|custa|custando)\b/gi,"").replace(/\b(despesa|receita)\b(?=.*\w)/gi,"").replace(/\s+/g," ").trim(),(!h||h.length<3)&&(h=null!==o?`${a.charAt(0).toUpperCase()+a.slice(1)} de R$ ${o.toFixed(2)}`:`${a.charAt(0).toUpperCase()+a.slice(1)}`)}return{tipo:a,valor:o,categoria:s,categoriaId:d?.id||null,categoriaExistente:!!d,descricao:h,data:(new Date).toISOString()}}parseCategoryCommand(e){const t=this.extractCommandItems(e);return 3===t.length?this.parseCategoryCommandFromItems(t,e):this.parseCategoryCommandTraditional(e)}parseCategoryCommandFromItems(e,t){let a=null,o="despesa",i=0;for(const n of e)switch(n.type){case"valor":i=parseFloat(n.value.replace(",","."));break;case"tipo":o=/^(receita|entrada)s?$/.test(n.value)?"receita":"despesa";break;case"descricao":a||(a=n.value.charAt(0).toUpperCase()+n.value.slice(1))}if(!a){const e=t.toLowerCase().split(" "),o=["adicionar","nova","novo","criar","inserir","categoria","despesa","receita","de","da","do","na","no","em","para","por","com","valor","reais","real","r$","dinheiro"];for(const t of e)if(t.length>2&&!o.includes(t)&&!/^\d+([.,]\d+)?$/.test(t)){a=t.charAt(0).toUpperCase()+t.slice(1);break}}if(!a)throw new Error("Nome da categoria n√£o foi entendido no comando de 3 itens");return{nome:a,tipo:o,limite:i||0,cor:this.getRandomColor()}}parseCategoryCommandTraditional(e){const t={nome:[/\b(?:categoria|categoria)\s+(?:chamada|de|para|com nome)\s+([a-z√°√†√¢√£√©√®√™√≠√¨√Æ√≥√≤√¥√µ√∫√π√ª√ß\s]+?)(?:\s+(?:tipo|despesa|receita|limite)\b|\s*$)/i,/\b(?:nova|criar|adicionar)\s+(?:categoria|categoria)\s+(?:chamada|de|para|com nome)?\s*([a-z√°√†√¢√£√©√®√™√≠√¨√Æ√≥√≤√¥√µ√∫√π√ª√ß\s]+?)(?:\s+(?:tipo|despesa|receita|limite)\b|\s*$)/i,/\b(?:categoria|categoria)\s+([a-z√°√†√¢√£√©√®√™√≠√¨√Æ√≥√≤√¥√µ√∫√π√ª√ß\s]+?)(?:\s+(?:tipo|despesa|receita|limite)\b|\s*$)/i,/\b([a-z√°√†√¢√£√©√®√™√≠√¨√Æ√≥√≤√¥√µ√∫√π√ª√ß\s]+?)\s+(?:categoria|despesa|receita)\b/i],tipo:{receita:/\b(receita|receitas|entrada|entradas|renda|rendas)\b/i},limite:[/\blimite\s+(?:de\s+)?(\d+(?:[.,]\d{1,2})?)/i,/(\d+(?:[.,]\d{1,2})?)\s*(?:reais?|r\$|real|dinheiro)/i,/(\d+(?:[.,]\d{1,2})?)/]};let a=null;for(const n of t.nome){const t=e.match(n);if(t&&t[1]&&(a=t[1].trim(),a=a.replace(/\b(nova?|criar|adicionar|categoria|tipo|despesa|receita|limite|de|por|valor|reais?|r\$|real|dinheiro)\b/gi,"").trim(),a.length>2))break}if(!a)throw new Error('Nome da categoria n√£o foi entendido. Diga algo como "nova categoria chamada transporte"');let o="despesa";t.tipo.receita.test(e)&&(o="receita");let i=0;for(const n of t.limite){const t=e.match(n);if(t){i=parseFloat(t[1].replace(",","."));break}}if(!i){const t={zero:0,um:1,uma:1,dois:2,duas:2,"tr√™s":3,tres:3,quatro:4,cinco:5,seis:6,sete:7,oito:8,nove:9,dez:10,onze:11,doze:12,treze:13,quatorze:14,catorze:14,quinze:15,dezesseis:16,dezessete:17,dezoito:18,dezenove:19,vinte:20,trinta:30,quarenta:40,cinquenta:50,sessenta:60,setenta:70,oitenta:80,noventa:90,cem:100,cento:100,duzentos:200,trezentos:300,quatrocentos:400,quinhentos:500,seiscentos:600,setecentos:700,oitocentos:800,novecentos:900,mil:1e3},a=/\b(zero|uma?|dois|duas|tr√™s|tres|quatro|cinco|seis|sete|oito|nove|dez|onze|doze|treze|quatorze|catorze|quinze|dezesseis|dezessete|dezoito|dezenove|vinte|trinta|quarenta|cinquenta|sessenta|setenta|oitenta|noventa|cem|cento|duzentos|trezentos|quatrocentos|quinhentos|seiscentos|setecentos|oitocentos|novecentos|mil)\b/i,o=e.match(a);if(o){const e=o[1].toLowerCase();t[e]&&(i=t[e])}if(!i){const a=e.split(" ");for(const e of a)if(t[e.toLowerCase()]){i=t[e.toLowerCase()];break}}}return{nome:a,tipo:o,limite:i||0,cor:this.getRandomColor()}}getRandomColor(){const e=["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FFEAA7","#DDA0DD","#98D8C8","#F7DC6F","#BB8FCE","#85C1E9","#F8C471","#82E0AA","#F1948A","#85C1E9","#D7BDE2"];return e[Math.floor(Math.random()*e.length)]}calculateBalance(){if(!window.appState?.transactions)return 0;return window.appState.transactions.filter(e=>"receita"===e.tipo).reduce((e,t)=>e+parseFloat(t.valor),0)-window.appState.transactions.filter(e=>"despesa"===e.tipo).reduce((e,t)=>e+parseFloat(t.valor),0)}calculateExpenses(){return window.appState?.transactions?window.appState.transactions.filter(e=>"despesa"===e.tipo).reduce((e,t)=>e+parseFloat(t.valor),0):0}calculateIncome(){return window.appState?.transactions?window.appState.transactions.filter(e=>"receita"===e.tipo).reduce((e,t)=>e+parseFloat(t.valor),0):0}getErrorMessage(e){return{"not-allowed":"Permiss√£o do microfone negada. Clique no √≠cone do microfone na barra de endere√ßos e permita o acesso.","no-speech":"Nenhuma fala detectada. Tente falar mais alto ou mais pr√≥ximo do microfone.","audio-capture":"Erro ao capturar √°udio. Verifique se o microfone est√° funcionando.",network:"Erro de rede. Verifique sua conex√£o com a internet.","service-not-allowed":"Servi√ßo de reconhecimento de voz n√£o permitido.","not-supported":"Reconhecimento de voz n√£o suportado neste navegador.",aborted:"Reconhecimento de voz interrompido.","audio-capture-device-not-found":"Microfone n√£o encontrado.","audio-capture-device-in-use":"Microfone em uso por outro aplicativo."}[e]||`Erro desconhecido: ${e}`}shouldRetry(e){return["network","service-not-allowed","audio-capture-device-in-use"].includes(e)}getRandomColor(){const e=["#3B82F6","#8B5CF6","#10B981","#F59E0B","#EF4444","#06B6D4"];return e[Math.floor(Math.random()*e.length)]}restartRecognition(){if(this.recognition&&this.isListening)try{this.recognition.stop()}catch(t){}this.isListening=!1,this.isStarting=!1,this.hasError=!1,this.hasReceivedSpeech=!1;const e=document.querySelector(".restart-btn-mobile");e&&(e.style.display="none"),setTimeout(()=>{this.startListening(this.currentType)},100)}openModal(e="transaction"){if(this.currentType=e,this.isModalOpen=!0,this.retryCount=0,this.recognition)try{if((this.hasError||!this.recognition.continuous)&&(this.recognition=null,!this.init()))return void this.showError("Erro ao inicializar reconhecimento de voz")}catch(o){if(this.recognition=null,!this.init())return void this.showError("Erro ao inicializar reconhecimento de voz")}else if(!this.init())return void this.showError("Erro ao inicializar reconhecimento de voz");this.createModalIfNeeded();const t=document.getElementById("voice-modal"),a=t?.querySelector(".voice-content-premium");t&&a&&(t.style.display="flex",t.style.pointerEvents="auto",t.style.opacity="1",a.style.transform="scale(1) translateY(0)",a.style.opacity="1",document.body.classList.add("voice-modal-open"),setTimeout(()=>{this.startListening(e)},500))}closeModal(){if(!this.isModalOpen)return;const e=document.getElementById("voice-modal"),t=e?.querySelector(".voice-content-premium");e&&t&&(this.stopAllRecognition().catch(e=>{}),this.isModalOpen=!1,this.isListening=!1,this.isStarting=!1,this.hasError=!1,this.isProcessingCommand=!1,this.retryCount=0,this.shouldKeepListening=!0,t.style.transform="scale(0.8) translateY(20px)",t.style.opacity="0",e.style.opacity="0",document.body.classList.remove("voice-modal-open"),setTimeout(()=>{e.style.pointerEvents="none",e.style.display="none"},500))}updateModalStatus(e,t,a){const o=document.getElementById("voice-modal");if(!o)return;const i=o.querySelector("h3"),n=o.querySelector("p"),r=o.querySelector(".voice-icon div"),s=o.querySelector(".voice-status"),c=s?.querySelector("p");if(i)switch(a){case"listening":i.textContent="üé§ Estou te ouvindo!";break;case"processing":i.textContent="üß† Processando...";break;case"error":i.textContent="‚ùå Ops! Algo deu errado";break;case"success":i.textContent="‚úÖ Perfeito!";break;default:i.textContent=e||"üé§ Estou te ouvindo!"}if(n)switch(a){case"listening":n.textContent="Fale naturalmente como voc√™ gastou ou recebeu dinheiro";break;case"processing":n.textContent="Entendendo o que voc√™ disse...";break;case"error":n.textContent=t||"Tente falar novamente de forma mais clara";break;case"success":n.textContent=t||"Transa√ß√£o adicionada com sucesso!";break;default:n.textContent=t||"Fale naturalmente como voc√™ gastou ou recebeu dinheiro"}if(r)switch(r.className="w-16 h-16 rounded-full flex items-center justify-center mx-auto shadow-lg",a){case"listening":default:r.classList.add("bg-gradient-to-r","from-green-400","to-blue-500","animate-pulse");break;case"processing":r.classList.add("bg-gradient-to-r","from-yellow-400","to-orange-500","animate-spin");break;case"error":r.classList.add("bg-gradient-to-r","from-red-400","to-pink-500");break;case"success":r.classList.add("bg-gradient-to-r","from-green-400","to-emerald-500")}if(s){if(s.querySelectorAll("div").forEach((e,t)=>{switch(e.classList.remove("animate-bounce","animate-pulse","bg-green-500","bg-blue-500","bg-yellow-500","bg-red-500"),a){case"listening":default:e.classList.add("animate-bounce","bg-green-500"),e.style.animationDelay=.1*t+"s";break;case"processing":e.classList.add("animate-pulse","bg-yellow-500"),e.style.animationDelay=.2*t+"s";break;case"error":e.classList.add("bg-red-500"),e.style.animationDelay="";break;case"success":e.classList.add("bg-green-500"),e.style.animationDelay=""}}),c)switch(a){case"listening":default:c.textContent="Microfone ativo",c.className="text-xs text-green-600 dark:text-green-400 font-medium";break;case"processing":c.textContent="Processando comando...",c.className="text-xs text-yellow-600 dark:text-yellow-400 font-medium";break;case"error":c.textContent="Erro no reconhecimento",c.className="text-xs text-red-600 dark:text-red-400 font-medium";break;case"success":c.textContent="Comando executado!",c.className="text-xs text-green-600 dark:text-green-400 font-medium"}}}async startListening(e="transaction"){try{const a=/Android/i.test(navigator.userAgent),o=!!window.Capacitor;if(a&&o){try{if(await this.tryCapacitorSpeechRecognition(e))return!0}catch(t){}if(!this.recognition)throw new Error("Reconhecimento n√£o configurado");this.setupAndroidListeners()}else if(window.permissionManager){if(!(await window.permissionManager.requestMicrophonePermission()))return this.isStarting=!1,this.showError("Permiss√£o do microfone necess√°ria para usar comando de voz"),!1}else if(!this.microphonePermissionChecked){if(!(await this.quickPermissionCheck()))return!1;this.microphonePermissionChecked=!0}if(!this.recognition)throw new Error("Reconhecimento n√£o configurado");if(this.isListening)return!0;this.currentType=e,this.updateModalStatus("","Iniciando...","processing");try{this.recognition.stop()}catch{}return this.isStarting=!0,this.recognition.start(),setTimeout(()=>{this.isStarting=!1},500),!0}catch(a){this.isStarting=!1;let t="Erro ao iniciar reconhecimento de voz";if("InvalidStateError"===a.name){if(await new Promise(e=>setTimeout(e,1e3)),!this.isListening&&!this.isStarting)return this.startListening(e);t="Sistema de voz ocupado. Tente novamente em alguns segundos."}else"NotSupportedError"===a.name?t="Reconhecimento de voz n√£o suportado neste navegador. Use Chrome ou Edge.":"NetworkError"===a.name&&(t="Erro de conex√£o. Verifique sua internet e tente novamente.");return this.showError(t),!1}}async tryCapacitorSpeechRecognition(t){try{const{getCapacitorSpeechRecognition:a}=await e(async()=>{const{getCapacitorSpeechRecognition:e}=await import("./CapacitorSpeechRecognition-DV09DXSe.js");return{getCapacitorSpeechRecognition:e}},[]),o=await a();return!!o.isAvailable&&(this.currentType=t,o.addEventListener("start",()=>{this.isListening=!0,this.isStarting=!1,this.updateModalStatus("üé§","Escutando... Fale agora!","listening");const e=document.querySelector(".restart-btn-mobile");e&&(e.style.display="block")}),o.addEventListener("result",async e=>{if(e.results&&e.results.length>0){const a=e.results[0].transcript;try{await o.stop()}catch(t){}this.processCommand(a,1)}}),o.addEventListener("error",e=>{this.isListening=!1,this.isStarting=!1,this.showError("Erro no reconhecimento de voz: "+e.error)}),o.addEventListener("end",()=>{this.isListening=!1}),await o.start(),!0)}catch(a){return!1}}async stopAllRecognition(){if(this.recognition&&this.isListening)try{this.recognition.stop()}catch(t){}if(window.Capacitor&&window.Capacitor.Plugins)try{const{getCapacitorSpeechRecognition:t}=await e(async()=>{const{getCapacitorSpeechRecognition:e}=await import("./CapacitorSpeechRecognition-DV09DXSe.js");return{getCapacitorSpeechRecognition:e}},[]),a=await t();a&&a.isListening&&await a.stop()}catch(t){}this.isListening=!1,this.isStarting=!1,this.shouldKeepListening=!1}setupAndroidListeners(){this.recognition&&(this.recognition.onstart=null,this.recognition.onresult=null,this.recognition.onerror=null,this.recognition.onend=null,this.recognition.onstart=()=>{this.isListening=!0,this.isStarting=!1,this.updateModalStatus("üé§","Escutando... Fale agora!","listening");const e=document.querySelector(".restart-btn-mobile");e&&(e.style.display="block")},this.recognition.onresult=e=>{this.handleRecognitionResult(e)},this.recognition.onerror=e=>{this.handleRecognitionError(e)},this.recognition.onend=()=>{this.isListening=!1,this.isStarting=!1,!this.hasRecognizedSomething&&this.shouldKeepListening&&setTimeout(()=>{this.isListening||this.isStarting||this.recognition.start()},100)})}async quickPermissionCheck(){try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return this.showError("Navegador n√£o suporta acesso ao microfone. Use Chrome, Edge ou Firefox."),!1;if(navigator.permissions)try{const e=await navigator.permissions.query({name:"microphone"});if("granted"===e.state)return!0;if("denied"===e.state)return this.showError("Permiss√£o do microfone negada. Permita o acesso ao microfone nas configura√ß√µes do navegador."),!1}catch{}const t=new Promise((e,t)=>setTimeout(()=>t(new Error("Timeout")),1e3)),a=navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});try{return(await Promise.race([a,t])).getTracks().forEach(e=>e.stop()),!0}catch(e){if("Timeout"===e.message)return!0;throw e}}catch(t){return"NotAllowedError"===t.name?(this.showError("Permiss√£o do microfone negada. Permita o acesso ao microfone nas configura√ß√µes do navegador."),!1):"NotFoundError"!==t.name||(this.showError("Nenhum microfone encontrado. Verifique se h√° um microfone conectado."),!1)}}async requestMicrophonePermission(){try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return!1;try{return(await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}})).getTracks().forEach(e=>e.stop()),!0}catch(e){try{const e=await navigator.mediaDevices.enumerateDevices();return 0===e.filter(e=>"audioinput"===e.kind).length?(this.showError("Nenhum microfone encontrado. Verifique se h√° um microfone conectado."),!1):(this.showError("Permiss√£o do microfone negada. Permita o acesso ao microfone nas configura√ß√µes do navegador."),!1)}catch(t){return this.showError("Erro ao verificar dispositivos de √°udio. Tente recarregar a p√°gina."),!1}}}catch(a){let e="Erro ao acessar microfone";return"NotFoundError"===a.name?e="Nenhum microfone encontrado. Verifique se h√° um microfone conectado.":"NotAllowedError"===a.name?e="Permiss√£o do microfone negada. Permita o acesso ao microfone nas configura√ß√µes do navegador.":"NotReadableError"===a.name?e="Microfone em uso por outro aplicativo. Feche outros aplicativos que possam estar usando o microfone.":"OverconstrainedError"===a.name?e="Configura√ß√£o de microfone n√£o suportada. Tente usar outro navegador.":"TypeError"===a.name&&(e="Navegador n√£o suporta acesso ao microfone. Use Chrome, Edge ou Firefox."),this.showError(e),!1}}showSuccess(e){this.updateModalStatus("",e,"success"),window.Snackbar&&"function"==typeof window.Snackbar.success?window.Snackbar.success(e):window.Snackbar&&"function"==typeof window.Snackbar.show?window.Snackbar.show(e,"success"):window.Snackbar&&"function"==typeof window.Snackbar?window.Snackbar({message:e,type:"success"}):window.alert&&alert(`‚úÖ ${e}`)}showError(e){this.updateModalStatus("",e,"error"),window.Snackbar&&"function"==typeof window.Snackbar.error?window.Snackbar.error(e):window.Snackbar&&"function"==typeof window.Snackbar.show?window.Snackbar.show(e,"error"):window.Snackbar&&"function"==typeof window.Snackbar?window.Snackbar({message:e,type:"error"}):window.alert&&alert(`‚ùå ${e}`)}setupGlobalEvents(){this.removeGlobalEvents(),this.escapeHandler=e=>{"Escape"===e.key&&this.isModalOpen&&this.closeModal()},document.addEventListener("keydown",this.escapeHandler),this.outsideClickHandler=e=>{const t=document.getElementById("voice-modal");e.target===t&&this.isModalOpen&&this.closeModal()},document.addEventListener("click",this.outsideClickHandler);const e=document.getElementById("close-voice-modal");if(e){const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),this.closeBtnHandler=e=>{e.preventDefault(),e.stopPropagation(),this.closeModal()},t.addEventListener("click",this.closeBtnHandler)}}removeGlobalEvents(){if(this.escapeHandler&&(document.removeEventListener("keydown",this.escapeHandler),this.escapeHandler=null),this.outsideClickHandler&&(document.removeEventListener("click",this.outsideClickHandler),this.outsideClickHandler=null),this.closeBtnHandler){const e=document.getElementById("close-voice-modal");e&&e.removeEventListener("click",this.closeBtnHandler),this.closeBtnHandler=null}}start(e="transaction"){try{if(!this.recognition&&!this.init())return!1;return document.getElementById("voice-modal")?(this.currentType=e,this.openModal(e),!0):(this.showError("Interface de voz n√£o dispon√≠vel"),!1)}catch(t){return this.showError(`Erro ao iniciar reconhecimento de voz: ${t.message}`),!1}}stop(){this.closeModal()}destroy(){this.recognition&&(this.recognition.stop(),this.recognition=null),this.removeGlobalEvents(),this.isModalOpen&&this.closeModal(),this.isListening=!1,this.isModalOpen=!1,this.retryCount=0}getLastRecognizedTransaction(){return this.lastRecognizedTransaction||null}getLastRecognizedCategory(){return this.lastRecognizedCategory||null}openTransactionModalWithLastData(){return!(!this.lastRecognizedTransaction||!window.showAddTransactionModal)&&(window.showAddTransactionModal(this.lastRecognizedTransaction),!0)}openCategoryModalWithLastData(){return!(!this.lastRecognizedCategory||!window.showAddCategoryModal)&&(window.showAddCategoryModal(this.lastRecognizedCategory),!0)}clearRecognizedData(){this.lastRecognizedTransaction=null,this.lastRecognizedCategory=null}async preenchearCamposCategoria(e){try{await this.aguardarCarregamentoModal();const t=await this.detectarCamposFormulario("category");await this.executarPreenchimentoComRetry(t,e,"category")}catch(t){this.executarPreenchimentoCategoria(e)}}async preenchearCamposTransacao(e){try{await this.aguardarCarregamentoModal();const t=await this.detectarCamposFormulario("transaction");await this.executarPreenchimentoComRetry(t,e,"transaction")}catch(t){this.executarPreenchimentoTransacao(e)}}executarPreenchimentoTransacao(e){try{const t=Array.from(document.querySelectorAll("input, select, textarea"));t.forEach((e,t)=>{});const a=(e,a)=>{for(const t of a){const e=document.querySelector(`[name="${t}"], #${t}, [id*="${t}"], [placeholder*="${t}"], [data-field="${t}"]`);if(e)return e}for(const o of t){const e=(o.placeholder||"").toLowerCase(),t=(o.name||"").toLowerCase(),i=(o.id||"").toLowerCase();for(const n of a)if(e.includes(n.toLowerCase())||t.includes(n.toLowerCase())||i.includes(n.toLowerCase()))return o}return null},o=(e,a=[])=>t.filter(t=>{const o=t.type||t.tagName.toLowerCase(),i=t.name||"",n=t.id||"";return o===e&&!a.some(e=>i.includes(e)||n.includes(e))})[0]||null,i=a("descri√ß√£o",["descricao","description","desc"])||o("text",["categoria","category","valor","value"]);i&&e.descricao&&(i.value=e.descricao,i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0})));const n=a("valor",["valor","value","amount","price"])||o("number");n&&null!==e.valor&&(n.value=e.valor,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})));const r=a("tipo",["tipo","type"])||t.find(e=>"SELECT"===e.tagName&&e.innerHTML.includes("despesa"));if(r&&e.tipo){const t=r.querySelectorAll("option");for(const a of t)if(a.value===e.tipo||a.textContent.toLowerCase().includes(e.tipo)){r.value=a.value,r.dispatchEvent(new Event("change",{bubbles:!0}));break}}const s=document.querySelector('select[name="categoriaId"], select[id="categoriaId"], select#categoriaId')||t.find(e=>"SELECT"===e.tagName&&("categoriaId"===e.name||"categoriaId"===e.id||"categoria"===e.name||"categoria"===e.id));if(s&&e.categoriaId){const t=s.querySelectorAll("option");Array.from(t).some(t=>t.value===e.categoriaId)&&(s.value=e.categoriaId,s.dispatchEvent(new Event("change",{bubbles:!0})))}}catch(t){}}executarPreenchimentoCategoria(e){try{Array.from(document.querySelectorAll("input, select, textarea"));const t=(e,t)=>{for(const a of t){const e=document.querySelector(`[name="${a}"], #${a}, [id*="${a}"], [placeholder*="${a}"]`);if(e)return e}return null},a=t("nome",["nome","name","categoria","category"]);a&&e.nome&&(a.value=e.nome,a.dispatchEvent(new Event("input",{bubbles:!0})),a.dispatchEvent(new Event("change",{bubbles:!0})));const o=t("tipo",["tipo","type"]);o&&e.tipo&&(o.value=e.tipo,o.dispatchEvent(new Event("change",{bubbles:!0})));const i=t("limite",["limite","limit","valor","amount"]);i&&e.limite&&(i.value=e.limite,i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0})))}catch(t){}}async aguardarCarregamentoModal(e=20,t=250){for(let a=1;a<=e;a++){const e=document.querySelectorAll('.modal, .dialog, [role="dialog"], [data-modal]'),a=Array.from(e).find(e=>{const t=window.getComputedStyle(e);return"none"!==t.display&&"hidden"!==t.visibility});if(a){if(a.querySelectorAll("input, select, textarea").length>0)return await this.sleep(200),!0}await this.sleep(t)}return!1}async detectarCamposFormulario(e){const t=this.obterDetectoresCampos(e),a={};for(const[i,n]of Object.entries(t)){let e=null;for(const t of n)try{const a=document.querySelectorAll(t);for(const t of a)if(this.ehElementoVisivel(t)){e=t;break}if(e)break}catch(o){}e&&(a[i]={elemento:e,tipo:this.identificarTipoCampo(e),estrategia:this.obterEstrategiaPreenchimento(e)})}return a}obterDetectoresCampos(e){return{transaction:{descricao:['input[name="descricao"]','input[name="description"]','input[id*="descric"]','input[placeholder*="descri√ß"]','input[placeholder*="description"]','textarea[name="descricao"]','textarea[name="description"]','input[type="text"]:not([name*="categoria"]):not([name*="category"]):not([name*="valor"]):not([name*="value"])'],valor:['input[name="valor"]','input[name="value"]','input[name="amount"]','input[name="price"]','input[type="number"]','input[placeholder*="valor"]','input[placeholder*="value"]','input[placeholder*="pre√ßo"]','input[placeholder*="quantia"]'],categoria:['select[name*="categoria"]','select[id*="categoria"]','select[name="categoriaId"]','select[id="categoriaId"]','select:has(option:contains("Alimenta√ß√£o"))','select:has(option:contains("Transporte"))','select:has(option[value*="cat"])','select[name="category"]','select[id="category"]'],tipo:['select[name="tipo"]','select[name="type"]','select[id="tipo"]','select[id="type"]','select:has(option[value="despesa"])','select:has(option[value="receita"])','input[name="tipo"]','input[name="type"]']},category:{nome:['input[name="nome"]','input[name="name"]','input[id*="nome"]','input[id*="name"]','input[placeholder*="nome"]','input[placeholder*="name"]','input[type="text"]:first-of-type'],tipo:['select[name="tipo"]','select[name="type"]','select[id="tipo"]','select[id="type"]','select:has(option[value="despesa"])','select:has(option[value="receita"])'],limite:['input[name="limite"]','input[name="limit"]','input[name="budget"]','input[type="number"]','input[placeholder*="limite"]']}}[e]||{}}ehElementoVisivel(e){if(!e)return!1;const t=window.getComputedStyle(e);return"none"!==t.display&&"hidden"!==t.visibility&&"0"!==t.opacity&&null!==e.offsetParent}identificarTipoCampo(e){return"SELECT"===e.tagName?"select":"TEXTAREA"===e.tagName?"textarea":"number"===e.type?"number":"text"===e.type?"text":"input"}obterEstrategiaPreenchimento(e){const t={select:t=>this.preencherSelect(e,t),number:t=>this.preencherNumerico(e,t),text:t=>this.preencherTexto(e,t),textarea:t=>this.preencherTexto(e,t),input:t=>this.preencherTexto(e,t)};return t[this.identificarTipoCampo(e)]||t.input}async executarPreenchimentoComRetry(e,t,a,o=3){let i=0,n=0;const r={transaction:{descricao:t.descricao,valor:t.valor,categoria:t.categoriaId,tipo:t.tipo},category:{nome:t.nome,tipo:t.tipo,limite:t.limite}}[a]||{};for(const[c,d]of Object.entries(r)){if(!d&&0!==d)continue;n++;const t=e[c];if(!t)continue;let a=!1;for(let e=1;e<=o;e++){try{if(await t.estrategia(d),await this.sleep(100),this.verificarPreenchimento(t.elemento,d)){i++,a=!0;break}}catch(s){}e<o&&await this.sleep(200)}}return(n>0?i/n*100:0)>=50}async preencherSelect(e,t){for(let a=0;a<e.options.length;a++)if(e.options[a].value===t||e.options[a].value===t.toString())return e.selectedIndex=a,void this.dispararEventos(e);for(let a=0;a<e.options.length;a++){const o=e.options[a].textContent.toLowerCase(),i=t.toString().toLowerCase();if(o.includes(i)||i.includes(o))return e.selectedIndex=a,void this.dispararEventos(e)}}async preencherNumerico(e,t){e.value=t.toString(),e.focus(),this.dispararEventos(e)}async preencherTexto(e,t){e.value=t.toString(),e.focus(),this.dispararEventos(e)}dispararEventos(e){["input","change","blur","keyup"].forEach(t=>{e.dispatchEvent(new Event(t,{bubbles:!0}))})}verificarPreenchimento(e,t){const a=e.value,o=t.toString();return"SELECT"===e.tagName?e.selectedIndex>0||a===o:a===o||a&&a.includes(o)}async sleep(e){return new Promise(t=>setTimeout(t,e))}inicializarSistemaAprendizagem(){this.aprendizagem={historico:this.carregarHistoricoAprendizagem(),patterns:this.carregarPatternsAprendidos(),feedbacks:[],melhorias:this.carregarMelhorias(),estatisticas:this.carregarEstatisticas()},this.configurarCapturaPadrao()}configurarCapturaPadrao(){document.addEventListener("input",e=>{this.estaGravando&&e.target.matches("input, select, textarea")&&this.capturarCorrecaoUsuario(e.target)}),document.addEventListener("submit",e=>{this.ultimoComandoVoz&&this.registrarSucessoComando(e.target)})}capturarCorrecaoUsuario(e){const t=e.dataset.voiceOriginal,a=e.value;t&&t!==a&&this.registrarFeedback({tipo:"correcao",textoOriginal:this.ultimoTextoReconhecido,valorOriginal:t,valorCorrigido:a,tipoCampo:this.identificarTipoCampo(e),timestamp:Date.now()})}registrarFeedback(e){this.aprendizagem.feedbacks.push(e),this.processarFeedbackImediato(e),this.aprendizagem.feedbacks.length%5==0&&this.salvarDadosAprendizagem()}processarFeedbackImediato(e){switch(e.tipo){case"correcao":this.aprenderCorrecao(e);break;case"categoria_incorreta":this.aprenderCategoria(e);break;case"valor_incorreto":this.aprenderValor(e)}}aprenderCorrecao(e){const{textoOriginal:t,valorOriginal:a,valorCorrigido:o,tipoCampo:i}=e,n=this.extrairPattern(t,a,o);if(n){const e=`${i}_${n.tipo}`;this.aprendizagem.patterns[e]||(this.aprendizagem.patterns[e]=[]),this.aprendizagem.patterns[e].push({entrada:n.entrada,saida:n.saida,confianca:1,usos:1,criado:Date.now()})}}extrairPattern(e,t,a){return this.ehNumero(t)&&this.ehNumero(a)?{tipo:"numero",entrada:this.extrairContextoNumero(e,t),saida:a}:this.ehCategoria(t,a)?{tipo:"categoria",entrada:this.extrairContextoCategoria(e,t),saida:a}:{tipo:"texto",entrada:e.toLowerCase(),saida:a}}aplicarAprendizagem(e,t){const a=this.aprendizagem.patterns[t]||[];for(const o of a.sort((e,t)=>t.confianca-e.confianca))if(this.patternSeAplica(e,o.entrada))return o.usos++,o.confianca=Math.min(o.confianca+.1,2),o.saida;return null}patternSeAplica(e,t){return this.calcularSimilaridade(e.toLowerCase(),t.toLowerCase())>.8}aprenderCategoria(e){const{textoOriginal:t,categoriaOriginal:a,categoriaCorreta:o}=e,i=this.extrairPalavrasChave(t);this.sinonimosCategoria[o]||(this.sinonimosCategoria[o]=[]),i.forEach(e=>{this.sinonimosCategoria[o].includes(e)||this.sinonimosCategoria[o].push(e)})}aprenderValor(e){const{textoOriginal:t,valorOriginal:a,valorCorrigido:o}=e,i=this.extrairContextoNumero(t,a);this.registrarPadraoNumerico(i,o)}registrarPadraoNumerico(e,t){this.aprendizagem.melhorias.numeros||(this.aprendizagem.melhorias.numeros=[]),this.aprendizagem.melhorias.numeros.push({contexto:e,valor:t,timestamp:Date.now()})}extrairPalavrasChave(e){const t=e.toLowerCase().replace(/[^\w\s√°√©√≠√≥√∫√¢√™√Æ√¥√ª√†√®√¨√≤√π√£√µ√ß]/g,"").split(/\s+/).filter(e=>e.length>2).filter(e=>!this.ehPalavraComum(e));return[...new Set(t)]}ehPalavraComum(e){return["que","para","com","uma","mais","foi","como","tem","s√£o","pelo","pela","suas","seus","esse","essa","isso","muito","fazer","ter","ser","estar","dar","ver","usar","criar"].includes(e)}extrairContextoNumero(e,t){const a=new RegExp(`(.{0,20})(${t})(.{0,20})`,"i"),o=e.match(a);return o?{antes:o[1].trim(),numero:o[2],depois:o[3].trim()}:{texto:e,numero:t}}extrairContextoCategoria(e,t){const a=new RegExp(`(.{0,30})(${t})(.{0,30})`,"i"),o=e.match(a);return o?{antes:o[1].trim(),categoria:o[2],depois:o[3].trim()}:{texto:e,categoria:t}}carregarHistoricoAprendizagem(){try{const e=localStorage.getItem("voiceSystem_historico");return e?JSON.parse(e):[]}catch(e){return[]}}carregarPatternsAprendidos(){try{const e=localStorage.getItem("voiceSystem_patterns");return e?JSON.parse(e):{}}catch(e){return{}}}carregarMelhorias(){try{const e=localStorage.getItem("voiceSystem_melhorias");return e?JSON.parse(e):{}}catch(e){return{}}}carregarEstatisticas(){try{const e=localStorage.getItem("voiceSystem_stats");return e?JSON.parse(e):{comandosProcessados:0,sucessos:0,correcoes:0,ultimaAtualizacao:Date.now()}}catch(e){return{comandosProcessados:0,sucessos:0,correcoes:0,ultimaAtualizacao:Date.now()}}}salvarDadosAprendizagem(){try{localStorage.setItem("voiceSystem_historico",JSON.stringify(this.aprendizagem.historico)),localStorage.setItem("voiceSystem_patterns",JSON.stringify(this.aprendizagem.patterns)),localStorage.setItem("voiceSystem_melhorias",JSON.stringify(this.aprendizagem.melhorias)),localStorage.setItem("voiceSystem_stats",JSON.stringify(this.aprendizagem.estatisticas))}catch(e){}}gerarRelatorioAprendizagem(){return{resumo:{totalComandos:this.aprendizagem.estatisticas.comandosProcessados,taxaSucesso:this.calcularTaxaSucesso(),totalCorrecoes:this.aprendizagem.estatisticas.correcoes,patternsAprendidos:Object.keys(this.aprendizagem.patterns).length},melhoriasPorTipo:this.analisarMelhoriasPorTipo(),categoriasMaisCorrigidas:this.analisarCategoriasMaisCorrigidas(),padroesAprendidos:this.listarPadroesAprendidos(),recomendacoes:this.gerarRecomendacoes()}}calcularTaxaSucesso(){const e=this.aprendizagem.estatisticas.comandosProcessados,t=this.aprendizagem.estatisticas.sucessos;return e>0?(t/e*100).toFixed(1):0}analisarMelhoriasPorTipo(){const e={};return this.aprendizagem.feedbacks.forEach(t=>{e[t.tipo]||(e[t.tipo]=0),e[t.tipo]++}),e}analisarCategoriasMaisCorrigidas(){const e={};return this.aprendizagem.feedbacks.filter(e=>"correcao"===e.tipo&&"categoria"===e.tipoCampo).forEach(t=>{const a=t.valorCorrigido;e[a]||(e[a]=0),e[a]++}),Object.entries(e).sort(([,e],[,t])=>t-e).slice(0,5)}listarPadroesAprendidos(){const e=[];return Object.entries(this.aprendizagem.patterns).forEach(([t,a])=>{a.forEach(a=>{e.push({tipo:t,confianca:a.confianca,usos:a.usos,entrada:a.entrada,saida:a.saida})})}),e.sort((e,t)=>t.confianca-e.confianca).slice(0,10)}gerarRecomendacoes(){const e=[],t=this.analisarErrosFrequentes();return t.numeros>5&&e.push("Considere falar n√∫meros de forma mais clara e pausada"),t.categorias>3&&e.push("Use nomes completos de categorias para melhor reconhecimento"),this.calcularTaxaSucesso()<70&&e.push("Sistema ainda est√° aprendendo seus padr√µes de fala"),e}analisarErrosFrequentes(){const e={numeros:0,categorias:0,texto:0};return this.aprendizagem.feedbacks.forEach(t=>{"number"===t.tipoCampo||"valor"===t.tipoCampo?e.numeros++:"select"===t.tipoCampo||"categoria"===t.tipoCampo?e.categorias++:e.texto++}),e}ehNumero(e){return!isNaN(parseFloat(e))&&isFinite(e)}ehCategoria(e,t){return isNaN(e)&&isNaN(t)&&"string"==typeof e&&"string"==typeof t}registrarSucessoComando(e){this.aprendizagem.estatisticas.sucessos++,this.aprendizagem.estatisticas.comandosProcessados++,this.aprendizagem.estatisticas.ultimaAtualizacao=Date.now(),this.salvarDadosAprendizagem()}registrarFalhaComando(){this.aprendizagem.estatisticas.comandosProcessados++,this.aprendizagem.estatisticas.ultimaAtualizacao=Date.now()}limparDadosAprendizagem(){localStorage.removeItem("voiceSystem_historico"),localStorage.removeItem("voiceSystem_patterns"),localStorage.removeItem("voiceSystem_melhorias"),localStorage.removeItem("voiceSystem_stats"),this.inicializarSistemaAprendizagem()}}"undefined"==typeof window||window.voiceSystem||(window.voiceSystem=new t);let a=null;function o(e){const t={zero:0,um:1,uma:1,dois:2,duas:2,"tr√™s":3,tres:3,quatro:4,cinco:5,seis:6,sete:7,oito:8,nove:9,dez:10,onze:11,doze:12,treze:13,quatorze:14,catorze:14,quinze:15,dezesseis:16,dezessete:17,dezoito:18,dezenove:19,vinte:20,trinta:30,quarenta:40,cinquenta:50,sessenta:60,setenta:70,oitenta:80,noventa:90,cem:100,cento:100,sem:100,duzentos:200,trezentos:300,quatrocentos:400,quinhentos:500,seiscentos:600,setecentos:700,oitocentos:800,novecentos:900,mil:1e3};return e?void 0!==t[e=e.toLowerCase().replace(/\./g,"")]?t[e]:e.includes(" e ")?e.split(" e ").reduce((e,t)=>{const a=o(t);return isNaN(a)?e:e+a},0):NaN:NaN}async function i(e){const t=e.toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"").split(" ");if(t.length<4)return void alert('Comando inv√°lido. Use: "descri√ß√£o valor tipo categoria"');let a=t.findIndex(e=>!isNaN(parseFloat(e))),i=NaN;if(-1!==a)i=parseFloat(t[a]);else for(let r=0;r<t.length;r++){const e=o(t[r]);if(!isNaN(e)&&e>0){i=e,a=r;break}}if(isNaN(i))return void alert('Valor n√£o encontrado no comando (diga um n√∫mero, ex: "cem", "duzentos", "mil" ou "100")');const n=t.findIndex(e=>/^(receita|receitas|despesa|despesas)$/.test(e));if(-1===n)return void alert("Tipo n√£o encontrado (receita ou despesa)");let s=t[n];/^receita/.test(s)&&(s="receita"),/^despesa/.test(s)&&(s="despesa");const c=t[t.length-1],d=t.slice(0,a).join(" "),l=window.appState.categories.find(e=>r(e.nome).includes(r(c))||r(c).includes(r(e.nome)));l?window.showAddTransactionModal({descricao:d,valor:i,tipo:s,categoriaId:l.id}):alert(`Categoria "${c}" n√£o encontrada. Crie a categoria primeiro.`)}async function n(e){const t=e.toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"").split(" ");if(t.length<3)return void alert('Comando inv√°lido. Use: "nome tipo limite"');const a=t.findIndex(e=>["receita","despesa"].includes(e));if(-1===a)return void alert("Tipo n√£o encontrado (receita ou despesa)");const i=t[a];let n=t.findIndex(e=>!isNaN(parseFloat(e))),r=NaN;if(-1!==n)r=parseFloat(t[n]);else for(let l=0;l<t.length;l++){const e=o(t[l]);if(!isNaN(e)&&e>0){r=e,n=l;break}}if(isNaN(r))return void alert('Limite n√£o encontrado (diga um n√∫mero, ex: "cem", "duzentos", "mil" ou "100")');const s=t.slice(0,a).join(" ");if(!s)return void alert("Nome da categoria n√£o encontrado");const c=["#4F46E5","#EF4444","#10B981","#F59E0B","#8B5CF6","#EC4899","#06B6D4","#84CC16"],d=c[Math.floor(Math.random()*c.length)];window.showAddCategoryModal({nome:s,tipo:i,limite:r,cor:d})}function r(e){return e.normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase().replace(/[.,;:!?]+$/,"").trim()}function s(){return window.voiceSystem||(window.voiceSystem=new t),window.voiceSystem}function c(e="transaction"){return s().start(e)}function d(){window.voiceSystem&&window.voiceSystem.stop()}function l(e="transaction"){return s().start(e)}async function p(e,t){if(window.voiceSystem)try{await window.voiceSystem.processCommand(e,t)}catch(a){window.Snackbar&&window.Snackbar.show(`Erro ao processar comando: ${a.message}`,"error")}}window.openVoiceModal=function(e="transaction"){return a||(a=new t),a.start(e)},window.closeVoiceModal=async function(){a&&(await a.stopAllRecognition(),a.stop())},window.startVoiceRecognition=function(e="transaction"){return a||(a=new t),a.start(e)},window.restartVoiceRecognition=function(){a&&a.restartRecognition()},"undefined"!=typeof window&&(window.debugVoiceSystem={testParse:e=>{const t=window.voiceSystem;if(!t)return null;return t.parseTransactionCommand(e)},simulate:e=>{const t=window.voiceSystem;if(!t)return null;const a=t.normalizeText(e);if("transaction"===t.determineCommandType(a)){return t.parseTransactionCommand(e)}return null},testNormalize:e=>{const t=window.voiceSystem;if(!t)return null;return t.normalizeText(e)},testModalOpen:(e,t)=>{const a=window.voiceSystem;if(!a)return null;if("transacao"===e&&window.showAddTransactionModal){const e=a.parseTransactionCommand(t);window.showAddTransactionModal(),setTimeout(()=>a.preenchearCamposTransacao(e),1e3)}else if("categoria"===e&&window.showAddCategoryModal){const e=a.parseCategoryCommand(t);window.showAddCategoryModal(),setTimeout(()=>a.preenchearCamposCategoria(e),1e3)}},inspectModal:()=>{const e=Array.from(document.querySelectorAll("input, select, textarea"));return e.forEach((e,t)=>{}),e},testFill:e=>{const t=window.voiceSystem;if(!t)return null;"transacao"===e.tipo?t.preenchearCamposTransacao(e):"categoria"===e.tipo&&t.preenchearCamposCategoria(e)},testReconhecimento:()=>{const e=window.voiceSystem;if(!e)return null;return[{texto:"gastei 100 reais com supermercado despesa",esperado:"transaction"},{texto:"comprei 200 reais de roupas despesa",esperado:"transaction"},{texto:"recebi 1500 salario receita trabalho",esperado:"transaction"},{texto:"paguei 50 farmacia saude despesa",esperado:"transaction"},{texto:"150 reais supermercado alimentacao despesa",esperado:"transaction"},{texto:"nova categoria alimentacao despesa",esperado:"category"},{texto:"criar categoria transporte despesa",esperado:"category"},{texto:"categoria saude receita",esperado:"category"},{texto:"lazer categoria despesa",esperado:"category"},{texto:"educacao despesa categoria",esperado:"category"},{texto:"alimentacao despesa 100",esperado:"transaction"},{texto:"categoria casa",esperado:"category"},{texto:"nova categoria",esperado:"category"}].forEach((t,a)=>{e.determineCommandType(t.texto),t.esperado}),"Teste de reconhecimento conclu√≠do!"},testRegra3vs4:()=>{const e=window.voiceSystem;if(!e)return null;return[{texto:"categoria alimentacao despesa",esperado:"category",itens:3},{texto:"criar lazer receita",esperado:"category",itens:3},{texto:"nova transporte despesa",esperado:"category",itens:3},{texto:"gastei 100 reais supermercado despesa",esperado:"transaction",itens:5},{texto:"comprei 50 farmacia saude despesa",esperado:"transaction",itens:5},{texto:"200 reais roupas alimentacao despesa",esperado:"transaction",itens:5}].forEach((t,a)=>{e.extractCommandItems(t.texto),e.determineCommandType(t.texto),t.esperado}),"Teste da regra 3 vs 4 itens conclu√≠do!"},testItemCount:e=>{const t=window.voiceSystem.extractItems(e),a=t.filter(e=>"tipo"===e.type),o=t.filter(e=>"valor"===e.type),i=t.filter(e=>"categoria"===e.type),n=t.filter(e=>"descricao"===e.type),r=t.filter(e=>"comando"===e.type),s=window.voiceSystem.detectCommandType(e);return{total:t.length,breakdown:{tipos:a,valores:o,categorias:i,descricoes:n,comandos:r},comando:s}},ajuda:()=>{}},window.debugVoiceSystem.ajuda());export{d as closeVoiceModal,s as getVoiceSystem,r as normalizarTexto,c as openVoiceModal,o as parseNumeroPorExtenso,n as processCategoryVoice,i as processTransactionVoice,p as processVoiceCommand,l as startVoiceRecognition};

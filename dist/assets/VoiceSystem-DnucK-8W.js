class z{constructor(){this.isListening=!1,this.isStarting=!1,this.hasError=!1,this.isProcessingCommand=!1,this.recognition=null,this.currentType=null,this.isModalOpen=!1,this.retryCount=0,this.maxRetries=3,this.microphonePermissionChecked=!1,this.hasReceivedSpeech=!1,console.log("üé§ VoiceSystem inicializado")}init(){if(console.log("üé§ Inicializando VoiceSystem..."),!this.checkBrowserSupport())return console.error("‚ùå Navegador n√£o suporta reconhecimento de voz"),this.showError("Seu navegador n√£o suporta reconhecimento de voz. Use Chrome ou Edge."),!1;if(!this.checkHTTPS())return console.error("‚ùå HTTPS necess√°rio para reconhecimento de voz"),this.showError("O reconhecimento de voz requer HTTPS. Por favor, acesse o site via HTTPS."),!1;try{this.setupRecognition(),console.log("‚úÖ Reconhecimento configurado")}catch(e){return console.error("‚ùå Erro ao configurar reconhecimento:",e),!1}try{this.setupGlobalEvents(),console.log("‚úÖ Eventos globais configurados")}catch(e){console.error("‚ùå Erro ao configurar eventos:",e)}return console.log("‚úÖ VoiceSystem inicializado com sucesso"),!0}checkBrowserSupport(){const e="webkitSpeechRecognition"in window||"SpeechRecognition"in window;return console.log("üîç Suporte ao reconhecimento de voz:",e),e}checkHTTPS(){const e=location.protocol==="https:"||location.hostname==="localhost";return console.log("üîç Protocolo seguro:",e),e}setupRecognition(){try{const e=window.SpeechRecognition||window.webkitSpeechRecognition;this.recognition=new e,this.recognition.lang="pt-BR",this.recognition.continuous=!0,this.recognition.interimResults=!0,this.recognition.maxAlternatives=1,this.recognition.serviceURI!==void 0&&(this.recognition.serviceURI="wss://www.google.com/speech-api/v2/recognize"),this.recognition.onstart=()=>this.handleRecognitionStart(),this.recognition.onresult=o=>this.handleRecognitionResult(o),this.recognition.onerror=o=>this.handleRecognitionError(o),this.recognition.onend=()=>this.handleRecognitionEnd(),this.recognition.onspeechstart=()=>this.handleSpeechStart(),this.recognition.onspeechend=()=>this.handleSpeechEnd(),this.recognition.onsoundstart=()=>this.handleSoundStart(),this.recognition.onsoundend=()=>this.handleSoundEnd(),console.log("‚úÖ Reconhecimento configurado com eventos adicionais")}catch(e){console.error("‚ùå Erro ao configurar reconhecimento:",e),this.showError("Erro ao configurar reconhecimento de voz")}}handleRecognitionStart(){console.log("üé§ Reconhecimento iniciado"),this.isListening=!0,this.hasReceivedSpeech=!1,this.updateModalStatus("","Aguardando sua voz...","listening")}handleSpeechStart(){console.log("üó£Ô∏è Fala detectada - in√≠cio"),this.hasReceivedSpeech=!0,this.updateModalStatus("","Ouvindo...","listening")}handleSpeechEnd(){console.log("üó£Ô∏è Fala detectada - fim")}handleSoundStart(){console.log("üîä Som detectado - in√≠cio")}handleSoundEnd(){console.log("üîä Som detectado - fim")}handleRecognitionResult(e){console.log("üé§ Resultado recebido:",e);const o=e.results[e.results.length-1],a=o[0].transcript,t=o[0].confidence,n=o.isFinal;console.log("üé§ Transcri√ß√£o:",a),console.log("üé§ Confian√ßa:",t),console.log("üé§ Final:",n),n?(console.log("‚úÖ Resultado final recebido, aguardando antes de processar..."),this.updateModalStatus("",`Voc√™ disse: "${a}"`,"processing"),setTimeout(()=>{this.isProcessingCommand||this.processCommand(a,t)},200)):this.updateModalStatus("",`Ouvindo: "${a}..."`,"listening")}handleRecognitionError(e){console.error("üé§ Erro no reconhecimento:",e),this.isListening=!1,this.isStarting=!1;const o=this.getErrorMessage(e.error);if(this.hasError=!0,setTimeout(()=>{this.hasError=!1},5e3),e.error==="no-speech"){console.log("‚ö†Ô∏è Nenhuma fala detectada"),this.hasReceivedSpeech?(console.log("‚ÑπÔ∏è J√° havia recebido fala, aguardando mais tempo..."),setTimeout(()=>{this.isModalOpen&&!this.isListening&&!this.isStarting&&!this.isProcessingCommand&&(this.hasError=!1,this.startListening(this.currentType))},2e3)):(console.log("‚ÑπÔ∏è Nenhuma fala detectada ainda, reiniciando rapidamente..."),setTimeout(()=>{this.isModalOpen&&!this.isListening&&!this.isStarting&&!this.isProcessingCommand&&(this.hasError=!1,this.startListening(this.currentType))},500));return}this.updateModalStatus("",o,"error"),this.shouldRetry(e.error)&&this.retryCount<this.maxRetries?(this.retryCount++,console.log(`üîÑ Tentativa ${this.retryCount} de ${this.maxRetries}`),setTimeout(()=>{this.isModalOpen&&(this.hasError=!1,this.startListening(this.currentType))},2e3)):setTimeout(()=>{this.closeModal()},3e3)}handleRecognitionEnd(){console.log("üé§ Reconhecimento finalizado"),this.isListening=!1,this.isStarting=!1;const e=this.hasReceivedSpeech&&!this.isProcessingCommand?1e3:500;this.isModalOpen&&!this.isListening&&!this.hasError&&!this.isProcessingCommand?(console.log(`üîÑ Reiniciando reconhecimento em ${e}ms...`),setTimeout(()=>{this.isModalOpen&&!this.isListening&&!this.isStarting&&!this.isProcessingCommand?(console.log("üîÑ Executando reinicializa√ß√£o..."),this.startListening(this.currentType)):console.log("üö´ Cancelando reinicializa√ß√£o - condi√ß√µes n√£o atendidas")},e)):console.log("üö´ N√£o reiniciando - condi√ß√µes n√£o atendidas:",{isModalOpen:this.isModalOpen,isListening:this.isListening,hasError:this.hasError,isProcessingCommand:this.isProcessingCommand})}async processCommand(e,o){try{this.isProcessingCommand=!0,console.log("üé§ Processando comando:",e);const a=this.normalizeText(e);console.log("üé§ Texto normalizado:",a);const t=this.determineCommandType(a);console.log("üé§ Tipo de comando:",t),this.recognition&&this.isListening&&setTimeout(()=>{this.recognition&&this.isListening&&this.recognition.stop()},100);const n=await this.executeCommand(a,t);this.showSuccess(n),setTimeout(()=>{this.closeModal()},2e3)}catch(a){console.error("‚ùå Erro ao processar comando:",a),this.showError(`Erro ao processar comando: ${a.message}`),setTimeout(()=>{this.closeModal()},3e3)}finally{this.isProcessingCommand=!1}}normalizeText(e){return e.toLowerCase().normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"").trim()}determineCommandType(e){if(console.log("üîç Determinando tipo de comando para:",e),/\b(saldo|qual.*saldo|saldo atual|quanto.*tenho|meu saldo)\b/.test(e))return console.log("‚úÖ Comando de consulta detectado"),"query";if(/\b(ir para|va para|mostrar|abrir|navegar).*(dashboard|transacoes|categorias|recorrentes)\b/.test(e))return console.log("‚úÖ Comando de navega√ß√£o detectado"),"navigation";if(/\b(adicionar|nova|criar|inserir).*(categoria)\b/.test(e)||/\b(categoria).*(nova|adicionar|criar)\b/.test(e))return console.log("‚úÖ Comando de categoria detectado (expl√≠cito)"),"category";const o=this.extractCommandItems(e);return console.log("üîç Itens extra√≠dos do comando:",o),o.length===3?(console.log("‚úÖ 3 itens detectados ‚Üí Comando de CATEGORIA"),"category"):o.length===4?(console.log("‚úÖ 4 itens detectados ‚Üí Comando de TRANSA√á√ÉO"),"transaction"):/\b(adicionar|nova|criar|inserir|registrar|lancamento|lancar).*(despesa|receita|transacao|gasto|entrada|compra|pagamento)\b/.test(e)||/\b(despesa|receita|gasto|entrada|compra|pagamento).*(de|por|valor|no valor)\b/.test(e)||/\b(gastei|paguei|comprei|recebi|ganhei)\b/.test(e)||/\b(pagar|gastar|comprar|receber|ganhar)\b/.test(e)||/\b\d+.*(?:reais?|real|r\$)\b/.test(e)||/\b(?:cem|mil|duzentos|trezentos|quatrocentos|quinhentos|seiscentos|setecentos|oitocentos|novecentos).*(?:reais?|real|r\$)?\b/.test(e)?(console.log("‚úÖ Comando de transa√ß√£o detectado (padr√£o tradicional)"),"transaction"):/\b\d+\b/.test(e)&&/\b(reais?|real|r\$|dinheiro|valor)\b/.test(e)?(console.log("‚úÖ Comando de transa√ß√£o detectado (padr√£o num√©rico)"),"transaction"):/\b(cem|mil|duzentos|trezentos|quatrocentos|quinhentos|seiscentos|setecentos|oitocentos|novecentos|vinte|trinta|quarenta|cinquenta|sessenta|setenta|oitenta|noventa)\b/.test(e)?(console.log("‚úÖ Comando de transa√ß√£o detectado (n√∫mero por extenso)"),"transaction"):(console.log("‚ö†Ô∏è Usando tipo padr√£o:",this.currentType||"transaction"),this.currentType||"transaction")}extractCommandItems(e){console.log("üîç Extraindo itens do comando:",e);const o=e.toLowerCase().normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"").trim(),a=["adicionar","nova","novo","criar","inserir","registrar","lancamento","lancar","de","da","do","na","no","em","para","por","com","valor","reais","real","r$","dinheiro","categoria","transacao","e","a","o","as","os"],t=o.split(/\s+/).filter(s=>s.length>1).filter(s=>!a.includes(s));console.log("üîç Palavras filtradas:",t);const n=[];for(const s of t){if(/^\d+([.,]\d+)?$/.test(s)){n.push({type:"valor",value:s});continue}if(/^(despesa|receita|gasto|entrada)s?$/.test(s)){n.push({type:"tipo",value:s});continue}let r=!1;if(window.appState?.categories){for(const d of window.appState.categories)if(d.nome.toLowerCase().includes(s)||s.includes(d.nome.toLowerCase())){n.push({type:"categoria",value:s}),r=!0;break}}!r&&s.length>2&&n.push({type:"descricao",value:s})}return console.log("üîç Itens identificados:",n),n}async executeCommand(e,o){switch(console.log("üé§ Executando comando:",o,e),o){case"query":return await this.handleQueryCommand(e);case"transaction":return await this.handleTransactionCommand(e);case"category":return await this.handleCategoryCommand(e);case"navigation":return await this.handleNavigationCommand(e);default:throw new Error("Tipo de comando n√£o reconhecido")}}async handleQueryCommand(e){return console.log("üîç Processando comando de consulta:",e),/\b(saldo|qual.*saldo|saldo atual)\b/.test(e)?`Saldo atual: R$ ${this.calculateBalance().toFixed(2)}`:/\b(despesas|gastos)\b/.test(e)?`Total de despesas: R$ ${this.calculateExpenses().toFixed(2)}`:/\b(receitas|entradas)\b/.test(e)?`Total de receitas: R$ ${this.calculateIncome().toFixed(2)}`:"Comando de consulta n√£o reconhecido"}async handleTransactionCommand(e){console.log("üí∞ Processando comando de transa√ß√£o:",e);const o=this.parseTransactionCommand(e);if(!o)throw new Error("N√£o foi poss√≠vel entender os dados da transa√ß√£o");const a=o.categoriaExistente?`categoria existente "${o.categoria}"`:`nova categoria "${o.categoria}"`;if(window.showAddTransactionModal){const t={descricao:o.descricao,valor:o.valor,tipo:o.tipo,categoriaId:o.categoriaId,data:new Date().toISOString().split("T")[0]};console.log("üé§ Abrindo modal de transa√ß√£o com dados:",t),window.showAddTransactionModal(t);const n=o.valor!==null?`de R$ ${o.valor.toFixed(2)}`:"(valor a definir)";return`‚úÖ Modal aberto com: ${o.tipo} ${n} na ${a}. Voc√™ pode editar e salvar.`}else{if(window.addTransactionWithConfirmation)return await window.addTransactionWithConfirmation(o),`‚úÖ Transa√ß√£o confirmada: ${o.tipo} de R$ ${o.valor.toFixed(2)} na ${a}`;if(window.addTransaction)return await window.addTransaction(o),`‚úÖ Transa√ß√£o adicionada: ${o.tipo} de R$ ${o.valor.toFixed(2)} na ${a}`;throw new Error("Fun√ß√£o de adicionar transa√ß√£o n√£o dispon√≠vel")}}async handleCategoryCommand(e){console.log("üìÇ Processando comando de categoria:",e);const o=this.parseCategoryCommand(e);if(!o||!o.nome)throw new Error("Nome da categoria n√£o foi entendido");if(window.showAddCategoryModal){const a={nome:o.nome,tipo:o.tipo,limite:o.limite||0};console.log("üé§ Abrindo modal de categoria com dados:",a),window.showAddCategoryModal(a);const t=o.limite>0?` com limite de R$ ${o.limite.toFixed(2)}`:"";return`‚úÖ Modal aberto com: categoria "${o.nome}" (${o.tipo})${t}. Voc√™ pode editar e salvar.`}else if(window.addCategory){await window.addCategory(o);const a=o.limite>0?` com limite de R$ ${o.limite.toFixed(2)}`:"";return`‚úÖ Categoria "${o.nome}" (${o.tipo})${a} adicionada com sucesso`}else throw new Error("Fun√ß√£o de adicionar categoria n√£o dispon√≠vel")}async handleNavigationCommand(e){return console.log("üß≠ Processando comando de navega√ß√£o:",e),/\b(dashboard|in√≠cio|principal)\b/.test(e)?(window.location.hash="#/dashboard","Navegando para o Dashboard"):/\b(transa√ß√µes|transa√ß√£o)\b/.test(e)?(window.location.hash="#/transactions","Navegando para Transa√ß√µes"):/\b(categorias|categoria)\b/.test(e)?(window.location.hash="#/categories","Navegando para Categorias"):/\b(recorrentes|recorrente)\b/.test(e)?(window.location.hash="#/recorrentes","Navegando para Recorrentes"):"Comando de navega√ß√£o n√£o reconhecido"}parseTransactionCommand(e){console.log("üîç Analisando comando de transa√ß√£o:",e);const o={tipo:{receita:/\b(receita|receitas|entrada|entradas|ganhei|recebi|salario|ganhar|receber|renda|rendas|ganho|ganhos)\b/i},valor:[/(?:de|por|valor|custou|custa|custando|no valor de|foi de)\s*(\d+(?:[.,]\d{1,2})?)\s*(?:reais?|r\$|real|dinheiro)?/i,/(\d+(?:[.,]\d{1,2})?)\s*(?:reais?|r\$|real|dinheiro)/i,/\b(zero|uma?|dois|duas|tres|quatro|cinco|seis|sete|oito|nove|dez|onze|doze|treze|quatorze|catorze|quinze|dezesseis|dezessete|dezoito|dezenove|vinte|trinta|quarenta|cinquenta|sessenta|setenta|oitenta|noventa|cem|cento|duzentos|trezentos|quatrocentos|quinhentos|seiscentos|setecentos|oitocentos|novecentos|mil)\s*(?:reais?|r\$|real|dinheiro)?\b/i,/\b(\d+(?:[.,]\d{1,2})?)\b/],categoria:[/\b(?:categoria|para|em|de|na categoria|tipo)\s+([a-z√°√†√¢√£√©√®√™√≠√¨√Æ√≥√≤√¥√µ√∫√π√ª√ß\s]+?)(?:\s*$|\s+(?:de|por|valor|reais?|r\$|custou|custa)\s*\d)/i,/\b(?:com|para|em|de)\s+([a-z√°√†√¢√£√©√®√™√≠√¨√Æ√≥√≤√¥√µ√∫√π√ª√ß\s]+?)(?:\s*$|\s+(?:de|por|valor|reais?|r\$|custou|custa))/i,/([a-z√°√†√¢√£√©√®√™√≠√¨√Æ√≥√≤√¥√µ√∫√π√ª√ß]+)\s*$/]};let a="despesa";o.tipo.receita.test(e)&&(a="receita");let t=null,n=null;console.log("üîç Tentando extrair valor do texto:",e);const s={zero:0,um:1,uma:1,dois:2,duas:2,tr√™s:3,tres:3,quatro:4,cinco:5,seis:6,sete:7,oito:8,nove:9,dez:10,onze:11,doze:12,treze:13,quatorze:14,catorze:14,quinze:15,dezesseis:16,dezessete:17,dezoito:18,dezenove:19,vinte:20,trinta:30,quarenta:40,cinquenta:50,sessenta:60,setenta:70,oitenta:80,noventa:90,cem:100,cento:100,duzentos:200,trezentos:300,quatrocentos:400,quinhentos:500,seiscentos:600,setecentos:700,oitocentos:800,novecentos:900,mil:1e3};for(let c=0;c<o.valor.length;c++){const m=o.valor[c];if(console.log(`üîç Testando padr√£o ${c+1}:`,m),n=e.match(m),n){console.log("‚úÖ Match encontrado:",n);const g=n[1];if(console.log("üìù Valor capturado:",g),s[g.toLowerCase()]?(t=s[g.toLowerCase()],console.log("üî¢ N√∫mero por extenso convertido:",t)):(t=parseFloat(g.replace(",",".")),console.log("üî¢ N√∫mero convertido:",t)),t&&t>0){console.log("‚úÖ Valor v√°lido encontrado:",t);break}else console.log("‚ùå Valor inv√°lido, continuando busca..."),t=null,n=null}else console.log("‚ùå Nenhum match para este padr√£o")}if(!t){const c={zero:0,um:1,uma:1,dois:2,duas:2,tr√™s:3,tres:3,quatro:4,cinco:5,seis:6,sete:7,oito:8,nove:9,dez:10,onze:11,doze:12,treze:13,quatorze:14,catorze:14,quinze:15,dezesseis:16,dezessete:17,dezoito:18,dezenove:19,vinte:20,trinta:30,quarenta:40,cinquenta:50,sessenta:60,setenta:70,oitenta:80,noventa:90,cem:100,cento:100,duzentos:200,trezentos:300,quatrocentos:400,quinhentos:500,seiscentos:600,setecentos:700,oitocentos:800,novecentos:900,mil:1e3},m=/\b(zero|uma?|dois|duas|tr√™s|tres|quatro|cinco|seis|sete|oito|nove|dez|onze|doze|treze|quatorze|catorze|quinze|dezesseis|dezessete|dezoito|dezenove|vinte|trinta|quarenta|cinquenta|sessenta|setenta|oitenta|noventa|cem|cento|duzentos|trezentos|quatrocentos|quinhentos|seiscentos|setecentos|oitocentos|novecentos|mil)\b/i,g=e.match(m);if(g){const p=g[1].toLowerCase();c[p]&&(t=c[p])}if(!t){const p=e.split(" ");for(const b of p)if(c[b.toLowerCase()]){t=c[b.toLowerCase()];break}}}t||(console.log("‚ö†Ô∏è Valor n√£o encontrado, ser√° preenchido manualmente no modal"),t=null);let r="Outros",d=null,i=null;if(window.appState?.categories){console.log("üîç Procurando categorias existentes no texto:",e);for(const c of window.appState.categories){const m=c.nome.toLowerCase(),g=e.toLowerCase();if(g.includes(m)){i=c,r=c.nome,console.log("‚úÖ Categoria encontrada (exata):",r);break}const p=m.split(" "),b=g.split(" ");let C=0;for(const E of p)E.length>2&&b.some(y=>y.includes(E)||E.includes(y))&&C++;if(C>0&&C>=p.length*.5){i=c,r=c.nome,console.log("‚úÖ Categoria encontrada (parcial):",r,`(${C}/${p.length} palavras)`);break}}}if(!i){for(const c of o.categoria)if(d=e.match(c),d&&d[1]){let m=d[1].trim();if(m=m.replace(/\b(de|por|valor|reais?|r\$|real|dinheiro|custou|custa)\b/gi,"").trim(),m.length>2){r=m,console.log("üìù Categoria extra√≠da do texto:",r);break}}}console.log("üîç Texto original para descri√ß√£o:",e);const w=e.toLowerCase().split(" "),u=["adicionar","nova","criar","inserir","despesa","receita","transa√ß√£o","gasto","entrada","gastei","comprei","paguei","com","para","em","de","categoria","na","da","tipo","reais","real","dinheiro","valor","custou","custa","custando"];let h=null;for(const c of w)if(!/^\d+([.,]\d+)?$/.test(c)&&!u.includes(c)&&!(i&&c===i.nome.toLowerCase())&&c.length>=2){h=c;break}console.log("üîç Primeira palavra significativa encontrada:",h);let l;if(h)l=h.charAt(0).toUpperCase()+h.slice(1),console.log("üîç Descri√ß√£o definida como primeira palavra significativa:",l);else{if(l=e,n&&(console.log("üîç Removendo valor encontrado:",n[0]),l=l.replace(n[0],"")),d&&(console.log("üîç Removendo categoria extra√≠da:",d[0]),l=l.replace(d[0],"")),i){const c=i.nome.toLowerCase(),m=new RegExp(`\\b${c.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\b`,"gi");console.log("üîç Removendo categoria do sistema:",c),l=l.replace(m,"")}l=l.replace(/\b(adicionar|nova?|criar|inserir|transa√ß√£o|gasto|entrada|gastei|comprei|paguei)\b/gi,"").replace(/\b(com|para|em|de|categoria|na categoria|da categoria|tipo)\b/gi,"").replace(/\b(reais?|r\$|real|dinheiro|valor|custou|custa|custando)\b/gi,"").replace(/\b(despesa|receita)\b(?=.*\w)/gi,"").replace(/\s+/g," ").trim(),console.log("üîç Descri√ß√£o ap√≥s limpeza (fallback):",l),(!l||l.length<3)&&(t!==null?l=`${a.charAt(0).toUpperCase()+a.slice(1)} de R$ ${t.toFixed(2)}`:l=`${a.charAt(0).toUpperCase()+a.slice(1)}`,console.log("üîç Usando descri√ß√£o padr√£o (fallback final):",l))}return{tipo:a,valor:t,categoria:r,categoriaId:i?.id||null,categoriaExistente:!!i,descricao:l,data:new Date().toISOString()}}parseCategoryCommand(e){console.log("üîç Analisando comando de categoria:",e);const o=this.extractCommandItems(e);return o.length===3?(console.log("üîç Processando comando de categoria com 3 itens"),this.parseCategoryCommandFromItems(o,e)):this.parseCategoryCommandTraditional(e)}parseCategoryCommandFromItems(e,o){console.log("üîç Analisando comando de categoria com 3 itens:",e);let a=null,t="despesa",n=0;for(const s of e)switch(s.type){case"valor":n=parseFloat(s.value.replace(",",".")),console.log("üí∞ Limite extra√≠do:",n);break;case"tipo":/^(receita|entrada)s?$/.test(s.value)?t="receita":t="despesa",console.log("üìä Tipo extra√≠do:",t);break;case"descricao":a||(a=s.value.charAt(0).toUpperCase()+s.value.slice(1),console.log("üìù Nome da categoria extra√≠do:",a));break}if(!a){const s=o.toLowerCase().split(" "),r=["adicionar","nova","novo","criar","inserir","categoria","despesa","receita","de","da","do","na","no","em","para","por","com","valor","reais","real","r$","dinheiro"];for(const d of s)if(d.length>2&&!r.includes(d)&&!/^\d+([.,]\d+)?$/.test(d)){a=d.charAt(0).toUpperCase()+d.slice(1),console.log("üìù Nome da categoria extra√≠do (fallback):",a);break}}if(!a)throw new Error("Nome da categoria n√£o foi entendido no comando de 3 itens");return console.log("‚úÖ Categoria processada:",{nome:a,tipo:t,limite:n}),{nome:a,tipo:t,limite:n||0,cor:this.getRandomColor()}}parseCategoryCommandTraditional(e){console.log("üîç Analisando comando de categoria (m√©todo tradicional):",e);const o={nome:[/\b(?:categoria|categoria)\s+(?:chamada|de|para|com nome)\s+([a-z√°√†√¢√£√©√®√™√≠√¨√Æ√≥√≤√¥√µ√∫√π√ª√ß\s]+?)(?:\s+(?:tipo|despesa|receita|limite)\b|\s*$)/i,/\b(?:nova|criar|adicionar)\s+(?:categoria|categoria)\s+(?:chamada|de|para|com nome)?\s*([a-z√°√†√¢√£√©√®√™√≠√¨√Æ√≥√≤√¥√µ√∫√π√ª√ß\s]+?)(?:\s+(?:tipo|despesa|receita|limite)\b|\s*$)/i,/\b(?:categoria|categoria)\s+([a-z√°√†√¢√£√©√®√™√≠√¨√Æ√≥√≤√¥√µ√∫√π√ª√ß\s]+?)(?:\s+(?:tipo|despesa|receita|limite)\b|\s*$)/i,/\b([a-z√°√†√¢√£√©√®√™√≠√¨√Æ√≥√≤√¥√µ√∫√π√ª√ß\s]+?)\s+(?:categoria|despesa|receita)\b/i],tipo:{receita:/\b(receita|receitas|entrada|entradas|renda|rendas)\b/i},limite:[/\blimite\s+(?:de\s+)?(\d+(?:[.,]\d{1,2})?)/i,/(\d+(?:[.,]\d{1,2})?)\s*(?:reais?|r\$|real|dinheiro)/i,/(\d+(?:[.,]\d{1,2})?)/]};let a=null;for(const s of o.nome){const r=e.match(s);if(r&&r[1]&&(a=r[1].trim(),a=a.replace(/\b(nova?|criar|adicionar|categoria|tipo|despesa|receita|limite|de|por|valor|reais?|r\$|real|dinheiro)\b/gi,"").trim(),a.length>2))break}if(!a)throw new Error('Nome da categoria n√£o foi entendido. Diga algo como "nova categoria chamada transporte"');let t="despesa";o.tipo.receita.test(e)&&(t="receita");let n=0;for(const s of o.limite){const r=e.match(s);if(r){n=parseFloat(r[1].replace(",","."));break}}if(!n){const s={zero:0,um:1,uma:1,dois:2,duas:2,tr√™s:3,tres:3,quatro:4,cinco:5,seis:6,sete:7,oito:8,nove:9,dez:10,onze:11,doze:12,treze:13,quatorze:14,catorze:14,quinze:15,dezesseis:16,dezessete:17,dezoito:18,dezenove:19,vinte:20,trinta:30,quarenta:40,cinquenta:50,sessenta:60,setenta:70,oitenta:80,noventa:90,cem:100,cento:100,duzentos:200,trezentos:300,quatrocentos:400,quinhentos:500,seiscentos:600,setecentos:700,oitocentos:800,novecentos:900,mil:1e3},r=/\b(zero|uma?|dois|duas|tr√™s|tres|quatro|cinco|seis|sete|oito|nove|dez|onze|doze|treze|quatorze|catorze|quinze|dezesseis|dezessete|dezoito|dezenove|vinte|trinta|quarenta|cinquenta|sessenta|setenta|oitenta|noventa|cem|cento|duzentos|trezentos|quatrocentos|quinhentos|seiscentos|setecentos|oitocentos|novecentos|mil)\b/i,d=e.match(r);if(d){const i=d[1].toLowerCase();s[i]&&(n=s[i])}if(!n){const i=e.split(" ");for(const w of i)if(s[w.toLowerCase()]){n=s[w.toLowerCase()];break}}}return{nome:a,tipo:t,limite:n||0,cor:this.getRandomColor()}}getRandomColor(){const e=["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FFEAA7","#DDA0DD","#98D8C8","#F7DC6F","#BB8FCE","#85C1E9","#F8C471","#82E0AA","#F1948A","#85C1E9","#D7BDE2"];return e[Math.floor(Math.random()*e.length)]}calculateBalance(){if(!window.appState?.transactions)return 0;const e=window.appState.transactions.filter(a=>a.tipo==="receita").reduce((a,t)=>a+parseFloat(t.valor),0),o=window.appState.transactions.filter(a=>a.tipo==="despesa").reduce((a,t)=>a+parseFloat(t.valor),0);return e-o}calculateExpenses(){return window.appState?.transactions?window.appState.transactions.filter(e=>e.tipo==="despesa").reduce((e,o)=>e+parseFloat(o.valor),0):0}calculateIncome(){return window.appState?.transactions?window.appState.transactions.filter(e=>e.tipo==="receita").reduce((e,o)=>e+parseFloat(o.valor),0):0}getErrorMessage(e){return{"not-allowed":"Permiss√£o do microfone negada. Clique no √≠cone do microfone na barra de endere√ßos e permita o acesso.","no-speech":"Nenhuma fala detectada. Tente falar mais alto ou mais pr√≥ximo do microfone.","audio-capture":"Erro ao capturar √°udio. Verifique se o microfone est√° funcionando.",network:"Erro de rede. Verifique sua conex√£o com a internet.","service-not-allowed":"Servi√ßo de reconhecimento de voz n√£o permitido.","not-supported":"Reconhecimento de voz n√£o suportado neste navegador.",aborted:"Reconhecimento de voz interrompido.","audio-capture-device-not-found":"Microfone n√£o encontrado.","audio-capture-device-in-use":"Microfone em uso por outro aplicativo."}[e]||`Erro desconhecido: ${e}`}shouldRetry(e){return["network","service-not-allowed","audio-capture-device-in-use"].includes(e)}getRandomColor(){const e=["#3B82F6","#8B5CF6","#10B981","#F59E0B","#EF4444","#06B6D4"];return e[Math.floor(Math.random()*e.length)]}openModal(e="transaction"){console.log("üé§ Abrindo modal de voz:",e),this.currentType=e,this.isModalOpen=!0,this.retryCount=0;const o=document.getElementById("voice-modal"),a=o?.querySelector(".voice-content");o&&a?(o.style.display="flex",o.style.pointerEvents="auto",o.style.background="rgba(0, 0, 0, 0.95)",o.style.backdropFilter="blur(30px)",a.style.transform="scale(1)",a.style.opacity="1",document.body.classList.add("voice-modal-open"),setTimeout(()=>{this.startListening(e)},500),console.log("‚úÖ Modal de voz aberto")):console.error("‚ùå Modal de voz n√£o encontrado")}closeModal(){if(!this.isModalOpen)return;console.log("üé§ Fechando modal de voz"),this.isModalOpen=!1,this.isListening=!1,this.isStarting=!1,this.hasError=!1,this.isProcessingCommand=!1,this.retryCount=0;const e=document.getElementById("voice-modal"),o=e?.querySelector(".voice-content");if(e&&o){if(this.recognition)try{this.recognition.stop(),console.log("üõë Reconhecimento parado")}catch{console.log("‚ÑπÔ∏è Reconhecimento j√° estava parado")}o.style.transform="scale(0.95)",o.style.opacity="0",e.style.background="rgba(0, 0, 0, 0)",e.style.backdropFilter="blur(0px)",document.body.classList.remove("voice-modal-open"),setTimeout(()=>{e.style.pointerEvents="none",e.style.display="none",console.log("‚úÖ Modal de voz fechado")},300)}}updateModalStatus(e,o,a){const t=document.getElementById("voice-modal");if(!t)return;const n=t.querySelector("h3"),s=t.querySelector("p"),r=t.querySelector(".voice-icon div"),d=t.querySelector(".voice-status"),i=d?.querySelector("p");if(n)switch(a){case"listening":n.textContent="üé§ Estou te ouvindo!";break;case"processing":n.textContent="üß† Processando...";break;case"error":n.textContent="‚ùå Ops! Algo deu errado";break;case"success":n.textContent="‚úÖ Perfeito!";break;default:n.textContent=e||"üé§ Estou te ouvindo!"}if(s)switch(a){case"listening":s.textContent="Fale naturalmente como voc√™ gastou ou recebeu dinheiro";break;case"processing":s.textContent="Entendendo o que voc√™ disse...";break;case"error":s.textContent=o||"Tente falar novamente de forma mais clara";break;case"success":s.textContent=o||"Transa√ß√£o adicionada com sucesso!";break;default:s.textContent=o||"Fale naturalmente como voc√™ gastou ou recebeu dinheiro"}if(r)switch(r.className="w-16 h-16 rounded-full flex items-center justify-center mx-auto shadow-lg",a){case"listening":r.classList.add("bg-gradient-to-r","from-green-400","to-blue-500","animate-pulse");break;case"processing":r.classList.add("bg-gradient-to-r","from-yellow-400","to-orange-500","animate-spin");break;case"error":r.classList.add("bg-gradient-to-r","from-red-400","to-pink-500");break;case"success":r.classList.add("bg-gradient-to-r","from-green-400","to-emerald-500");break;default:r.classList.add("bg-gradient-to-r","from-green-400","to-blue-500","animate-pulse")}if(d&&(d.querySelectorAll("div").forEach((u,h)=>{switch(u.classList.remove("animate-bounce","animate-pulse","bg-green-500","bg-blue-500","bg-yellow-500","bg-red-500"),a){case"listening":u.classList.add("animate-bounce","bg-green-500"),u.style.animationDelay=`${h*.1}s`;break;case"processing":u.classList.add("animate-pulse","bg-yellow-500"),u.style.animationDelay=`${h*.2}s`;break;case"error":u.classList.add("bg-red-500"),u.style.animationDelay="";break;case"success":u.classList.add("bg-green-500"),u.style.animationDelay="";break;default:u.classList.add("animate-bounce","bg-green-500"),u.style.animationDelay=`${h*.1}s`}}),i))switch(a){case"listening":i.textContent="Microfone ativo",i.className="text-xs text-green-600 dark:text-green-400 font-medium";break;case"processing":i.textContent="Processando comando...",i.className="text-xs text-yellow-600 dark:text-yellow-400 font-medium";break;case"error":i.textContent="Erro no reconhecimento",i.className="text-xs text-red-600 dark:text-red-400 font-medium";break;case"success":i.textContent="Comando executado!",i.className="text-xs text-green-600 dark:text-green-400 font-medium";break;default:i.textContent="Microfone ativo",i.className="text-xs text-green-600 dark:text-green-400 font-medium"}}async startListening(e="transaction"){console.log("üé§ Iniciando reconhecimento de voz...",{type:e,isListening:this.isListening});try{if(!this.recognition)throw console.error("‚ùå Reconhecimento n√£o configurado"),new Error("Reconhecimento n√£o configurado");if(this.isListening)return console.log("‚ö†Ô∏è Reconhecimento j√° est√° ativo, ignorando nova tentativa"),!0;if(this.currentType=e,console.log("‚úÖ Tipo de comando definido:",this.currentType),this.updateModalStatus("","Iniciando...","processing"),!this.microphonePermissionChecked){if(console.log("üîç Verifica√ß√£o r√°pida de permiss√£o..."),!await this.quickPermissionCheck())return console.log("‚ùå Permiss√£o do microfone negada"),!1;this.microphonePermissionChecked=!0}try{this.recognition.stop(),console.log("üõë Parando reconhecimento anterior (sem delay)...")}catch{console.log("‚ÑπÔ∏è Nenhum reconhecimento anterior para parar")}return this.isStarting=!0,console.log("üöÄ Iniciando reconhecimento IMEDIATAMENTE..."),this.recognition.start(),console.log("‚úÖ Reconhecimento iniciado com sucesso"),setTimeout(()=>{this.isStarting=!1},500),!0}catch(o){console.error("‚ùå Erro ao iniciar reconhecimento:",o),this.isStarting=!1;let a="Erro ao iniciar reconhecimento de voz";if(o.name==="InvalidStateError"){if(console.log("üîÑ Reconhecimento j√° ativo, aguardando..."),await new Promise(t=>setTimeout(t,1e3)),!this.isListening&&!this.isStarting)return console.log("üîÑ Tentando novamente ap√≥s aguardar..."),this.startListening(e);a="Sistema de voz ocupado. Tente novamente em alguns segundos."}else o.name==="NotSupportedError"?a="Reconhecimento de voz n√£o suportado neste navegador. Use Chrome ou Edge.":o.name==="NetworkError"&&(a="Erro de conex√£o. Verifique sua internet e tente novamente.");return this.showError(a),!1}}async quickPermissionCheck(){console.log("‚ö° Verifica√ß√£o r√°pida de permiss√£o...");try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return console.warn("‚ö†Ô∏è API getUserMedia n√£o dispon√≠vel"),this.showError("Navegador n√£o suporta acesso ao microfone. Use Chrome, Edge ou Firefox."),!1;if(navigator.permissions)try{const a=await navigator.permissions.query({name:"microphone"});if(console.log("üîç Status da permiss√£o:",a.state),a.state==="granted")return console.log("‚úÖ Permiss√£o j√° concedida"),!0;if(a.state==="denied")return console.log("‚ùå Permiss√£o negada"),this.showError("Permiss√£o do microfone negada. Permita o acesso ao microfone nas configura√ß√µes do navegador."),!1}catch{console.log("‚ÑπÔ∏è API de permiss√µes n√£o dispon√≠vel, usando m√©todo alternativo")}const e=new Promise((a,t)=>setTimeout(()=>t(new Error("Timeout")),1e3)),o=navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});try{return(await Promise.race([o,e])).getTracks().forEach(t=>t.stop()),console.log("‚úÖ Permiss√£o do microfone concedida (verifica√ß√£o r√°pida)"),!0}catch(a){if(a.message==="Timeout")return console.log("‚ö†Ô∏è Timeout na verifica√ß√£o, assumindo permiss√£o OK"),!0;throw a}}catch(e){return console.warn("‚ö†Ô∏è Erro na verifica√ß√£o r√°pida:",e.name),e.name==="NotAllowedError"?(this.showError("Permiss√£o do microfone negada. Permita o acesso ao microfone nas configura√ß√µes do navegador."),!1):e.name==="NotFoundError"?(this.showError("Nenhum microfone encontrado. Verifique se h√° um microfone conectado."),!1):(console.log("‚ÑπÔ∏è Assumindo permiss√£o OK para n√£o bloquear o sistema"),!0)}}async requestMicrophonePermission(){console.log("üé§ Solicitando permiss√£o do microfone...");try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return console.warn("‚ö†Ô∏è API getUserMedia n√£o dispon√≠vel"),!1;try{return(await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}})).getTracks().forEach(o=>o.stop()),console.log("‚úÖ Permiss√£o do microfone concedida"),!0}catch(e){console.warn("‚ö†Ô∏è Erro de permiss√£o:",e.name);try{const o=await navigator.mediaDevices.enumerateDevices(),a=o.filter(t=>t.kind==="audioinput");return console.log("üîç Dispositivos encontrados:",o.length),console.log("üé§ Dispositivos de √°udio:",a.length),a.length===0?(console.warn("‚ö†Ô∏è Nenhum dispositivo de √°udio encontrado"),this.showError("Nenhum microfone encontrado. Verifique se h√° um microfone conectado."),!1):(console.log("‚úÖ Dispositivos de √°udio dispon√≠veis:",a.map(t=>t.label||"Microfone")),this.showError("Permiss√£o do microfone negada. Permita o acesso ao microfone nas configura√ß√µes do navegador."),!1)}catch(o){return console.error("‚ùå Erro ao enumerar dispositivos:",o),this.showError("Erro ao verificar dispositivos de √°udio. Tente recarregar a p√°gina."),!1}}}catch(e){console.error("‚ùå Erro ao solicitar permiss√£o:",e);let o="Erro ao acessar microfone";return e.name==="NotFoundError"?o="Nenhum microfone encontrado. Verifique se h√° um microfone conectado.":e.name==="NotAllowedError"?o="Permiss√£o do microfone negada. Permita o acesso ao microfone nas configura√ß√µes do navegador.":e.name==="NotReadableError"?o="Microfone em uso por outro aplicativo. Feche outros aplicativos que possam estar usando o microfone.":e.name==="OverconstrainedError"?o="Configura√ß√£o de microfone n√£o suportada. Tente usar outro navegador.":e.name==="TypeError"&&(o="Navegador n√£o suporta acesso ao microfone. Use Chrome, Edge ou Firefox."),this.showError(o),!1}}showSuccess(e){console.log("‚úÖ Sucesso:",e),this.updateModalStatus("",e,"success"),window.Snackbar&&typeof window.Snackbar.success=="function"?window.Snackbar.success(e):window.Snackbar&&typeof window.Snackbar.show=="function"?window.Snackbar.show(e,"success"):window.Snackbar&&typeof window.Snackbar=="function"?window.Snackbar({message:e,type:"success"}):window.alert&&alert(`‚úÖ ${e}`)}showError(e){console.error("‚ùå Erro:",e),this.updateModalStatus("",e,"error"),window.Snackbar&&typeof window.Snackbar.error=="function"?window.Snackbar.error(e):window.Snackbar&&typeof window.Snackbar.show=="function"?window.Snackbar.show(e,"error"):window.Snackbar&&typeof window.Snackbar=="function"?window.Snackbar({message:e,type:"error"}):window.alert?alert(`‚ùå ${e}`):console.error("Nenhum sistema de notifica√ß√£o dispon√≠vel")}setupGlobalEvents(){this.removeGlobalEvents(),this.escapeHandler=o=>{o.key==="Escape"&&this.isModalOpen&&this.closeModal()},document.addEventListener("keydown",this.escapeHandler),this.outsideClickHandler=o=>{const a=document.getElementById("voice-modal");o.target===a&&this.isModalOpen&&this.closeModal()},document.addEventListener("click",this.outsideClickHandler);const e=document.getElementById("close-voice-modal");if(e){const o=e.cloneNode(!0);e.parentNode.replaceChild(o,e),this.closeBtnHandler=a=>{a.preventDefault(),a.stopPropagation(),console.log("‚ùå Close voice modal button clicked"),this.closeModal()},o.addEventListener("click",this.closeBtnHandler)}}removeGlobalEvents(){if(this.escapeHandler&&(document.removeEventListener("keydown",this.escapeHandler),this.escapeHandler=null),this.outsideClickHandler&&(document.removeEventListener("click",this.outsideClickHandler),this.outsideClickHandler=null),this.closeBtnHandler){const e=document.getElementById("close-voice-modal");e&&e.removeEventListener("click",this.closeBtnHandler),this.closeBtnHandler=null}}start(e="transaction"){console.log("üé§ VoiceSystem.start chamado:",e);try{return!this.recognition&&(console.log("üîÑ Inicializando VoiceSystem..."),!this.init())?(console.error("‚ùå Falha na inicializa√ß√£o do VoiceSystem"),!1):document.getElementById("voice-modal")?(this.currentType=e,console.log("‚úÖ Tipo de comando definido:",this.currentType),this.openModal(e),!0):(console.error("‚ùå Modal de voz n√£o encontrado no DOM"),this.showError("Interface de voz n√£o dispon√≠vel"),!1)}catch(o){return console.error("‚ùå Erro ao iniciar VoiceSystem:",o),this.showError(`Erro ao iniciar reconhecimento de voz: ${o.message}`),!1}}stop(){console.log("üé§ VoiceSystem.stop chamado"),this.closeModal()}destroy(){console.log("üé§ Destruindo VoiceSystem..."),this.recognition&&(this.recognition.stop(),this.recognition=null),this.removeGlobalEvents(),this.isModalOpen&&this.closeModal(),this.isListening=!1,this.isModalOpen=!1,this.retryCount=0,console.log("‚úÖ VoiceSystem destru√≠do")}}let f=null;window.openVoiceModal=function(v="transaction"){return console.log("üé§ openVoiceModal chamado:",v),f||(f=new z),f.start(v)};window.closeVoiceModal=function(){console.log("üé§ closeVoiceModal chamado"),f&&f.stop()};window.startVoiceRecognition=function(v="transaction"){return console.log("üé§ startVoiceRecognition chamado:",v),f||(f=new z),f.start(v)};export{z as VoiceSystem};

import e from"./networkHandler-Dd825SpE.js";import{a as t,d as s,b as i,c as n,u as r,e as a,f as c,g as o,q as u,h as l,s as h,i as d,o as y}from"./main-OjaIp7EQ.js";import"./vendor-7JQXQzuE.js";const m=new class{constructor(){this.db=null,this.auth=null,this.listeners=new Map,this.isInitialized=!1}async initialize(){try{this.auth=t,this.db=s,this.isInitialized=!0,this.setupReconnectionListeners()}catch(e){throw e}}setupReconnectionListeners(){window.eventBus&&window.eventBus.on("firebase:reconnect-listeners",()=>{this.reconnectAllListeners()})}async executeWithRetry(t,s="operação Firebase"){return e.canExecuteOperation()||await e.waitForConnection(),e.retryOperation(t,s)}async addDocument(e,t){return this.executeWithRetry(async()=>await i(n(this.db,e),t),`adicionar documento em ${e}`)}async updateDocument(e,t,s){return this.executeWithRetry(async()=>{await r(a(this.db,e,t),s)},`atualizar documento ${t}`)}async deleteDocument(e,t){return this.executeWithRetry(async()=>{await c(a(this.db,e,t))},`deletar documento ${t}`)}async getDocument(e,t){return this.executeWithRetry(async()=>{const s=await o(a(this.db,e,t));return s.exists()?{id:s.id,...s.data()}:null},`buscar documento ${t}`)}async getDocuments(e,t=null){return this.executeWithRetry(async()=>{let s=n(this.db,e),i=s;"function"==typeof t&&(i=t(s,u)||s);return(await l(i)).docs.map(e=>({id:e.id,...e.data()}))},`buscar documentos de ${e}`)}addResilientListener(e,t,s=null,i=null){const r=i||`${e}_${Date.now()}`,a=()=>{try{const i=n(this.db,e),a="function"==typeof s&&s(i,u)||i,c=y(a,e=>{const s=e.docs.map(e=>({id:e.id,...e.data()}));t(s,null)},i=>{t(null,i),setTimeout(()=>{this.listeners.has(r)&&(this.removeListener(r),this.addResilientListener(e,t,s,r))},5e3)});return this.listeners.set(r,{unsubscribe:c,collection:e,callback:t,queryFn:s,createdAt:new Date}),r}catch(i){setTimeout(()=>{a()},3e3)}};return a()}removeListener(e){const t=this.listeners.get(e);t&&(t.unsubscribe(),this.listeners.delete(e))}removeAllListeners(){this.listeners.forEach(e=>{e.unsubscribe()}),this.listeners.clear()}reconnectAllListeners(){const e=Array.from(this.listeners.entries());this.removeAllListeners(),e.forEach(([e,t])=>{setTimeout(()=>{this.addResilientListener(t.collection,t.callback,t.queryFn,e)},2e3*Math.random())})}async signInWithCredential(e){return this.executeWithRetry(async()=>await h(this.auth,e),"login com credencial")}async signOut(){return this.executeWithRetry(async()=>{await d(this.auth)},"logout")}checkFirebaseConnection(){if(!this.isInitialized)return!1;try{return void 0!==this.auth.currentUser&&null!==this.db}catch{return!1}}};window.ResilientFirebaseClient=m;export{m as default};

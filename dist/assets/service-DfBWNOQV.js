const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/NotificationService-zMQk2mrd.js","assets/main-BVWxnpqW.js","assets/main-DLXVHLmp.css"])))=>i.map(i=>d[i]);
import{q as x,h as N,f as R,a as h,j as E,u as B,d as _,c as U,n as L,k as q,p as C,r as $,_ as V}from"./main-BVWxnpqW.js";const F="recorrentes";async function O(e){const a=x(R(h,F),N("budgetId","==",e));return(await E(a)).docs.map(t=>({id:t.id,...t.data()}))}async function b(e){const a=x(R(h,F),N("userId","==",e));return(await E(a)).docs.map(t=>({id:t.id,...t.data()}))}function k(e){return U(R(h,F),e)}function z(e,a){return B(_(h,F,e),a)}function G(e){return L(_(h,F,e))}const S="logAplicacoes";async function H({userId:e,mesAno:a,transacaoId:n,transacaoData:t}){const r={userId:e,mesAno:a,recorrenteId:t.recorrenteId,descricao:t.descricao,valor:t.valor,dataAplicacao:q(),aplicacaoImediata:!1};n&&(r.transacaoId=n),await U(R(h,S),r)}async function J(e,a){const n=x(R(h,S),N("userId","==",e),N("dataAplicacao","<",a)),t=await E(n);let r=0;for(const o of t.docs)await L(_(h,S,o.id)),r++;return r}function y(e,a){let n=Number(e),t=Number(a);if(!Number.isFinite(n)||!Number.isFinite(t))return null;for(;t<1;)t+=12,n-=1;for(;t>12;)t-=12,n+=1;return{year:n,month:t}}function v(e,a=null,n=null){if(!e?.parcelasTotal||e.parcelasTotal<=1)return null;try{const t=new Date(e.dataInicio);let r;if(typeof a=="number"&&typeof n=="number"){const c=y(a,n);c&&(r=new Date(c.year,c.month-1,1))}r||(r=new Date);let o=(r.getFullYear()-t.getFullYear())*12+(r.getMonth()-t.getMonth());try{const c=t.getFullYear(),f=t.getMonth()+1,d=y(r.getFullYear(),r.getMonth()+1),m=d&&(d.year>c||d.year===c&&d.month>f);e?.efetivarMesAtual===!1&&m&&(o-=1)}catch{}let s=o+1;return s>e.parcelasTotal&&(s=e.parcelasTotal),s<1&&(s=1),s}catch(t){return console.error("Erro ao calcular parcela da recorrente:",t),1}}function ae(e,a=[],n=null,t=null){if(!n||!t){const i=new Date;n=i.getFullYear(),t=i.getMonth()+1}const r=y(n,t)||{year:n,month:t},{year:o,month:s}=r,c=a.some(i=>{if(!i.recorrenteId||i.recorrenteId!==e.id)return!1;let u;if(i.createdAt&&typeof i.createdAt=="object"&&i.createdAt.seconds)u=new Date(i.createdAt.seconds*1e3);else if(i.createdAt)u=new Date(i.createdAt);else return!1;return u.getFullYear()===o&&u.getMonth()+1===s});let f=v(e,o,s);const d=y(o,s+1)||{year:o,month:s},m=y(o,s-1)||{year:o,month:s};let l=v(e,d.year,d.month),p=v(e,m.year,m.month);try{const i=a.filter(u=>u.recorrenteId===e.id&&u.createdAt).map(u=>u.createdAt?.toDate?u.createdAt.toDate():new Date(u.createdAt)).sort((u,w)=>u-w);if(i.length>0&&e.dataInicio){const u=i[0],w=new Date(e.dataInicio),D=y(w.getFullYear(),w.getMonth()+1),A=y(u.getFullYear(),u.getMonth()+1);if(D&&A){const P=(A.year-D.year)*12+(A.month-D.month);if(P>0){const M=g=>{if(g==null)return g;const j=e.parcelasTotal||g;return Math.max(1,Math.min(j,g-P))};f=M(f),l=M(l),p=M(p)}}}}catch{}let I=!1,T=!1;try{if(e?.parcelasTotal&&e.dataInicio){const i=new Date(e.dataInicio),u=new Date(o,s-1,1);let w=(u.getFullYear()-i.getFullYear())*12+(u.getMonth()-i.getMonth());const D=i.getFullYear(),A=i.getMonth()+1,P=o>D||o===D&&s>A,M=o===D&&s===A;e?.efetivarMesAtual===!1&&(P||M)&&(w-=1);const g=w+1;I=g>e.parcelasTotal,T=g<1}}catch{}return{foiEfetivadaEsteMes:c,parcelaAtual:f,proximaParcela:l,ultimaParcela:p,totalParcelas:e.parcelasTotal,temParcelas:e.parcelasTotal&&e.parcelasTotal>1,ativa:e.ativa!==!1,aposUltimaParcela:I,antesDaPrimeiraParcela:T}}async function K(e){return O(e)}async function te(e){return e?b(e):[]}async function ne(e,a,n){const t={...n,userId:e,budgetId:a,ativa:!0,createdAt:new Date,parcelasRestantes:n.parcelasRestantes??null,parcelasTotal:n.parcelasTotal??null,efetivarMesAtual:n.efetivarMesAtual??!1},r=await k(t);return r.id||r}async function Y(e,a,n){await z(a,{...n,updatedAt:new Date})}async function re(e,a){await G(a)}async function oe(e,a,n=!1,t=null,r=null){const o=new Date,s=Number.isFinite(r)?r:o.getMonth()+1,c=Number.isFinite(t)?t:o.getFullYear(),d=(await K(a)).filter(i=>i.ativa===!0),m=await Q(a,c,s);let l=0,p=0;const T=c===o.getFullYear()&&s===o.getMonth()+1?o.getDate():31;for(const i of d)if(!(!W(i,c,s,T)||X(m,i,c,s))&&!(i.parcelasRestantes!==null&&i.parcelasRestantes<=0)){if(!n){p++;continue}await Z(i,e,a,c,s),l++}return{aplicadas:l,pendentes:p,total:d.length}}async function Q(e,a,n){try{let t=window?.appState?.transactions;return(!Array.isArray(t)||t.length===0)&&(t=await C({budgetId:e})),t.filter(r=>{const o=r.createdAt;if(!o)return!1;const s=o?.toDate?o.toDate():new Date(o);return s.getFullYear()===a&&s.getMonth()+1===n})}catch(t){return console.error("Erro ao obter transações do mês:",t),[]}}function W(e,a,n,t=null){if(!e.dataInicio)return!0;try{const[r,o,s]=String(e.dataInicio).split("-").map(Number),c=new Date(r,o-1,s),f=c.getFullYear(),d=c.getMonth()+1,m=c.getDate();if(a<f||a===f&&n<d||a===f&&n===d&&(Number.isFinite(t)?t:new Date().getDate())<m)return!1;let l=(a-f)*12+(n-d);return!e.efetivarMesAtual&&(a>f||a===f&&n>d)&&(l-=1),!(e.parcelasTotal!==null&&e.parcelasTotal!==void 0&&l+1>e.parcelasTotal||e.parcelasRestantes!==null&&e.parcelasRestantes!==void 0&&e.parcelasRestantes<=0)}catch(r){return console.error("Erro ao verificar se deve aplicar neste mês:",r),!0}}function X(e,a,n,t){try{return e.some(r=>{if(r.recorrenteId&&a.id&&r.recorrenteId===a.id)return!0;if(a.descricao&&r.descricao===a.descricao){const o=v(a,n,t),s=a.parcelasTotal!==null&&a.parcelasTotal!==void 0,c=r.parcelasTotal!==void 0&&r.parcelasTotal!==null||r.parcelaAtual!==void 0&&r.parcelaAtual!==null;if(s){if(r.parcelasTotal===a.parcelasTotal&&r.parcelaAtual===o)return!0}else if(!c||r.parcelasTotal===1)return!0}return!1})}catch(r){return console.error("Erro ao verificar se já aplicada:",r),!1}}async function Z(e,a,n,t,r){const o=e.diaLancamento||1,s=new Date(t,r,0).getDate(),c=Math.max(1,Math.min(s,Number(o))),f=new Date(t,r-1,c),d=v(e,t,r),{id:m}=await $({userId:a,budgetId:n,rec:e,createdDate:f,parcelaAtual:d});try{const l=a,p=n||(typeof window<"u"?window?.appState?.currentBudget?.id:void 0);if(p&&l){const{sendTransactionNotification:I}=await V(async()=>{const{sendTransactionNotification:i}=await import("./NotificationService-zMQk2mrd.js");return{sendTransactionNotification:i}},__vite__mapDeps([0,1,2])),T={id:m,descricao:e.descricao,valor:e.valor,categoriaId:e.categoriaId||null,tipo:e.tipo||"despesa",recorrenteId:e.id,recorrenteParcelaAtual:d??null,recorrenteParcelasTotal:e.parcelasTotal??null};await I(p,l,T)}}catch(l){console.warn("Falha ao enviar notificação de aplicação de recorrente:",l)}if(e.parcelasRestantes!==null&&e.parcelasRestantes!==void 0){const l=Math.max(0,e.parcelasRestantes-1);l<=0?await Y(a,e.id,{parcelasRestantes:0,ativa:!1}):await Y(a,e.id,{parcelasRestantes:l})}try{(e.parcelasRestantes===null||e.parcelasRestantes===void 0)&&e.parcelasTotal!==null&&e.parcelasTotal!==void 0&&(e.parcelasTotal<=1||(d??Number.POSITIVE_INFINITY)>=e.parcelasTotal)&&await Y(a,e.id,{ativa:!1})}catch(l){console.warn("Falha ao auto-inativar recorrente após última parcela:",l)}await H({userId:a,mesAno:`${t}-${String(r).padStart(2,"0")}`,transacaoId:m,transacaoData:{recorrenteId:e.id,descricao:e.descricao,valor:e.valor}})}async function se(e){const a=new Date,n=new Date(a.getFullYear()-1,a.getMonth(),a.getDate());return J(e,n)}async function ie(){try{const e=window.appState?.currentUser?.uid,a=window.appState?.currentBudget?.id;if(!e||!a)return console.warn("Usuário ou orçamento não encontrado para carregar recorrentes"),[];let n=[];try{a&&(n=await O(a)),(!n||n.length===0)&&(n=await b(e))}catch(t){console.warn("Falha ao listar recorrentes por orçamento, tentando por usuário...",t),n=await b(e)}return window.appState||(window.appState={}),window.appState.recorrentes=n,console.log(`✅ ${n.length} recorrentes carregadas`),n}catch(e){return console.error("❌ Erro ao carregar recorrentes:",e),[]}}export{ne as addRecorrente,oe as aplicarRecorrentesDoMes,v as calcularParcelaRecorrente,ae as calcularStatusRecorrente,re as deleteRecorrente,K as getRecorrentesDoOrcamento,te as getRecorrentesDoUsuario,se as limparLogsAntigos,ie as loadRecorrentes,Y as updateRecorrente};

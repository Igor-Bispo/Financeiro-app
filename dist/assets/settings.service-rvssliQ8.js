import{q as v,c as m,d as s,w as u,g as b,a as d,b as w,u as U,s as h,k as D,n as B,o as y}from"./main-Bd5V083V.js";import{p as $,r as k}from"./main-Bd5V083V.js";async function x(t){if(!t)return[];try{console.log("[DEBUG] Carregando convites para userId:",t);const e=v(m(s,"budgetInvitations"),u("invitedUserId","==",t),u("status","==","pending")),n=await b(e);console.log("[DEBUG] Convites por invitedUserId:",n.docs.length);const o=window.appState?.currentUser;let i;if(o?.email){const a=v(m(s,"budgetInvitations"),u("invitedUserEmail","==",o.email),u("status","==","pending")),f=await b(a);console.log("[DEBUG] Convites por email:",f.docs.length);const c=new Map;[...n.docs,...f.docs].forEach(r=>{c.set(r.id,{id:r.id,...r.data()})}),i=Array.from(c.values()),console.log("[DEBUG] Total de convites únicos:",i.length)}else i=n.docs.map(a=>({id:a.id,...a.data()})),console.log("[DEBUG] Convites encontrados:",i.length);const l=new Map,g=new Map;for(const a of i)if(a.budgetId){if(!l.has(a.budgetId)){const r=d(s,"budgets",a.budgetId),p=await w(r);l.set(a.budgetId,p.exists()?p.data():null)}const f=l.get(a.budgetId);a.budgetName=a.budgetName||f?.nome||"Orçamento";const c=f?.userId;if(c){if(!g.has(c)){const r=d(s,"users",c),p=await w(r);g.set(c,p.exists()?p.data():null)}a.ownerEmail=a.ownerEmail||g.get(c)?.email||"proprietario"}}return i}catch(e){throw console.error("Erro ao carregar convites de orçamento:",e),e}}async function C(t){if(!t)return[];try{const e=v(m(s,"budgetInvitations"),u("budgetId","==",t),u("status","==","pending"));return(await b(e)).docs.map(o=>({id:o.id,...o.data()}))}catch(e){throw console.error("Erro ao carregar convites enviados:",e),e}}async function q(t){console.log("[DEBUG] Aceitando convite:",t);const e=d(s,"budgetInvitations",t);await U(e,{status:"accepted",acceptedAt:h()});const o=(await w(e)).data();if(console.log("[DEBUG] Dados do convite:",o),o&&o.budgetId){const i=window.appState?.currentUser?.uid;if(!i)throw new Error("Usuário não autenticado");console.log("[DEBUG] Adicionando usuário ao orçamento:",{budgetId:o.budgetId,currentUserId:i});const l=d(s,"budgets",o.budgetId);await U(l,{usuariosPermitidos:D(i)}),console.log("[DEBUG] Usuário adicionado ao orçamento com sucesso")}else throw console.error("[DEBUG] Dados do convite inválidos:",{hasInvitationData:!!o,hasBudgetId:!!o?.budgetId}),new Error("Dados do convite inválidos")}async function A(t){const e=d(s,"budgetInvitations",t);await U(e,{status:"declined"})}async function P(t,e){const n=d(s,"budgets",t),o=await w(n);if(!o.exists())throw new Error("Orçamento não encontrado.");const g=(o.data().usuariosPermitidos||[]).filter(a=>a!==e);await U(n,{usuariosPermitidos:g})}async function O(t,e){const n=d(s,"budgets",t);await U(n,{nome:e})}async function L(t){const e=d(s,"budgetInvitations",t);await B(e)}async function S(t){if(!t)return null;const e=d(s,"users",t),n=await w(e);return n.exists()?{uid:n.id,...n.data()}:null}async function N(t){if(!t||t.length===0)return[];const e=t.map(o=>S(o).catch(i=>(console.warn(`Falha ao buscar info para UID: ${o}`,i),null)));return(await Promise.all(e)).filter(Boolean)}async function R(t){if(!t)return null;const e=v(m(s,"users"),u("email","==",t.toLowerCase())),n=await b(e);return n.empty?null:n.docs[0].id}async function M(t,e,n){if(!t)throw new Error("Orçamento inválido");if(!n||!n.uid)throw new Error("Usuário não autenticado");if(!e)throw new Error("Informe um email");const o=e.trim().toLowerCase();if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(o))throw new Error("Email inválido");const i=d(s,"budgets",t),l=await w(i);if(!l.exists())throw new Error("Orçamento não encontrado");const g=l.data(),a=v(m(s,"budgetInvitations"),u("budgetId","==",t),u("invitedUserEmailLower","==",o),u("status","==","pending"));if(!(await b(a)).empty)throw new Error("Já existe um convite pendente para este email");const c=await R(o);let r="proprietario";try{if(g.userId){const E=d(s,"users",g.userId),I=await w(E);r=I.exists()&&I.data().email||r}}catch{}return{id:(await y(m(s,"budgetInvitations"),{budgetId:t,budgetName:g.nome||"Orçamento",ownerEmail:r,invitedByUserId:n.uid,invitedUserId:c||null,invitedUserEmail:e.trim(),invitedUserEmailLower:o,status:"pending",createdAt:h()})).id}}export{q as acceptBudgetInvitation,R as buscarUidPorEmail,L as cancelSentInvitation,A as declineBudgetInvitation,S as fetchUserInfo,N as fetchUsersInfo,$ as getBudgetById,M as inviteUserToBudget,x as loadBudgetInvitations,C as loadSentBudgetInvitations,k as loadUserBudgets,P as removeUserFromBudget,O as updateBudgetName};

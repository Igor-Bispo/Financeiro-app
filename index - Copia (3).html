<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>Controle Financeiro</title>
    
    <meta name="theme-color" content="#4F46E5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#E0E7FF',
                        danger: '#EF4444',
                        info: '#3B82F6',
                        success: '#10B981',
                        warning: '#F59E0B'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        /* Ajuste de Fonte Base */
        html {
            font-size: 15px;
        }
        @media (min-width: 640px) {
            html {
                font-size: 16px;
            }
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #F0F4F8, #D9E2EC);
            padding-bottom: 80px; /* Mais espaço para a barra de navegação */
            padding-left: 0.5rem;
            padding-right: 0.5rem;
            padding-top: 0.25rem; /* Ajuste para otimizar espaço no topo */
            line-height: 1.4;
        }

        /* Container principal mais compacto */
        .max-w-4xl {
            max-width: 100%;
            padding: 0.5rem; /* Ajuste para mobile */
        }

        /* Estilos de transição e foco */
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: theme('colors.primary');
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
        select, select option {
            color: #000;
        }

        /* Otimização de Espaço: Cards e listas */
        #transactions-list > li,
        #categories-list > li,
        #goals-list > li {
            padding: 0.75rem; /* Ajuste para mobile */
            flex-direction: column;
            align-items: flex-start;
        }
        .summary-card {
            padding: 0.5rem; /* Ajuste para mobile */
            min-height: 70px; /* Altura consistente */
        }
        .summary-card p {
            font-size: 0.75rem;
        }
        .summary-card .amount-text {
            font-size: 0.875rem;
        }

        /* Otimização de Espaço: Texto e Títulos */
        header h1 { font-size: 1.75rem; }
        header p { font-size: 0.9rem; }
        h2 { font-size: 1.25rem; }
        h3 { font-size: 1rem; }
        #transactions-list > li p, #categories-list > li p, #goals-list > li p {
            font-size: 0.875rem;
            color: #212121 !important;
        }
        #transactions-list > li .text-gray-600, #categories-list > li .text-gray-600, #goals-list > li .text-gray-600 {
            color: #444444 !important;
        }

        /* Scroll suave e otimizado */
        .overflow-y-auto {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            max-height: 50vh;
        }

        /* Otimização de Eventos Touch */
        @media (hover: none) {
            .hover-effect:hover, button:hover, .bottom-nav-button:hover, .delete-btn:hover {
                background-color: initial !important;
                color: initial !important;
                box-shadow: none !important;
            }
            .bottom-nav-button.active:hover {
                color: theme('colors.primary');
            }
        }

        /* Estilos do Modal */
        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #fefefe; margin: auto; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 500px; max-height: 80vh; display: flex; flex-direction: column; width: 95%; padding: 1rem;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-header h3 { font-size: 1.25rem; font-weight: 600; color: #1F2937; }
        .modal-close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .modal-close-btn:hover, .modal-close-btn:focus { color: #333; }
        .modal-body { flex-grow: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-right: 5px; }
        .modal-transaction-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #eee; }
        .modal-transaction-item:last-child { border-bottom: none; }
        .modal-transaction-item .amount { font-weight: 600; margin-left: 10px; flex-shrink: 0; }

        /* Correções de cor de texto em inputs e placeholders */
        #transaction-form input, #transaction-form select, #transaction-form textarea, #categories-content input, #categories-content select {
            color: #000 !important; background-color: #fff !important;
        }
        #transaction-form input::placeholder, #categories-content input::placeholder {
            color: #6b7280 !important; opacity: 1 !important;
        }

        /* --- INÍCIO DAS NOVAS MELHORIAS --- */

        /* 1. Layout e Espaçamento Otimizados */
        @media (max-width: 640px) {
            .max-w-4xl { box-shadow: none; border-radius: 0; padding: 0.5rem; }
            section, .bg-gray-50, .bg-white { box-shadow: none; border: none; border-radius: 0.5rem; }
        }
        .space-y-8 { row-gap: 1rem; }
        header { margin-bottom: 0.5rem; }
        .p-4, .p-6 { padding: 0.75rem; }
        .mt-1 { margin-top: 0.25rem; }
        label { margin-bottom: 0.25rem; }

        /* 3. Melhorias na Barra Inferior */
        .bottom-nav {
            height: 56px; /* Mais alto para melhor toque */
            border-radius: 0; /* Remove border-radius para mobile */
            margin: 0; /* Remove margem para ocupar toda a largura */
            width: 100%;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.15); /* Sombra mais proeminente */
            border-top: 1px solid rgba(0,0,0,0.1); /* Linha superior sutil */
        }
        .bottom-nav-button {
            padding: 0.5rem;
            min-height: 44px; /* Tamanho mínimo de toque acessível */
            font-size: 0.7rem;
            flex-direction: column;
            gap: 2px;
        }
        .bottom-nav-button svg {
            height: 1.5rem; /* Ícones maiores */
            width: 1.5rem;
        }
        .bottom-nav-button:active { transform: scale(0.95); }
        .bottom-nav-button.active { position: relative; color: theme('colors.primary');}
        .bottom-nav-button.active:after {
            content: ''; position: absolute; top: 2px; left: 50%;
            transform: translateX(-50%); width: 4px; height: 4px;
            border-radius: 50%; background-color: theme('colors.primary');
        }

        /* 4. Otimização de Listas */
        #transactions-list > li, #categories-list > li, #goals-list > li {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        #transactions-list > li:active, #categories-list > li:active, #goals-list > li:active {
            transform: scale(0.98); box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .space-y-3 > * + * { margin-top: 0.5rem; }

        /* 5. Formulários Otimizados */
        input, select, textarea, button {
            font-size: 16px !important; /* Melhora o zoom automático no iOS */
            min-height: 44px; /* Tamanho mínimo de toque acessível */
        }
        input, select {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-position: right 0.5rem center; background-repeat: no-repeat;
            background-size: 1rem; padding-right: 2rem; padding: 0.5rem; font-size: 0.875rem;
        }
        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%236b7280'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
        }
        button[type="submit"] { font-weight: 600; letter-spacing: 0.025em; }

        /* 6. Feedback Visual Melhorado */
        button, .bottom-nav-button, [tabindex] { transition: transform 0.1s, opacity 0.1s, background-color 0.2s; }
        button:active, .bottom-nav-button:active, [tabindex]:active { transform: scale(0.96); opacity: 0.9; }
        #message-container div { font-size: 0.875rem; padding: 0.75rem; }
        .fixed.bottom-4.right-4 { width: 36px; height: 36px; font-size: 0.875rem; }

        /* 8. Ajustes Finais de UX */
        #tab-content > section { transition: opacity 0.3s ease; }
        #tab-content > section.hidden { display: none; opacity: 0; }
        #tab-content > section:not(.hidden) { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.2); border-radius: 2px; }

        /* Melhorias nos modais para mobile */
        .modal-content {
            width: 95%;
            max-height: 85vh;
            margin: 0;
            border-radius: 12px 12px 0 0;
            position: fixed;
            bottom: 0;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        /* Ajustes no gráfico para mobile */
        .chart-container {
            height: 250px !important;
            position: relative;
        }

        /* Ajuste para evitar zoom em inputs no iOS */
        @media screen and (-webkit-min-device-pixel-ratio:0) {
            input, select, textarea {
                font-size: 16px !important;
            }
        }

        /* Melhorias na visualização de transações */
        .transaction-item {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 0.5rem;
        }

        .transaction-info {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Ajuste para evitar scroll horizontal em tabelas */
        .overflow-x-hidden {
            overflow-x: hidden;
        }

        /* NOVOS ESTILOS PARA O MICROFONE */
        .voice-input-container {
            position: relative;
        }
        .voice-input-btn {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #6b7280;
            transition: color 0.2s;
        }
        .voice-input-btn:hover {
            color: theme('colors.primary');
        }
        .voice-input-btn.listening {
            color: theme('colors.danger');
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .voice-feedback {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 1000;
            display: none;
        }

        /* Estilos para o loading spinner */
        #custom-loading {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.5);
            /* display: flex; Removido para ser controlado via JS */
            align-items: center;
            justify-content: center;
            z-index: 5000; /* Garante que fique acima de tudo */
        }
        #custom-loading > div {
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            text-align: center;
        }
        #custom-loading .animate-spin {
            border-color: theme('colors.primary');
            border-top-color: transparent;
            border-right-color: transparent;
        }

        /* Adicionar ao seu bloco de estilos */
        .sync-status {
            position: fixed;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .sync-status .sync-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Skeleton Loading */
        .skeleton {
            animation: skeleton-loading 1.5s linear infinite alternate;
            background-color: #f3f4f6; /* light gray */
            border-radius: 0.25rem;
        }

        .dark .skeleton {
            background-color: #374151; /* dark gray */
        }

        @keyframes skeleton-loading {
            0% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .skeleton-text {
            height: 1rem; /* Adjust height as needed */
            margin-bottom: 0.5rem;
        }

        .skeleton-line-long {
            width: 90%;
        }

        .skeleton-line-medium {
            width: 70%;
        }

        .skeleton-line-short {
            width: 40%;
        }

        /* --- FIM DAS NOVAS MELHORIAS --- */

        /* Estilo para o botão de instalação PWA */
        .install-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 50;
            background-color: #4F46E5;
            color: white;
            padding: 12px 20px; /* Ajustado para melhor toque */
            border-radius: 50px; /* Mais arredondado */
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-weight: 600;
            transition: all 0.3s ease; /* Transição para todas as propriedades */
            cursor: pointer;
            border: none;
            animation: pulse 2s infinite; /* Animação atualizada */
            display: flex; /* Para alinhar o ícone */
            align-items: center; /* Para alinhar o ícone */
        }

        .install-btn:hover {
            background-color: #3B34B2;
            transform: translateY(-2px); /* Efeito de elevação */
            box-shadow: 0 6px 16px rgba(0,0,0,0.3); /* Sombra maior no hover */
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* iOS Install Banner */
        .ios-install-banner {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: white;
            color: #333;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            max-width: 90%;
            z-index: 100;
            display: none; /* Hidden by default, shown by JS */
        }

        .ios-install-content {
            text-align: center;
        }

        .ios-install-content ol {
            text-align: left;
            padding-left: 20px;
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .ios-install-content button {
            background-color: #eee;
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            margin-top: 10px;
        }

        /* Estilo para o feedback de voz (novo) */
        .voice-feedback {
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 1rem;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            z-index: 1000;
            position: fixed; /* Adicionado para garantir que fique na tela */
            bottom: 100px; /* Ajustado para não cobrir a barra de navegação */
            left: 50%;
            transform: translateX(-50%);
            display: none; /* Escondido por padrão */
        }
        #voice-feedback-fields {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
        }
        /* Botão de confirmação (novo) */
        #confirm-voice-command {
            transition: all 0.2s;
        }
        #confirm-voice-command:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Estilos para os cabeçalhos de ordenação */
        .sortable-header {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            user-select: none; /* Prevent text selection on double click */
        }
        .sort-icon {
            width: 16px;
            height: 16px;
            transition: transform 0.2s;
        }
        .sort-icon.asc {
            transform: rotate(0deg);
        }
        .sort-icon.desc {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">
    <div class="max-w-4xl mx-auto bg-white dark:bg-gray-800 rounded-3xl shadow-xl space-y-8">

        <header class="text-center">
            <h1 class="font-bold text-gray-900 dark:text-gray-100 leading-tight">
                Controle Financeiro
            </h1>
            <p class="text-gray-600 dark:text-gray-300 mt-2">Gerencie suas finanças de forma simples</p>
        </header>

        <div id="message-container" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 w-11/12 max-w-sm"></div>

        <section class="bg-gray-50 dark:bg-gray-700 p-6 rounded-2xl">
            <h2 class="font-semibold text-gray-800 dark:text-gray-200 mb-4">Resumo do Orçamento</h2>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                <div class="bg-white dark:bg-gray-900 rounded-xl summary-card">
                    <p class="text-gray-600 dark:text-gray-400">Receita Total</p>
                    <p id="total-revenue" class="amount-text font-bold text-green-600 mt-1">R$ 0.00</p>
                </div>
                <div class="bg-white dark:bg-gray-900 rounded-xl summary-card">
                    <p class="text-gray-600 dark:text-gray-400">Despesa Total</p>
                    <p id="total-expense" class="amount-text font-bold text-red-600 mt-1">R$ 0.00</p>
                </div>
                <div class="bg-white dark:bg-gray-900 rounded-xl summary-card">
                    <p id="current-balance-label" class="text-gray-600 dark:text-gray-400">Saldo Atual</p>
                    <p id="current-balance" class="amount-text font-bold text-blue-600 mt-1">R$ 0.00</p>
                </div>
                <div class="bg-white dark:bg-gray-900 rounded-xl summary-card">
                    <p id="remaining-budget-label" class="text-gray-600 dark:text-gray-400">Orçamento Restante</p>
                    <p id="remaining-budget" class="amount-text font-bold text-purple-600 mt-1">R$ 0.00</p>
                </div>
            </div>
        </section>

        <div id="tab-content">
            <section id="transactions-content" class="bg-white dark:bg-gray-800 p-4 rounded-2xl space-y-4">
                <h2 class="font-semibold text-gray-800 dark:text-gray-200 mb-3">Adicionar Nova Transação</h2>
                <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="voice-input-container">
                        <label for="transaction-description" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Descrição</label>
                        <input type="text" id="transaction-description" placeholder="Ex: Aluguel, Salário" required
                               class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm pr-10">
                        <button type="button" id="voice-input-btn" class="voice-input-btn" title="Falar descrição">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    <div>
                        <label for="transaction-amount" class="block text-sm font-medium text-black dark:text-gray-300">Valor <span class="text-xs text-gray-500">(use . para decimais)</span></label>
                        <input type="number" id="transaction-amount" placeholder="Ex: 500.00" step="0.01" required inputmode="decimal"
                               class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="transaction-type" class="block text-sm font-medium text-black dark:text-gray-300">Tipo</label>
                        <select id="transaction-type" required class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm">
                            <option value="revenue">Receita</option>
                            <option value="expense">Despesa</option>
                        </select>
                    </div>
                    <div>
                        <label for="transaction-category" class="block text-sm font-medium text-black dark:text-gray-300">Categoria</label>
                        <select id="transaction-category" required class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm">
                        </select>
                    </div>
                    <div class="col-span-1 md:col-span-2 flex items-center space-x-2">
                        <input type="checkbox" id="transaction-is-recurring" class="form-checkbox h-4 w-4 text-primary rounded">
                        <label for="transaction-is-recurring" class="text-sm font-medium text-gray-700 dark:text-gray-300">É Recorrente?</label>
                        <input type="date" id="transaction-next-due-date" class="mt-1 block flex-1 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm" style="display: none;">
                    </div>
                    <div class="col-span-1 md:col-span-2">
                        <button type="submit" class="w-full bg-primary text-white py-2 px-4 rounded-lg hover:bg-opacity-90 transition duration-200 shadow-md">Adicionar Transação</button>
                    </div>
                </form>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm mt-6">
                    <h3 class="font-semibold text-gray-800 dark:text-gray-200 mb-2">Orçamento Mensal</h3>
                    <div class="flex items-center mb-2">
                        <input type="number" id="monthly-budget-input" placeholder="Defina seu orçamento" class="flex-1 p-2 border border-gray-300 dark:border-gray-600 rounded-lg mr-2" inputmode="decimal">
                        <button id="set-budget-btn" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-opacity-90 transition duration-200 shadow-md">
                            Definir
                        </button>
                    </div>
                    <div id="monthly-budget-progress-container" class="progress-container hidden">
                        <div class="flex justify-between text-sm mb-1 text-gray-700 dark:text-gray-300">
                            <span>Gasto: <span id="monthly-spent">R$ 0</span></span>
                            <span>Restante: <span id="monthly-remaining">R$ 0</span></span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-600">
                            <div id="monthly-progress" class="h-2.5 rounded-full bg-primary" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-between items-center mt-6 mb-3">
                    <h3 class="font-semibold text-gray-800 dark:text-gray-200">Minhas Transações</h3>
                    <button id="export-excel-btn" class="bg-green-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-600 transition-colors shadow-md"> Exportar para Excel </button>
                </div>
                <input type="text" id="transactions-search-input" placeholder="Pesquisar transações..." class="w-full p-2 mb-4 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm">
                <div class="bg-gray-100 dark:bg-gray-700 p-2 rounded-xl shadow-inner">
                    <div class="grid grid-cols-4 gap-2 text-sm font-semibold text-gray-700 dark:text-gray-300 pb-2 border-b border-gray-300 dark:border-gray-600">
                        <div class="sortable-header" data-sort-field="timestamp"> Data <svg class="sort-icon w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg> </div>
                        <div class="sortable-header" data-sort-field="description"> Descrição <svg class="sort-icon w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg> </div>
                        <div class="sortable-header" data-sort-field="categoryName"> Categoria <svg class="sort-icon w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg> </div>
                        <div class="sortable-header text-right" data-sort-field="amount"> Valor <svg class="sort-icon w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg> </div>
                    </div>
                    <ul id="transactions-list" class="divide-y divide-gray-200 dark:divide-gray-600 max-h-96 overflow-y-auto">
                        <div id="transactions-list-skeleton">
                            <li class="p-3 flex items-center justify-between animate-pulse">
                                <div class="flex-1 space-y-2">
                                    <div class="h-3 bg-gray-300 dark:bg-gray-600 rounded skeleton-line-medium"></div>
                                    <div class="h-3 bg-gray-300 dark:bg-gray-600 rounded skeleton-line-short"></div>
                                </div>
                                <div class="w-16 h-3 bg-gray-300 dark:bg-gray-600 rounded"></div>
                            </li>
                            <li class="p-3 flex items-center justify-between animate-pulse">
                                <div class="flex-1 space-y-2">
                                    <div class="h-3 bg-gray-300 dark:bg-gray-600 rounded skeleton-line-medium"></div>
                                    <div class="h-3 bg-gray-300 dark:bg-gray-600 rounded skeleton-line-short"></div>
                                </div>
                                <div class="w-16 h-3 bg-gray-300 dark:bg-gray-600 rounded"></div>
                            </li>
                            <li class="p-3 flex items-center justify-between animate-pulse">
                                <div class="flex-1 space-y-2">
                                    <div class="h-3 bg-gray-300 dark:bg-gray-600 rounded skeleton-line-medium"></div>
                                    <div class="h-3 bg-gray-300 dark:bg-gray-600 rounded skeleton-line-short"></div>
                                </div>
                                <div class="w-16 h-3 bg-gray-300 dark:bg-gray-600 rounded"></div>
                            </li>
                        </div>
                    </ul>
                </div>
            </section>

            <section id="categories-content" class="bg-white dark:bg-gray-800 p-4 rounded-2xl space-y-4 hidden">
                <h2 class="font-semibold text-gray-800 dark:text-gray-200 mb-3">Gerenciar Categorias</h2>
                <form id="category-form" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="voice-input-container">
                        <label for="category-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nome da Categoria</label>
                        <input type="text" id="category-name" placeholder="Ex: Mercado, Lazer" required
                               class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm">
                        <button type="button" id="voice-category-btn" class="voice-input-btn" title="Falar categoria">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    <div>
                        <label for="category-type" class="block text-sm font-medium text-black dark:text-gray-300">Tipo</label>
                        <select id="category-type" required class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm">
                            <option value="revenue">Receita</option>
                            <option value="expense">Despesa</option>
                        </select>
                    </div>
                    <div class="col-span-1 md:col-span-2">
                        <label for="category-limit" class="block text-sm font-medium text-black dark:text-gray-300">Limite Mensal <span class="text-xs text-gray-500">(opcional)</span></label>
                        <input type="number" id="category-limit" placeholder="Ex: 500.00" step="0.01" inputmode="decimal"
                               class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm">
                    </div>
                    <div class="col-span-1 md:col-span-2 flex space-x-2">
                        <button type="submit" class="w-full bg-primary text-white py-2 px-4 rounded-lg hover:bg-opacity-90 transition duration-200 shadow-md">Adicionar Categoria</button>
                        <button type="button" id="voice-edit-category-btn" class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors shadow-md flex-shrink-0" title="Editar categoria por voz">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.38-2.827-2.828z" />
                            </svg>
                        </button>
                    </div>
                </form>
                <input type="text" id="categories-search-input" placeholder="Pesquisar categorias..." class="w-full p-2 mb-4 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm">
                <ul id="categories-list" class="divide-y divide-gray-200 dark:divide-gray-600 max-h-96 overflow-y-auto">
                    <div id="categories-list-skeleton">
                        <li class="p-3 flex items-center justify-between animate-pulse">
                            <div class="flex-1 space-y-2">
                                <div class="h-3 bg-gray-300 dark:bg-gray-600 rounded skeleton-line-medium"></div>
                                <div class="h-3 bg-gray-300 dark:bg-gray-600 rounded skeleton-line-short"></div>
                            </div>
                            <div class="w-16 h-3 bg-gray-300 dark:bg-gray-600 rounded"></div>
                        </li>
                        <li class="p-3 flex items-center justify-between animate-pulse">
                            <div class="flex-1 space-y-2">
                                <div class="h-3 bg-gray-300 dark:bg-gray-600 rounded skeleton-line-medium"></div>
                                <div class="h-3 bg-gray-300 dark:bg-gray-600 rounded skeleton-line-short"></div>
                            </div>
                            <div class="w-16 h-3 bg-gray-300 dark:bg-gray-600 rounded"></div>
                        </li>
                    </div>
                </ul>
            </section>

            <section id="goals-content" class="bg-white dark:bg-gray-800 p-4 rounded-2xl space-y-4 hidden">
                <h2 class="font-semibold text-gray-800 dark:text-gray-200 mb-3">Gerenciar Metas</h2>
                <form id="goal-form" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label for="goal-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nome da Meta</label>
                        <input type="text" id="goal-name" placeholder="Ex: Carro novo, Viagem" required
                               class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="goal-amount" class="block text-sm font-medium text-black dark:text-gray-300">Valor Alvo</label>
                        <input type="number" id="goal-amount" placeholder="Ex: 10000.00" step="0.01" required inputmode="decimal"
                               class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm">
                    </div>
                    <div class="col-span-1 md:col-span-2">
                        <label for="goal-target-date" class="block text-sm font-medium text-black dark:text-gray-300">Data Alvo</label>
                        <input type="date" id="goal-target-date" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm">
                    </div>
                    <div class="col-span-1 md:col-span-2">
                        <button type="submit" class="w-full bg-primary text-white py-2 px-4 rounded-lg hover:bg-opacity-90 transition duration-200 shadow-md">Adicionar Meta</button>
                    </div>
                </form>
                <ul id="goals-list" class="divide-y divide-gray-200 dark:divide-gray-600 max-h-96 overflow-y-auto mt-6">
                    <div id="goals-list-skeleton">
                        <li class="p-3 flex items-center justify-between animate-pulse">
                            <div class="flex-1 space-y-2">
                                <div class="h-3 bg-gray-300 dark:bg-gray-600 rounded skeleton-line-long"></div>
                                <div class="h-3 bg-gray-300 dark:bg-gray-600 rounded skeleton-line-medium"></div>
                            </div>
                            <div class="w-16 h-3 bg-gray-300 dark:bg-gray-600 rounded"></div>
                        </li>
                        <li class="p-3 flex items-center justify-between animate-pulse">
                            <div class="flex-1 space-y-2">
                                <div class="h-3 bg-gray-300 dark:bg-gray-600 rounded skeleton-line-long"></div>
                                <div class="h-3 bg-gray-300 dark:bg-gray-600 rounded skeleton-line-medium"></div>
                            </div>
                            <div class="w-16 h-3 bg-gray-300 dark:bg-gray-600 rounded"></div>
                        </li>
                    </div>
                </ul>
            </section>

            <section id="reports-content" class="bg-white dark:bg-gray-800 p-4 rounded-2xl space-y-4 hidden">
                <h2 class="font-semibold text-gray-800 dark:text-gray-200 mb-3">Relatórios</h2>
                <div class="chart-container">
                    <canvas id="category-chart"></canvas>
                </div>
                <div class="chart-container mt-4">
                    <canvas id="transaction-type-chart"></canvas>
                </div>
                <div class="flex justify-between items-center mt-6">
                    <button id="export-reports-btn" class="w-full bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition duration-200 shadow-md">
                        Exportar Relatórios
                    </button>
                </div>
            </section>

            <section id="settings-content" class="bg-white dark:bg-gray-800 p-4 rounded-2xl space-y-4 hidden">
                <h2 class="font-semibold text-gray-800 dark:text-gray-200 mb-3">Configurações</h2>
                <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <span class="text-gray-700 dark:text-gray-300">Modo Escuro</span>
                    <label for="dark-mode-toggle" class="flex items-center cursor-pointer">
                        <div class="relative">
                            <input type="checkbox" id="dark-mode-toggle" class="sr-only">
                            <div class="block bg-gray-600 w-14 h-8 rounded-full"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
                        </div>
                    </label>
                </div>
                <button id="logout-btn" class="w-full bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition duration-200 shadow-md">
                    Sair
                </button>
                <div class="mt-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <p class="text-gray-700 dark:text-gray-300 text-sm">Usuário Logado: <span id="current-user-display"></span></p>
                </div>
            </section>
        </div>

        <div id="editTransactionModal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Editar Transação</h3>
                    <span class="modal-close-btn" onclick="hideModal('editTransactionModal')">&times;</span>
                </div>
                <div class="modal-body space-y-3">
                    <input type="hidden" id="edit-transaction-id">
                    <div>
                        <label for="edit-transaction-description" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Descrição</label>
                        <input type="text" id="edit-transaction-description" required class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="edit-transaction-amount" class="block text-sm font-medium text-black dark:text-gray-300">Valor</label>
                        <input type="number" id="edit-transaction-amount" step="0.01" required inputmode="decimal" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="edit-transaction-type" class="block text-sm font-medium text-black dark:text-gray-300">Tipo</label>
                        <select id="edit-transaction-type" required class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm">
                            <option value="revenue">Receita</option>
                            <option value="expense">Despesa</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-transaction-category" class="block text-sm font-medium text-black dark:text-gray-300">Categoria</label>
                        <select id="edit-transaction-category" required class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm">
                        </select>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="edit-transaction-is-recurring" class="form-checkbox h-4 w-4 text-primary rounded">
                        <label for="edit-transaction-is-recurring" class="text-sm font-medium text-gray-700 dark:text-gray-300">É Recorrente?</label>
                        <input type="date" id="edit-transaction-next-due-date" class="mt-1 block flex-1 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm" style="display: none;">
                    </div>
                    <button id="save-transaction-edit-btn" class="w-full bg-primary text-white py-2 px-4 rounded-lg hover:bg-opacity-90 transition duration-200 shadow-md">Salvar Alterações</button>
                    <button id="delete-transaction-btn" class="w-full bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition duration-200 shadow-md">Excluir Transação</button>
                </div>
            </div>
        </div>

        <div id="editCategoryModal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Editar Categoria</h3>
                    <span class="modal-close-btn" onclick="hideModal('editCategoryModal')">&times;</span>
                </div>
                <div class="modal-body space-y-3">
                    <input type="hidden" id="edit-category-id">
                    <div>
                        <label for="edit-category-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nome da Categoria</label>
                        <input type="text" id="edit-category-name" required class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="edit-category-type" class="block text-sm font-medium text-black dark:text-gray-300">Tipo</label>
                        <select id="edit-category-type" required class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm">
                            <option value="revenue">Receita</option>
                            <option value="expense">Despesa</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-category-limit" class="block text-sm font-medium text-black dark:text-gray-300">Limite Mensal</label>
                        <input type="number" id="edit-category-limit" step="0.01" inputmode="decimal" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm">
                    </div>
                    <button id="save-category-edit-btn" class="w-full bg-primary text-white py-2 px-4 rounded-lg hover:bg-opacity-90 transition duration-200 shadow-md">Salvar Alterações</button>
                    <button id="delete-category-btn" class="w-full bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition duration-200 shadow-md">Excluir Categoria</button>
                </div>
            </div>
        </div>

        <div id="editGoalModal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Editar Meta</h3>
                    <span class="modal-close-btn" onclick="hideModal('editGoalModal')">&times;</span>
                </div>
                <div class="modal-body space-y-3">
                    <input type="hidden" id="edit-goal-id">
                    <div>
                        <label for="edit-goal-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nome da Meta</label>
                        <input type="text" id="edit-goal-name" required class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="edit-goal-amount" class="block text-sm font-medium text-black dark:text-gray-300">Valor Alvo</label>
                        <input type="number" id="edit-goal-amount" step="0.01" required inputmode="decimal" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="edit-goal-target-date" class="block text-sm font-medium text-black dark:text-gray-300">Data Alvo</label>
                        <input type="date" id="edit-goal-target-date" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm">
                    </div>
                    <button id="save-goal-edit-btn" class="w-full bg-primary text-white py-2 px-4 rounded-lg hover:bg-opacity-90 transition duration-200 shadow-md">Salvar Alterações</button>
                    <button id="delete-goal-btn" class="w-full bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition duration-200 shadow-md">Excluir Meta</button>
                </div>
            </div>
        </div>

        <div id="voice-feedback" class="voice-feedback">
            <p id="voice-feedback-text">Ouvindo...</p>
            <div id="voice-feedback-details" class="voice-feedback-details mt-2 p-3 bg-gray-700 rounded-lg text-sm text-left hidden">
                <div id="voice-feedback-fields" class="space-y-1"></div>
                <div class="flex justify-end space-x-2 mt-3">
                    <button id="cancel-voice-command-btn" class="bg-gray-500 text-white px-3 py-1 rounded-lg hover:bg-gray-600 transition-colors text-xs">Cancelar</button>
                    <button id="confirm-voice-command-btn" class="bg-primary text-white px-3 py-1 rounded-lg hover:bg-opacity-90 transition-colors text-xs">Confirmar</button>
                </div>
            </div>
        </div>

        <div id="custom-loading" class="hidden flex items-center justify-center">
            <div class="bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 p-6 rounded-lg shadow-lg flex flex-col items-center">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-blue-500 mb-3"></div>
                <p id="loading-text">Carregando...</p>
            </div>
        </div>

        <div id="sync-status" class="sync-status hidden">
            <div class="sync-spinner"></div>
            <span id="sync-message">Sincronizando dados...</span>
        </div>

        <button id="install-button" class="install-btn hidden">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
            Instalar App
        </button>

        <div id="ios-install-banner" class="ios-install-banner">
            <div class="ios-install-content">
                <p class="font-semibold mb-2">Instale o aplicativo para uma melhor experiência!</p>
                <p>Para instalar, toque em <img src="https://i.imgur.com/example-share-icon.png" alt="Share Icon" class="inline w-5 h-5 mx-1"> e depois em "Adicionar à Tela de Início".</p>
                <button id="close-ios-install-banner">Entendi</button>
            </div>
        </div>

        <nav class="bottom-nav fixed bottom-0 left-0 w-full bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 flex justify-around items-center z-40 shadow-lg">
            <button class="bottom-nav-button flex flex-col items-center text-gray-500 dark:text-gray-400 active" data-tab="transactions">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                <span>Transações</span>
            </button>
            <button class="bottom-nav-button flex flex-col items-center text-gray-500 dark:text-gray-400" data-tab="categories">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                </svg>
                <span>Categorias</span>
            </button>
            <button class="bottom-nav-button flex flex-col items-center text-gray-500 dark:text-gray-400" data-tab="goals">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9m-3-4v4m3-4v4m3-4v4M9 10.5h.01M12 10.5h.01M15 10.5h.01M9 14.5h.01M12 14.5h.01M15 14.5h.01" />
                </svg>
                <span>Metas</span>
            </button>
            <button class="bottom-nav-button flex flex-col items-center text-gray-500 dark:text-gray-400" data-tab="reports">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                <span>Relatórios</span>
            </button>
            <button class="bottom-nav-button flex flex-col items-center text-gray-500 dark:text-gray-400" data-tab="settings">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.827 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.827 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.827-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.827-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <span>Ajustes</span>
            </button>
        </nav>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, deleteDoc, query, orderBy, onSnapshot, serverTimestamp, runTransaction, FieldValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
        import { getPerformance } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-performance.js";

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
  apiKey: "AIzaSyB8QauQw7YCg2DDsleFF5pbIcmPPuThv6M",
  authDomain: "financeiro-8c5b7.firebaseapp.com",
  databaseURL: "https://financeiro-8c5b7-default-rtdb.firebaseio.com",
  projectId: "financeiro-8c5b7",
  storageBucket: "financeiro-8c5b7.firebasestorage.app",
  messagingSenderId: "196239620563",
  appId: "1:196239620563:web:83f64e077179153f585726",
  measurementId: "G-1VYZSEV9M3"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const perf = getPerformance(app);

        // Firebase Firestore FieldValue (para serverTimestamp e outras operações de campo)
        const FieldValue_Compat = {
            serverTimestamp: () => serverTimestamp(),
            // Adicione outros FieldValue se necessário, como arrayUnion, arrayRemove
        };
        
        let currentUser = null;
        let activeBudgetId = null;
        let transactions = [];
        let categories = {};
        let goals = [];
        let transactionsUnsubscribe = null;
        let categoriesUnsubscribe = null;
        let goalsUnsubscribe = null;
        let chartInstances = {};
        let deferredPrompt;
        let isOnline = navigator.onLine;
        let pendingVoiceCommand = null;
        let currentVoiceCommandMode = null; // 'transaction' or 'category'
        let isCategoryEditMode = false; // true if editing an existing category by voice

        // DOM Elements
        const messageContainer = document.getElementById('message-container');
        const currentUserDisplay = document.getElementById('current-user-display');
        const loginGoogleBtn = document.getElementById('login-google-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const transactionForm = document.getElementById('transaction-form');
        const categoryForm = document.getElementById('category-form');
        const goalForm = document.getElementById('goal-form');
        const transactionsList = document.getElementById('transactions-list');
        const categoriesList = document.getElementById('categories-list');
        const goalsList = document.getElementById('goals-list');
        const totalRevenueEl = document.getElementById('total-revenue');
        const totalExpenseEl = document.getElementById('total-expense');
        const currentBalanceEl = document.getElementById('current-balance');
        const remainingBudgetEl = document.getElementById('remaining-budget');
        const transactionCategorySelect = document.getElementById('transaction-category');
        const transactionIsRecurringCheckbox = document.getElementById('transaction-is-recurring');
        const transactionNextDueDateInput = document.getElementById('transaction-next-due-date');
        const editTransactionModal = document.getElementById('editTransactionModal');
        const editTransactionIdInput = document.getElementById('edit-transaction-id');
        const editTransactionDescriptionInput = document.getElementById('edit-transaction-description');
        const editTransactionAmountInput = document.getElementById('edit-transaction-amount');
        const editTransactionTypeSelect = document.getElementById('edit-transaction-type');
        const editTransactionCategorySelect = document.getElementById('edit-transaction-category');
        const editTransactionIsRecurringCheckbox = document.getElementById('edit-transaction-is-recurring');
        const editTransactionNextDueDateInput = document.getElementById('edit-transaction-next-due-date');
        const saveTransactionEditBtn = document.getElementById('save-transaction-edit-btn');
        const deleteTransactionBtn = document.getElementById('delete-transaction-btn');
        const editCategoryModal = document.getElementById('editCategoryModal');
        const editCategoryIdInput = document.getElementById('edit-category-id');
        const editCategoryNameInput = document.getElementById('edit-category-name');
        const editCategoryTypeSelect = document.getElementById('edit-category-type');
        const editCategoryLimitInput = document.getElementById('edit-category-limit');
        const saveCategoryEditBtn = document.getElementById('save-category-edit-btn');
        const deleteCategoryBtn = document.getElementById('delete-category-btn');
        const editGoalModal = document.getElementById('editGoalModal');
        const editGoalIdInput = document.getElementById('edit-goal-id');
        const editGoalNameInput = document.getElementById('edit-goal-name');
        const editGoalAmountInput = document.getElementById('edit-goal-amount');
        const editGoalTargetDateInput = document.getElementById('edit-goal-target-date');
        const saveGoalEditBtn = document.getElementById('save-goal-edit-btn');
        const deleteGoalBtn = document.getElementById('delete-goal-btn');
        const monthlyBudgetInput = document.getElementById('monthly-budget-input');
        const setBudgetBtn = document.getElementById('set-budget-btn');
        const monthlySpentEl = document.getElementById('monthly-spent');
        const monthlyRemainingEl = document.getElementById('monthly-remaining');
        const monthlyProgressBar = document.getElementById('monthly-progress');
        const monthlyBudgetProgressContainer = document.getElementById('monthly-budget-progress-container');
        const transactionsSearchInput = document.getElementById('transactions-search-input');
        const categoriesSearchInput = document.getElementById('categories-search-input');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        const exportReportsBtn = document.getElementById('export-reports-btn');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const customLoading = document.getElementById('custom-loading');
        const loadingText = document.getElementById('loading-text');
        const syncStatus = document.getElementById('sync-status');
        const syncMessage = document.getElementById('sync-message');
        const installButton = document.getElementById('install-button');
        const iosInstallBanner = document.getElementById('ios-install-banner');
        const closeIosInstallBanner = document.getElementById('close-ios-install-banner');
        const voiceInputBtn = document.getElementById('voice-input-btn');
        const voiceCategoryBtn = document.getElementById('voice-category-btn');
        const voiceEditCategoryBtn = document.getElementById('voice-edit-category-btn');
        const voiceFeedback = document.getElementById('voice-feedback');
        const voiceFeedbackText = document.getElementById('voice-feedback-text');
        const voiceFeedbackDetails = document.getElementById('voice-feedback-details');
        const voiceFeedbackFields = document.getElementById('voice-feedback-fields');
        const confirmVoiceCommandBtn = document.getElementById('confirm-voice-command-btn');
        const cancelVoiceCommandBtn = document.getElementById('cancel-voice-command-btn');
        const transactionsListSkeleton = document.getElementById('transactions-list-skeleton');
        const categoriesListSkeleton = document.getElementById('categories-list-skeleton');
        const goalsListSkeleton = document.getElementById('goals-list-skeleton');

        // PWA Install Banner Logic
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.classList.remove('hidden');
        });

        installButton.addEventListener('click', () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('Usuário aceitou a instalação do PWA');
                    } else {
                        console.log('Usuário recusou a instalação do PWA');
                    }
                    deferredPrompt = null;
                    installButton.classList.add('hidden');
                });
            }
        });

        // Detect iOS and show install banner
        function isIOS() {
            return [
                'iPad Simulator',
                'iPhone Simulator',
                'iPod Simulator',
                'iPad',
                'iPhone',
                'iPod'
            ].includes(navigator.platform)
            || (navigator.userAgent.includes('Mac') && 'ontouchend' in document);
        }

        function isPWAInstalled() {
            return (window.matchMedia('(display-mode: standalone)').matches) || (window.navigator.standalone);
        }

        if (isIOS() && !isPWAInstalled()) {
            iosInstallBanner.style.display = 'block';
        }

        closeIosInstallBanner.addEventListener('click', () => {
            iosInstallBanner.style.display = 'none';
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js')
      .then(reg => {
        console.log('Service Worker registrado:', reg.scope);
        
        // Verifica atualizações a cada hora
        setInterval(() => reg.update(), 60 * 60 * 1000);
        
        // Força atualização quando a página ganha foco
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden) reg.update();
        });
      })
      .catch(err => console.error('Falha no registro:', err));
  });
}
        // Online/Offline Status Indicator
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            if (isOnline) {
                showMessage("Você está online!", 'success', 2000);
                // Trigger data sync if there's offline data pending
                if (currentUser && !currentUser.isAnonymous && localStorage.getItem('offlineBudgets')) {
                    syncLocalData();
                }
            } else {
                showMessage("Você está offline. Os dados serão sincronizados quando a conexão for restabelecida.", 'warning', 5000);
            }
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        // Sync local data with Firestore
        async function syncLocalData() {
            if (!currentUser || currentUser.isAnonymous) {
                console.warn("Não é possível sincronizar dados para um usuário anônimo ou não logado.");
                return;
            }

            const offlineData = JSON.parse(localStorage.getItem('offlineBudgets') || '{}');
            if (Object.keys(offlineData).length === 0) {
                console.log("Nenhum dado offline para sincronizar.");
                return;
            }

            showSyncStatus('Sincronizando dados...');
            try {
                for (const budgetId in offlineData) {
                    if (offlineData.hasOwnProperty(budgetId)) {
                        const budgetChanges = offlineData[budgetId];
                        const budgetRef = doc(db, `budgets/${budgetId}`);
                        const userBudgetRef = doc(db, `users/${currentUser.uid}/budgets/${budgetId}`);

                        // Sync budget details
                        if (budgetChanges.details) {
                            await setDoc(budgetRef, budgetChanges.details, { merge: true });
                            await setDoc(userBudgetRef, true, { merge: true }); // Ensure user is linked to budget
                        }

                        // Sync transactions
                        for (const txId in budgetChanges.transactions) {
                            const tx = budgetChanges.transactions[txId];
                            const txRef = doc(db, `budgets/${budgetId}/transactions/${txId}`);
                            await setDoc(txRef, tx, { merge: true });
                        }

                        // Sync categories
                        for (const catId in budgetChanges.categories) {
                            const cat = budgetChanges.categories[catId];
                            const catRef = doc(db, `budgets/${budgetId}/categories/${catId}`);
                            await setDoc(catRef, cat, { merge: true });
                        }

                        // Sync goals
                        for (const goalId in budgetChanges.goals) {
                            const goal = budgetChanges.goals[goalId];
                            const goalRef = doc(db, `budgets/${budgetId}/goals/${goalId}`);
                            await setDoc(goalRef, goal, { merge: true });
                        }
                    }
                }
                localStorage.removeItem('offlineBudgets');
                showMessage('Dados sincronizados com sucesso!', 'success');
            } catch (e) {
                console.error("Erro ao sincronizar dados offline:", e);
                showMessage('Erro ao sincronizar dados offline. Tente novamente.', 'error');
            } finally {
                hideSyncStatus();
                loadBudgetState(); // Reload data after sync
            }
        }

        function getOfflineData(budgetId) {
            const offlineData = JSON.parse(localStorage.getItem('offlineBudgets') || '{}');
            if (!offlineData[budgetId]) {
                offlineData[budgetId] = { details: {}, transactions: {}, categories: {}, goals: {} };
            }
            return offlineData[budgetId];
        }

        function saveOfflineData(budgetId, type, id, data) {
            if (isOnline) return; // Only save offline if truly offline
            const offlineData = JSON.parse(localStorage.getItem('offlineBudgets') || '{}');
            if (!offlineData[budgetId]) {
                offlineData[budgetId] = { details: {}, transactions: {}, categories: {}, goals: {} };
            }
            if (type === 'budget') {
                offlineData[budgetId].details = { ...offlineData[budgetId].details, ...data };
            } else {
                offlineData[budgetId][type][id] = { ...offlineData[budgetId][type][id], ...data };
            }
            localStorage.setItem('offlineBudgets', JSON.stringify(offlineData));
            showSyncStatus('Dados salvos offline');
        }

        function deleteOfflineData(budgetId, type, id) {
            if (isOnline) return;
            const offlineData = JSON.parse(localStorage.getItem('offlineBudgets') || '{}');
            if (offlineData[budgetId] && offlineData[budgetId][type]) {
                delete offlineData[budgetId][type][id];
                localStorage.setItem('offlineBudgets', JSON.stringify(offlineData));
                showSyncStatus('Item removido offline');
            }
        }

        // UI Feedback Functions
        function showMessage(message, type = 'info', duration = 3000) {
            const alert = document.createElement('div');
            alert.className = `p-3 rounded-lg shadow-md mb-2 text-white text-center animate-fade-in-down`;
            if (type === 'success') alert.classList.add('bg-green-500');
            else if (type === 'error') alert.classList.add('bg-red-500');
            else if (type === 'warning') alert.classList.add('bg-yellow-500');
            else alert.classList.add('bg-blue-500');
            alert.textContent = message;
            messageContainer.appendChild(alert);

            setTimeout(() => {
                alert.classList.add('animate-fade-out-up');
                alert.addEventListener('animationend', () => alert.remove());
            }, duration);
        }

        function showLoading(text = 'Carregando...') {
            loadingText.textContent = text;
            customLoading.style.display = 'flex';
        }

        function hideLoading() {
            customLoading.style.display = 'none';
        }

        function showSyncStatus(message) {
            syncMessage.textContent = message;
            syncStatus.classList.remove('hidden');
        }

        function hideSyncStatus() {
            syncStatus.classList.add('hidden');
        }

        // Modal Functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Dark Mode Toggle
        darkModeToggle.addEventListener('change', () => {
            if (darkModeToggle.checked) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.removeItem('theme');
            }
        });

        // Apply saved theme on load
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            darkModeToggle.checked = true;
        } else {
            darkModeToggle.checked = false;
        }

        // Authentication and UI Update
        async function updateAuthUI(user) {
            if (user) {
                currentUser = { uid: user.uid, email: user.email, displayName: user.displayName, isAnonymous: user.isAnonymous };
                currentUserDisplay.textContent = user.isAnonymous ? "Anônimo" : (user.displayName || user.email);

                // Verifica se usuário tem algum orçamento
                const userBudgetsCollectionRef = collection(db, `users/${user.uid}/budgets`);
                const budgetsSnapshot = await getDocs(userBudgetsCollectionRef); // Usa getDocs para coleções

                if (budgetsSnapshot.empty) {
                    // Cria orçamento padrão
                    const defaultBudgetId = doc(collection(db, 'budgets')).id; // Gera um ID para o novo documento de orçamento
                    const budgetRef = doc(db, `budgets/${defaultBudgetId}`); // Referência para o documento do orçamento principal

                    await setDoc(budgetRef, {
                        name: "Meu Orçamento Principal",
                        owner: user.uid,
                        createdAt: serverTimestamp()
                    });
                    
                    // Vincula o orçamento ao usuário
                    const userBudgetDocRef = doc(db, `users/${user.uid}/budgets/${defaultBudgetId}`);
                    await setDoc(userBudgetDocRef, { active: true }); // Salva um documento simples vinculando

                    activeBudgetId = defaultBudgetId;
                    showMessage("Orçamento padrão criado automaticamente!", 'success');
                } else {
                    // Usa o primeiro orçamento encontrado ou um marcado como ativo
                    // Você pode adicionar lógica mais complexa aqui para permitir que o usuário escolha ou alterne orçamentos
                    activeBudgetId = budgetsSnapshot.docs[0].id;
                }
                
                loadBudgetState(); // Carrega os dados para o orçamento ativo
            } else {
                // Not logged in, attempt anonymous login if no persistent user
                if (!localStorage.getItem('anonymousUserUID')) {
                    try {
                        const anonUserCredential = await signInAnonymously(auth);
                        localStorage.setItem('anonymousUserUID', anonUserCredential.user.uid);
                        currentUser = { uid: anonUserCredential.user.uid, isAnonymous: true };
                        currentUserDisplay.textContent = "Anônimo (offline)";
                        showMessage("Logado anonimamente. Faça login para salvar seus dados.", 'info', 5000);
                        // No budget loaded for anonymous users initially, they will create data locally
                        // If they log in later, syncLocalData will handle it.
                    } catch (error) {
                        console.error("Erro ao fazer login anônimo:", error);
                        showMessage("Não foi possível fazer login anônimo.", 'error');
                        currentUserDisplay.textContent = "Não Logado";
                    }
                } else {
                    // Re-use existing anonymous UID from local storage
                    currentUser = { uid: localStorage.getItem('anonymousUserUID'), isAnonymous: true };
                    currentUserDisplay.textContent = "Anônimo (offline)";
                    showMessage("Você está offline. Faça login para salvar seus dados.", 'info', 5000);
                }
                 // For anonymous users, we might load a default local budget state or
                 // indicate that no budget is active for persistent storage.
                 // For now, we'll just not load from Firestore.
                 transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
                 categories = JSON.parse(localStorage.getItem('categories') || '{}');
                 goals = JSON.parse(localStorage.getItem('goals') || '[]');
                 calculateSummary();
                 displayTransactions();
                 displayCategories();
                 displayGoals();
            }
            hideLoading();
        }


        // Load initial budget state from Firestore or local storage
        async function loadBudgetState() {
            if (!currentUser) {
                console.warn("Nenhum usuário logado. Não é possível carregar o estado do orçamento.");
                return;
            }

            if (!activeBudgetId) {
                console.warn("Nenhum activeBudgetId definido. Não é possível carregar o estado do orçamento.");
                // This might happen if an anonymous user hasn't created a budget yet.
                // Or if there's an issue with initial budget creation for new authenticated users.
                // The updateAuthUI function should handle setting activeBudgetId.
                hideLoading();
                return;
            }

            showLoading('Carregando dados...');
            try {
                // Listener para o orçamento principal (para o limite mensal)
                onSnapshot(doc(db, `budgets/${activeBudgetId}`), (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        const budgetData = docSnapshot.data();
                        monthlyBudgetInput.value = (budgetData.monthlyBudget || 0).toFixed(2);
                        calculateSummary(); // Recalcula o resumo com o novo orçamento
                        saveOfflineData(activeBudgetId, 'budget', 'details', budgetData);
                    } else {
                        console.warn("Documento de orçamento principal não encontrado.");
                        monthlyBudgetInput.value = "0.00";
                        calculateSummary();
                    }
                }, (error) => {
                    console.error("Erro ao carregar orçamento principal:", error);
                    if (error.code === 'permission-denied') {
                        showMessage("Você não tem permissão para acessar este orçamento.", 'error');
                    } else {
                        showMessage("Erro ao carregar orçamento.", 'error');
                    }
                });

                listenToTransactions();
                listenToCategories();
                listenToGoals();

            } catch (error) {
                console.error("Erro ao carregar o estado do orçamento:", error);
                showMessage("Erro ao carregar o estado do orçamento. Verifique sua conexão ou permissões.", 'error');
                hideLoading();
            }
        }


        // Firestore Listeners
        function listenToTransactions() {
            if (transactionsUnsubscribe) {
                transactionsUnsubscribe();
            }
            
            showLoading('Carregando transações...');
            transactionsUnsubscribe = onSnapshot(
                query(collection(db, `budgets/${activeBudgetId}/transactions`), orderBy('timestamp', 'desc')),
                (snapshot) => {
                    // Sucesso
                    transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    displayTransactions();
                    calculateSummary();
                    hideLoading();
                },
                (error) => {
                    console.error("Erro ao carregar transações:", error);
                    if (error.code === 'permission-denied') {
                        showMessage("Você não tem permissão para ver estas transações", 'error');
                    } else {
                        showMessage("Erro ao carregar transações", 'error');
                    }
                    hideLoading();
                }
            );
        }

        function listenToCategories() {
            if (categoriesUnsubscribe) {
                categoriesUnsubscribe();
            }
            showLoading('Carregando categorias...');
            categoriesUnsubscribe = onSnapshot(
                query(collection(db, `budgets/${activeBudgetId}/categories`), orderBy('name')),
                (snapshot) => {
                    categories = {};
                    snapshot.docs.forEach(doc => {
                        categories[doc.id] = { id: doc.id, ...doc.data() };
                    });
                    displayCategories();
                    populateCategorySelects();
                    calculateSummary();
                    hideLoading();
                },
                (error) => {
                    console.error("Erro ao carregar categorias:", error);
                    if (error.code === 'permission-denied') {
                        showMessage("Você não tem permissão para ver estas categorias", 'error');
                    } else {
                        showMessage("Erro ao carregar categorias", 'error');
                    }
                    hideLoading();
                }
            );
        }

        function listenToGoals() {
            if (goalsUnsubscribe) {
                goalsUnsubscribe();
            }
            showLoading('Carregando metas...');
            goalsUnsubscribe = onSnapshot(
                query(collection(db, `budgets/${activeBudgetId}/goals`), orderBy('targetDate')),
                (snapshot) => {
                    goals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    displayGoals();
                    hideLoading();
                },
                (error) => {
                    console.error("Erro ao carregar metas:", error);
                    if (error.code === 'permission-denied') {
                        showMessage("Você não tem permissão para ver estas metas", 'error');
                    } else {
                        showMessage("Erro ao carregar metas", 'error');
                    }
                    hideLoading();
                }
            );
        }


        // CRUD Operations
        async function addTransaction(description, amount, type, categoryId, isRecurring, nextDueDate) {
            showLoading('Adicionando transação...');
            try {
                if (!activeBudgetId) {
                    showMessage("Erro: Nenhum orçamento ativo selecionado. Tente fazer login ou recarregar.", 'error');
                    hideLoading();
                    return;
                }
                const newTransactionRef = doc(collection(db, `budgets/${activeBudgetId}/transactions`));
                const transactionData = {
                    description: description,
                    amount: parseFloat(amount),
                    type: type,
                    categoryId: categoryId,
                    categoryName: categories[categoryId]?.name || 'Sem Categoria',
                    timestamp: serverTimestamp(),
                    isRecorrente: isRecurring || false,
                    proximoVencimento: isRecurring ? (nextDueDate || null) : null
                };
                await setDoc(newTransactionRef, transactionData);
                showMessage('Transação adicionada com sucesso!', 'success');
                transactionForm.reset();
                transactionNextDueDateInput.style.display = 'none';
                transactionNextDueDateInput.required = false;
            } catch (error) {
                console.error("Erro ao adicionar transação:", error);
                if (error.code === 'permission-denied') {
                    showMessage("Você não tem permissão para adicionar transações.", 'error');
                } else {
                    showMessage("Erro ao adicionar transação. Tente novamente.", 'error');
                }
            } finally {
                hideLoading();
            }
        }

        async function updateTransaction(id, description, amount, type, categoryId, isRecurring, nextDueDate) {
            showLoading('Atualizando transação...');
            try {
                if (!activeBudgetId) {
                    showMessage("Erro: Nenhum orçamento ativo selecionado.", 'error');
                    hideLoading();
                    return;
                }
                const transactionRef = doc(db, `budgets/${activeBudgetId}/transactions/${id}`);
                await updateDoc(transactionRef, {
                    description: description,
                    amount: parseFloat(amount),
                    type: type,
                    categoryId: categoryId,
                    categoryName: categories[categoryId]?.name || 'Sem Categoria',
                    isRecorrente: isRecurring || false,
                    proximoVencimento: isRecurring ? (nextDueDate || null) : null
                });
                showMessage('Transação atualizada com sucesso!', 'success');
                hideModal('editTransactionModal');
            } catch (error) {
                console.error("Erro ao atualizar transação:", error);
                if (error.code === 'permission-denied') {
                    showMessage("Você não tem permissão para atualizar esta transação.", 'error');
                } else {
                    showMessage("Erro ao atualizar transação. Tente novamente.", 'error');
                }
            } finally {
                hideLoading();
            }
        }

        async function deleteTransaction(id) {
            if (!confirm('Tem certeza que deseja excluir esta transação?')) return;
            showLoading('Excluindo transação...');
            try {
                if (!activeBudgetId) {
                    showMessage("Erro: Nenhum orçamento ativo selecionado.", 'error');
                    hideLoading();
                    return;
                }
                const transactionRef = doc(db, `budgets/${activeBudgetId}/transactions/${id}`);
                await deleteDoc(transactionRef);
                showMessage('Transação excluída com sucesso!', 'success');
                hideModal('editTransactionModal');
            } catch (error) {
                console.error("Erro ao excluir transação:", error);
                if (error.code === 'permission-denied') {
                    showMessage("Você não tem permissão para excluir esta transação.", 'error');
                } else {
                    showMessage("Erro ao excluir transação. Tente novamente.", 'error');
                }
            } finally {
                hideLoading();
            }
        }

        async function addCategory(name, type, limit) {
            showLoading('Adicionando categoria...');
            try {
                if (!activeBudgetId) {
                    showMessage("Erro: Nenhum orçamento ativo selecionado.", 'error');
                    hideLoading();
                    return;
                }
                const newCategoryRef = doc(collection(db, `budgets/${activeBudgetId}/categories`));
                await setDoc(newCategoryRef, {
                    name: name,
                    type: type,
                    limit: parseFloat(limit) || 0,
                    createdAt: serverTimestamp()
                });
                showMessage('Categoria adicionada com sucesso!', 'success');
                categoryForm.reset();
            } catch (error) {
                console.error("Erro ao adicionar categoria:", error);
                if (error.code === 'permission-denied') {
                    showMessage("Você não tem permissão para adicionar categorias.", 'error');
                } else {
                    showMessage("Erro ao adicionar categoria. Tente novamente.", 'error');
                }
            } finally {
                hideLoading();
            }
        }

        async function updateCategory(id, name, type, limit) {
            showLoading('Atualizando categoria...');
            try {
                if (!activeBudgetId) {
                    showMessage("Erro: Nenhum orçamento ativo selecionado.", 'error');
                    hideLoading();
                    return;
                }
                const categoryRef = doc(db, `budgets/${activeBudgetId}/categories/${id}`);
                await updateDoc(categoryRef, {
                    name: name,
                    type: type,
                    limit: parseFloat(limit) || 0
                });
                showMessage('Categoria atualizada com sucesso!', 'success');
                hideModal('editCategoryModal');
            } catch (error) {
                console.error("Erro ao atualizar categoria:", error);
                if (error.code === 'permission-denied') {
                    showMessage("Você não tem permissão para atualizar esta categoria.", 'error');
                } else {
                    showMessage("Erro ao atualizar categoria. Tente novamente.", 'error');
                }
            } finally {
                hideLoading();
            }
        }

        async function deleteCategory(id) {
            if (!confirm('Tem certeza que deseja excluir esta categoria? Todas as transações associadas serão afetadas.')) return;
            showLoading('Excluindo categoria...');
            try {
                if (!activeBudgetId) {
                    showMessage("Erro: Nenhum orçamento ativo selecionado.", 'error');
                    hideLoading();
                    return;
                }
                // Update transactions associated with this category
                const batch = writeBatch(db);
                const transactionsToUpdate = transactions.filter(tx => tx.categoryId === id);
                transactionsToUpdate.forEach(tx => {
                    const txRef = doc(db, `budgets/${activeBudgetId}/transactions/${tx.id}`);
                    batch.update(txRef, { categoryId: null, categoryName: 'Sem Categoria' });
                });

                const categoryRef = doc(db, `budgets/${activeBudgetId}/categories/${id}`);
                batch.delete(categoryRef);
                
                await batch.commit();
                showMessage('Categoria excluída com sucesso!', 'success');
                hideModal('editCategoryModal');
            } catch (error) {
                console.error("Erro ao excluir categoria:", error);
                if (error.code === 'permission-denied') {
                    showMessage("Você não tem permissão para excluir esta categoria.", 'error');
                } else {
                    showMessage("Erro ao excluir categoria. Tente novamente.", 'error');
                }
            } finally {
                hideLoading();
            }
        }

        async function addGoal(name, amount, targetDate) {
            showLoading('Adicionando meta...');
            try {
                if (!activeBudgetId) {
                    showMessage("Erro: Nenhum orçamento ativo selecionado.", 'error');
                    hideLoading();
                    return;
                }
                const newGoalRef = doc(collection(db, `budgets/${activeBudgetId}/goals`));
                await setDoc(newGoalRef, {
                    name: name,
                    amount: parseFloat(amount),
                    targetDate: targetDate,
                    currentAmount: 0,
                    createdAt: serverTimestamp()
                });
                showMessage('Meta adicionada com sucesso!', 'success');
                goalForm.reset();
            } catch (error) {
                console.error("Erro ao adicionar meta:", error);
                if (error.code === 'permission-denied') {
                    showMessage("Você não tem permissão para adicionar metas.", 'error');
                } else {
                    showMessage("Erro ao adicionar meta. Tente novamente.", 'error');
                }
            } finally {
                hideLoading();
            }
        }

        async function updateGoal(id, name, amount, targetDate, currentAmount) {
            showLoading('Atualizando meta...');
            try {
                if (!activeBudgetId) {
                    showMessage("Erro: Nenhum orçamento ativo selecionado.", 'error');
                    hideLoading();
                    return;
                }
                const goalRef = doc(db, `budgets/${activeBudgetId}/goals/${id}`);
                await updateDoc(goalRef, {
                    name: name,
                    amount: parseFloat(amount),
                    targetDate: targetDate,
                    currentAmount: parseFloat(currentAmount) // Ensure currentAmount is updated as well
                });
                showMessage('Meta atualizada com sucesso!', 'success');
                hideModal('editGoalModal');
            } catch (error) {
                console.error("Erro ao atualizar meta:", error);
                if (error.code === 'permission-denied') {
                    showMessage("Você não tem permissão para atualizar esta meta.", 'error');
                } else {
                    showMessage("Erro ao atualizar meta. Tente novamente.", 'error');
                }
            } finally {
                hideLoading();
            }
        }

        async function deleteGoal(id) {
            if (!confirm('Tem certeza que deseja excluir esta meta?')) return;
            showLoading('Excluindo meta...');
            try {
                if (!activeBudgetId) {
                    showMessage("Erro: Nenhum orçamento ativo selecionado.", 'error');
                    hideLoading();
                    return;
                }
                const goalRef = doc(db, `budgets/${activeBudgetId}/goals/${id}`);
                await deleteDoc(goalRef);
                showMessage('Meta excluída com sucesso!', 'success');
                hideModal('editGoalModal');
            } catch (error) {
                console.error("Erro ao excluir meta:", error);
                if (error.code === 'permission-denied') {
                    showMessage("Você não tem permissão para excluir esta meta.", 'error');
                } else {
                    showMessage("Erro ao excluir meta. Tente novamente.", 'error');
                }
            } finally {
                hideLoading();
            }
        }

        // Display Functions
        function displayTransactions(filter = '') {
            transactionsList.innerHTML = '';
            transactionsListSkeleton.style.display = 'none';

            const filteredTransactions = transactions.filter(tx => 
                tx.description.toLowerCase().includes(filter.toLowerCase()) ||
                tx.categoryName.toLowerCase().includes(filter.toLowerCase())
            );

            if (filteredTransactions.length === 0) {
                transactionsList.innerHTML = `<li class="p-3 text-center text-gray-500 dark:text-gray-400">Nenhuma transação encontrada.</li>`;
                return;
            }

            filteredTransactions.forEach(tx => {
                const li = document.createElement('li');
                li.className = 'p-3 flex items-center justify-between bg-white dark:bg-gray-700 rounded-lg shadow-sm mb-2 transaction-item';
                li.innerHTML = `
                    <div class="flex-1 transaction-info">
                        <p class="font-semibold text-gray-800 dark:text-gray-200">${tx.description}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">
                            ${new Date(tx.timestamp.toDate ? tx.timestamp.toDate() : tx.timestamp).toLocaleDateString()}
                            ${tx.categoryName ? ` - ${tx.categoryName}` : ''}
                            ${tx.isRecorrente ? `<span class="ml-2 px-2 py-0.5 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">Recorrente</span>` : ''}
                            ${tx.proximoVencimento ? `<span class="ml-2 px-2 py-0.5 bg-yellow-100 text-yellow-800 text-xs font-medium rounded-full">Vence: ${new Date(tx.proximoVencimento).toLocaleDateString()}</span>` : ''}
                        </p>
                    </div>
                    <div class="flex items-center">
                        <span class="amount font-bold ${tx.type === 'revenue' ? 'text-green-600' : 'text-red-600'}">
                            R$ ${tx.amount.toFixed(2).replace('.', ',')}
                        </span>
                        <button class="ml-3 text-primary hover:text-primary-dark edit-btn" data-id="${tx.id}" onclick="showEditTransactionModal('${tx.id}')">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.38-2.827-2.828z" />
                            </svg>
                        </button>
                    </div>
                `;
                transactionsList.appendChild(li);
            });
        }

        function displayCategories(filter = '') {
            categoriesList.innerHTML = '';
            categoriesListSkeleton.style.display = 'none';

            const filteredCategories = Object.values(categories).filter(cat => 
                cat.name.toLowerCase().includes(filter.toLowerCase()) ||
                cat.type.toLowerCase().includes(filter.toLowerCase())
            );

            if (filteredCategories.length === 0) {
                categoriesList.innerHTML = `<li class="p-3 text-center text-gray-500 dark:text-gray-400">Nenhuma categoria encontrada.</li>`;
                return;
            }

            filteredCategories.forEach(cat => {
                const li = document.createElement('li');
                li.className = 'p-3 flex items-center justify-between bg-white dark:bg-gray-700 rounded-lg shadow-sm mb-2';
                li.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800 dark:text-gray-200">${cat.name}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">${cat.type === 'revenue' ? 'Receita' : 'Despesa'} ${cat.limit > 0 ? `(Limite: R$ ${cat.limit.toFixed(2).replace('.', ',')})` : ''}</p>
                    </div>
                    <button class="ml-3 text-primary hover:text-primary-dark edit-btn" data-id="${cat.id}" onclick="showEditCategoryModal('${cat.id}')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.38-2.827-2.828z" />
                        </svg>
                    </button>
                `;
                categoriesList.appendChild(li);
            });
        }

        function displayGoals() {
            goalsList.innerHTML = '';
            goalsListSkeleton.style.display = 'none';

            if (goals.length === 0) {
                goalsList.innerHTML = `<li class="p-3 text-center text-gray-500 dark:text-gray-400">Nenhuma meta adicionada.</li>`;
                return;
            }

            goals.forEach(goal => {
                const progress = (goal.currentAmount / goal.amount) * 100;
                const li = document.createElement('li');
                li.className = 'p-3 bg-white dark:bg-gray-700 rounded-lg shadow-sm mb-2';
                li.innerHTML = `
                    <div class="flex justify-between items-center">
                        <p class="font-semibold text-gray-800 dark:text-gray-200">${goal.name}</p>
                        <button class="ml-3 text-primary hover:text-primary-dark edit-btn" data-id="${goal.id}" onclick="showEditGoalModal('${goal.id}')">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.38-2.827-2.828z" />
                            </svg>
                        </button>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Alvo: R$ ${goal.amount.toFixed(2).replace('.', ',')} | Contribuído: R$ ${goal.currentAmount.toFixed(2).replace('.', ',')}</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-600 mt-2">
                        <div class="h-2.5 rounded-full bg-blue-500 progress-bar" style="width: ${progress > 100 ? 100 : progress}%"></div>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Progresso: ${progress.toFixed(2)}% ${goal.targetDate ? `(Até: ${new Date(goal.targetDate).toLocaleDateString()})` : ''}</p>
                `;
                goalsList.appendChild(li);
            });
        }

        function populateCategorySelects() {
            const optionsHtml = Object.keys(categories).map(id => {
                const category = categories[id];
                return `<option value="${id}">${category.name} (${category.type === 'revenue' ? 'Receita' : 'Despesa'})</option>`;
            }).join('');

            transactionCategorySelect.innerHTML = '<option value="">Selecione uma Categoria</option>' + optionsHtml;
            editTransactionCategorySelect.innerHTML = '<option value="">Selecione uma Categoria</option>' + optionsHtml;
        }

        // Summary Calculations
        function calculateSummary() {
            let totalRevenue = 0;
            let totalExpense = 0;
            let monthlyBudget = parseFloat(monthlyBudgetInput.value) || 0;

            transactions.forEach(tx => {
                if (tx.type === 'revenue') {
                    totalRevenue += tx.amount;
                } else {
                    totalExpense += tx.amount;
                }
            });

            const currentBalance = totalRevenue - totalExpense;
            const remainingBudget = monthlyBudget - totalExpense; // Assumindo que o orçamento é para despesas

            totalRevenueEl.textContent = `R$ ${totalRevenue.toFixed(2).replace('.', ',')}`;
            totalExpenseEl.textContent = `R$ ${totalExpense.toFixed(2).replace('.', ',')}`;
            currentBalanceEl.textContent = `R$ ${currentBalance.toFixed(2).replace('.', ',')}`;
            currentBalanceEl.classList.remove('text-green-600', 'text-red-600', 'text-blue-600');
            if (currentBalance >= 0) {
                currentBalanceEl.classList.add('text-blue-600');
            } else {
                currentBalanceEl.classList.add('text-red-600');
            }

            if (monthlyBudget > 0) {
                monthlyBudgetProgressContainer.classList.remove('hidden');
                remainingBudgetEl.textContent = `R$ ${remainingBudget.toFixed(2).replace('.', ',')}`;
                monthlySpentEl.textContent = `R$ ${totalExpense.toFixed(2).replace('.', ',')}`;
                monthlyRemainingEl.textContent = `R$ ${remainingBudget.toFixed(2).replace('.', ',')}`;

                const progressPercentage = (totalExpense / monthlyBudget) * 100;
                monthlyProgressBar.style.width = `${Math.min(100, progressPercentage)}%`;
                
                monthlyProgressBar.classList.remove('bg-primary', 'bg-yellow-500', 'bg-red-500');
                if (progressPercentage < 70) {
                    monthlyProgressBar.classList.add('bg-primary');
                } else if (progressPercentage < 90) {
                    monthlyProgressBar.classList.add('bg-yellow-500');
                } else {
                    monthlyProgressBar.classList.add('bg-red-500');
                }

                remainingBudgetEl.classList.remove('text-green-600', 'text-red-600', 'text-purple-600');
                if (remainingBudget >= 0) {
                    remainingBudgetEl.classList.add('text-purple-600');
                } else {
                    remainingBudgetEl.classList.add('text-red-600');
                }

            } else {
                monthlyBudgetProgressContainer.classList.add('hidden');
                remainingBudgetEl.textContent = `R$ 0.00`;
                remainingBudgetEl.classList.add('text-purple-600');
            }
            updateCharts();
        }

        // Chart.js Functions
        function createOrUpdateChart(chartId, type, data, options) {
            const ctx = document.getElementById(chartId).getContext('2d');
            if (chartInstances[chartId]) {
                chartInstances[chartId].destroy();
            }
            chartInstances[chartId] = new Chart(ctx, {
                type: type,
                data: data,
                options: options
            });
        }

        function updateCharts() {
            // Category Distribution Chart
            const categoryData = {};
            transactions.forEach(tx => {
                if (tx.type === 'expense') { // Foco em despesas para o orçamento
                    categoryData[tx.categoryName] = (categoryData[tx.categoryName] || 0) + tx.amount;
                }
            });

            const categoryLabels = Object.keys(categoryData);
            const categoryValues = Object.values(categoryData);
            const categoryColors = categoryLabels.map((_, i) => `hsl(${i * 60 % 360}, 70%, 50%)`);

            createOrUpdateChart('category-chart', 'pie', {
                labels: categoryLabels,
                datasets: [{
                    data: categoryValues,
                    backgroundColor: categoryColors,
                    hoverOffset: 4
                }]
            }, {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Despesas por Categoria',
                        color: document.documentElement.classList.contains('dark') ? '#E5E7EB' : '#1F2937'
                    },
                    legend: {
                        labels: {
                            color: document.documentElement.classList.contains('dark') ? '#D1D5DB' : '#4B5563'
                        }
                    }
                }
            });

            // Transaction Type Distribution Chart (Revenue vs Expense)
            const typeData = { 'Receita': 0, 'Despesa': 0 };
            transactions.forEach(tx => {
                if (tx.type === 'revenue') {
                    typeData['Receita'] += tx.amount;
                } else {
                    typeData['Despesa'] += tx.amount;
                }
            });

            createOrUpdateChart('transaction-type-chart', 'bar', {
                labels: ['Receita', 'Despesa'],
                datasets: [{
                    label: 'Valores',
                    data: [typeData['Receita'], typeData['Despesa']],
                    backgroundColor: ['#10B981', '#EF4444'],
                    borderColor: ['#047857', '#B91C1C'],
                    borderWidth: 1
                }]
            }, {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Receitas vs Despesas',
                        color: document.documentElement.classList.contains('dark') ? '#E5E7EB' : '#1F2937'
                    },
                    legend: {
                        display: false // Hide legend for this simple bar chart
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: document.documentElement.classList.contains('dark') ? '#D1D5DB' : '#4B5563'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: document.documentElement.classList.contains('dark') ? '#D1D5DB' : '#4B5563',
                            callback: function(value) {
                                return 'R$ ' + value.toFixed(2).replace('.', ',');
                            }
                        }
                    }
                }
            });
        }


        // Event Listeners
        transactionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const description = document.getElementById('transaction-description').value;
            const amount = document.getElementById('transaction-amount').value;
            const type = document.getElementById('transaction-type').value;
            const categoryId = document.getElementById('transaction-category').value;
            const isRecurring = transactionIsRecurringCheckbox.checked;
            const nextDueDate = transactionNextDueDateInput.value;
            
            if (!categoryId) {
                showMessage("Por favor, selecione uma categoria.", 'warning');
                return;
            }
            if (isRecurring && !nextDueDate) {
                showMessage("Por favor, insira a próxima data de vencimento para transações recorrentes.", 'warning');
                return;
            }
            await addTransaction(description, amount, type, categoryId, isRecurring, nextDueDate);
        });

        transactionIsRecurringCheckbox.addEventListener('change', () => {
            if (transactionIsRecurringCheckbox.checked) {
                transactionNextDueDateInput.style.display = 'block';
                transactionNextDueDateInput.required = true;
            } else {
                transactionNextDueDateInput.style.display = 'none';
                transactionNextDueDateInput.required = false;
                transactionNextDueDateInput.value = '';
            }
        });

        editTransactionIsRecurringCheckbox.addEventListener('change', () => {
            if (editTransactionIsRecurringCheckbox.checked) {
                editTransactionNextDueDateInput.style.display = 'block';
                editTransactionNextDueDateInput.required = true;
            } else {
                editTransactionNextDueDateInput.style.display = 'none';
                editTransactionNextDueDateInput.required = false;
                editTransactionNextDueDateInput.value = '';
            }
        });

        saveTransactionEditBtn.addEventListener('click', async () => {
            const id = editTransactionIdInput.value;
            const description = editTransactionDescriptionInput.value;
            const amount = editTransactionAmountInput.value;
            const type = editTransactionTypeSelect.value;
            const categoryId = editTransactionCategorySelect.value;
            const isRecurring = editTransactionIsRecurringCheckbox.checked;
            const nextDueDate = editTransactionNextDueDateInput.value;

            if (!categoryId) {
                showMessage("Por favor, selecione uma categoria.", 'warning');
                return;
            }
            if (isRecurring && !nextDueDate) {
                showMessage("Por favor, insira a próxima data de vencimento para transações recorrentes.", 'warning');
                return;
            }
            await updateTransaction(id, description, amount, type, categoryId, isRecurring, nextDueDate);
        });

        deleteTransactionBtn.addEventListener('click', async () => {
            const id = editTransactionIdInput.value;
            await deleteTransaction(id);
        });

        categoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('category-name').value;
            const type = document.getElementById('category-type').value;
            const limit = document.getElementById('category-limit').value;
            await addCategory(name, type, limit);
        });

        saveCategoryEditBtn.addEventListener('click', async () => {
            const id = editCategoryIdInput.value;
            const name = editCategoryNameInput.value;
            const type = editCategoryTypeSelect.value;
            const limit = editCategoryLimitInput.value;
            await updateCategory(id, name, type, limit);
        });

        deleteCategoryBtn.addEventListener('click', async () => {
            const id = editCategoryIdInput.value;
            await deleteCategory(id);
        });

        goalForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('goal-name').value;
            const amount = document.getElementById('goal-amount').value;
            const targetDate = document.getElementById('goal-target-date').value;
            await addGoal(name, amount, targetDate);
        });

        saveGoalEditBtn.addEventListener('click', async () => {
            const id = editGoalIdInput.value;
            const name = editGoalNameInput.value;
            const amount = editGoalAmountInput.value;
            const targetDate = editGoalTargetDateInput.value;
            // For goals, we might need to get the currentAmount from the existing goal object
            const existingGoal = goals.find(g => g.id === id);
            const currentAmount = existingGoal ? existingGoal.currentAmount : 0; 
            await updateGoal(id, name, amount, targetDate, currentAmount);
        });

        deleteGoalBtn.addEventListener('click', async () => {
            const id = editGoalIdInput.value;
            await deleteGoal(id);
        });


        setBudgetBtn.addEventListener('click', async () => {
            const monthlyBudget = parseFloat(monthlyBudgetInput.value) || 0;
            if (isNaN(monthlyBudget) || monthlyBudget < 0) {
                showMessage("Por favor, insira um valor de orçamento mensal válido.", 'warning');
                return;
            }
            showLoading('Definindo orçamento...');
            try {
                if (!activeBudgetId) {
                    showMessage("Erro: Nenhum orçamento ativo selecionado.", 'error');
                    hideLoading();
                    return;
                }
                const budgetRef = doc(db, `budgets/${activeBudgetId}`);
                await updateDoc(budgetRef, { monthlyBudget: monthlyBudget });
                showMessage('Orçamento mensal definido!', 'success');
            } catch (error) {
                console.error("Erro ao definir orçamento:", error);
                if (error.code === 'permission-denied') {
                    showMessage("Você não tem permissão para definir o orçamento.", 'error');
                } else {
                    showMessage("Erro ao definir orçamento. Tente novamente.", 'error');
                }
            } finally {
                hideLoading();
            }
        });

        transactionsSearchInput.addEventListener('input', (e) => {
            displayTransactions(e.target.value);
        });

        categoriesSearchInput.addEventListener('input', (e) => {
            displayCategories(e.target.value);
        });

        // Export to Excel
        exportExcelBtn.addEventListener('click', () => {
            const data = transactions.map(tx => ({
                Data: new Date(tx.timestamp.toDate ? tx.timestamp.toDate() : tx.timestamp).toLocaleDateString(),
                Descrição: tx.description,
                Valor: tx.amount,
                Tipo: tx.type === 'revenue' ? 'Receita' : 'Despesa',
                Categoria: tx.categoryName
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Transações");
            XLSX.writeFile(wb, "transacoes_financeiras.xlsx");
            showMessage('Transações exportadas para Excel!', 'success');
        });

        exportReportsBtn.addEventListener('click', () => {
            // Cria um novo workbook
            const wb = XLSX.utils.book_new();

            // Adiciona a aba de Transações
            const transactionDataForExport = transactions.map(tx => ({
                Data: new Date(tx.timestamp.toDate ? tx.timestamp.toDate() : tx.timestamp).toLocaleDateString(),
                Descrição: tx.description,
                Valor: tx.amount,
                Tipo: tx.type === 'revenue' ? 'Receita' : 'Despesa',
                Categoria: tx.categoryName
            }));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(transactionDataForExport), "Transações");

            // Adiciona a aba de Resumo (dados dos cards)
            const summaryData = [
                ["Item", "Valor"],
                ["Receita Total", totalRevenueEl.textContent],
                ["Despesa Total", totalExpenseEl.textContent],
                ["Saldo Atual", currentBalanceEl.textContent],
                ["Orçamento Restante", remainingBudgetEl.textContent]
            ];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summaryData), "Resumo");

            // Adiciona a aba de Categorias
            const categoryDataForExport = Object.values(categories).map(cat => ({
                Nome: cat.name,
                Tipo: cat.type === 'revenue' ? 'Receita' : 'Despesa',
                Limite: cat.limit
            }));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(categoryDataForExport), "Categorias");

            // Adiciona a aba de Metas
            const goalDataForExport = goals.map(goal => ({
                Nome: goal.name,
                "Valor Alvo": goal.amount,
                "Valor Atual": goal.currentAmount,
                "Data Alvo": new Date(goal.targetDate).toLocaleDateString()
            }));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(goalDataForExport), "Metas");

            // Escreve o arquivo Excel
            XLSX.writeFile(wb, "relatorios_financeiros.xlsx");
            showMessage('Relatórios exportados para Excel!', 'success');
        });


        // Modals for editing
        window.showEditTransactionModal = (id) => {
            const item = transactions.find(t => t.id === id);
            if (!item) return;
            editTransactionIdInput.value = item.id;
            editTransactionDescriptionInput.value = item.description;
            editTransactionAmountInput.value = item.amount;
            editTransactionTypeSelect.value = item.type;
            editTransactionCategorySelect.value = item.categoryId || ''; // handle null category
            editTransactionIsRecurringCheckbox.checked = item.isRecorrente || false;
            if (item.isRecorrente && item.proximoVencimento) {
                editTransactionNextDueDateInput.value = typeof item.proximoVencimento === 'string'
                    ? item.proximoVencimento.split('T')[0] // Ensure YYYY-MM-DD
                    : item.proximoVencimento instanceof Date
                        ? item.proximoVencimento.toISOString().split('T')[0]
                        : '';
                editTransactionNextDueDateInput.style.display = 'block';
                editTransactionNextDueDateInput.required = true;
            } else {
                editTransactionNextDueDateInput.value = '';
                editTransactionNextDueDateInput.style.display = 'none';
                editTransactionNextDueDateInput.required = false;
            }
            
            editTransactionModal.classList.remove('hidden');
        }

        function showEditCategoryModal(categoryId) {
            const category = categories[categoryId];
            if (!category) {
                showMessage("Categoria não encontrada para edição.", 'error');
                return;
            }
            editCategoryIdInput.value = category.id;
            editCategoryNameInput.value = category.name;
            editCategoryTypeSelect.value = category.type;
            editCategoryLimitInput.value = category.limit.toFixed(2);
            editCategoryModal.classList.remove('hidden');
        }

        function showEditGoalModal(goalId) {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) {
                showMessage("Meta não encontrada para edição.", 'error');
                return;
            }
            editGoalIdInput.value = goal.id;
            editGoalNameInput.value = goal.name;
            editGoalAmountInput.value = goal.amount;
            editGoalTargetDateInput.value = goal.targetDate; // Assuming it's already YYYY-MM-DD
            editGoalModal.classList.remove('hidden');
        }

        // Tab Navigation
        document.querySelectorAll('.bottom-nav-button').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.bottom-nav-button').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');

                const tab = this.dataset.tab;
                document.querySelectorAll('#tab-content section').forEach(section => {
                    section.classList.add('hidden');
                });
                document.getElementById(`${tab}-content`).classList.remove('hidden');

                if (tab === 'reports') {
                    updateCharts(); // Ensure charts are updated when reports tab is active
                }
            });
        });

        // Logout
        logoutBtn.addEventListener('click', async () => {
            if (!confirm('Tem certeza que deseja sair?')) return;
            showLoading('Saindo...');
            try {
                await signOut(auth);
                localStorage.removeItem('anonymousUserUID'); // Clear anonymous user on logout
                showMessage('Você foi desconectado.', 'success');
                // Clear all local data and re-initialize UI
                transactions = [];
                categories = {};
                goals = [];
                activeBudgetId = null;
                calculateSummary();
                displayTransactions();
                displayCategories();
                displayGoals();
                currentUserDisplay.textContent = "Não Logado";
                // Optionally sign in anonymously again after logout if desired
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Erro ao sair:", error);
                showMessage('Erro ao sair. Tente novamente.', 'error');
            } finally {
                hideLoading();
            }
        });

        // Sorting functionality
        document.querySelectorAll('.sortable-header').forEach(header => {
            header.addEventListener('click', () => {
                const sortField = header.dataset.sortField;
                let currentDirection = header.dataset.sortDirection || 'desc';
                const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
                
                // Reset other headers
                document.querySelectorAll('.sortable-header').forEach(h => {
                    if (h !== header) {
                        h.dataset.sortDirection = '';
                        h.querySelector('.sort-icon')?.classList.remove('asc', 'desc');
                    }
                });

                header.dataset.sortDirection = newDirection;
                const icon = header.querySelector('.sort-icon');
                if (icon) {
                    icon.classList.remove('asc', 'desc');
                    icon.classList.add(newDirection);
                }

                // Apply sorting
                if (header.closest('#transactions-content')) {
                    transactions.sort((a, b) => {
                        let valA = a[sortField];
                        let valB = b[sortField];

                        // Handle timestamp objects for sorting
                        if (sortField === 'timestamp' && valA && valB && valA.toDate && valB.toDate) {
                            valA = valA.toDate().getTime();
                            valB = valB.toDate().getTime();
                        } else if (typeof valA === 'string' && typeof valB === 'string') {
                            valA = valA.toLowerCase();
                            valB = valB.toLowerCase();
                        }

                        if (valA < valB) return newDirection === 'asc' ? -1 : 1;
                        if (valA > valB) return newDirection === 'asc' ? 1 : -1;
                        return 0;
                    });
                    displayTransactions(transactionsSearchInput.value);
                }
                // Add similar logic for categories and goals if they need sorting
            });
        });

        // Voice Recognition Setup
        function initVoiceRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                console.warn('Speech Recognition not supported in this browser.');
                // showMessage('Reconhecimento de voz não suportado neste navegador.', 'error');
                if (voiceInputBtn) voiceInputBtn.style.display = 'none';
                if (voiceCategoryBtn) voiceCategoryBtn.style.display = 'none';
                if (voiceEditCategoryBtn) voiceEditCategoryBtn.style.display = 'none';
                return;
            }

            const recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'pt-BR';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            const resetVoiceUI = () => {
                voiceFeedback.style.display = 'none';
                voiceFeedbackDetails.style.display = 'none';
                voiceFeedbackFields.innerHTML = '';
                if (voiceInputBtn) voiceInputBtn.classList.remove('listening');
                if (voiceCategoryBtn) voiceCategoryBtn.classList.remove('listening');
                if (voiceEditCategoryBtn) voiceEditCategoryBtn.classList.remove('listening');
                pendingVoiceCommand = null;
                currentVoiceCommandMode = null;
                isCategoryEditMode = false;
            };

            const parseTransactionCommand = (command) => {
                const descriptionMatch = command.match(/(?:adicionar|nova|comprar|pagar|receber)\s+(.+?)\s+de\s+(\d+[\.,]?\d*)\s+reais\s+como\s+(receita|despesa)(?:\s+na\s+categoria\s+(.+))?/i);
                if (descriptionMatch) {
                    let description = descriptionMatch[1].trim();
                    const amount = parseFloat(descriptionMatch[2].replace(',', '.'));
                    const type = descriptionMatch[3].toLowerCase();
                    let categoryName = descriptionMatch[4] ? descriptionMatch[4].trim() : '';

                    if (description.toLowerCase().startsWith('o ')) {
                        description = description.substring(2);
                    }
                    if (description.toLowerCase().startsWith('a ')) {
                        description = description.substring(2);
                    }
                    if (description.toLowerCase().endsWith(' como')) {
                        description = description.substring(0, description.length - 5);
                    }

                    return { description, amount, type, categoryName };
                }
                return null;
            };

            const parseCategoryCommand = (command, isEditMode) => {
                if (!isEditMode) { // Add category
                    const addMatch = command.match(/(?:criar|nova)\s+categoria\s+(.+?)\s+como\s+(receita|despesa)(?:\s+com\s+limite\s+(\d+[\.,]?\d*)\s+reais)?/i);
                    if (addMatch) {
                        const name = addMatch[1].trim();
                        const type = addMatch[2].toLowerCase();
                        const limit = parseFloat(addMatch[3]?.replace(',', '.')) || 0;
                        return { type: 'add-category', newName: name, categoryType: type, limit };
                    }
                } else { // Edit category
                    // Exemplo: "Mudar categoria moradia para nome Nova Moradia tipo despesa limite 1200"
                    const editMatch = command.match(/(?:mudar|alterar)\s+(?:a\s+)?categoria\s+(.+?)(?:\s+para\s+nome\s+(.+?))?(?:\s+tipo\s+(receita|despesa))?(?:\s+limite\s+(\d+[\.,]?\d*)\s+reais)?/i);
                    if (editMatch) {
                        const oldName = editMatch[1].trim();
                        const newName = editMatch[2] ? editMatch[2].trim() : null;
                        const categoryType = editMatch[3] ? editMatch[3].toLowerCase() : null;
                        const limit = editMatch[4] ? parseFloat(editMatch[4].replace(',', '.')) : null;

                        const existingCategory = Object.values(categories).find(cat => cat.name.toLowerCase() === oldName.toLowerCase());

                        if (!existingCategory) {
                            showMessage(`Categoria "${oldName}" não encontrada para edição.`, 'error');
                            return null;
                        }

                        return {
                            type: 'edit-category',
                            id: existingCategory.id,
                            newName: newName || existingCategory.name,
                            categoryType: categoryType || existingCategory.type,
                            limit: limit !== null ? limit : existingCategory.limit
                        };
                    }
                }
                return null;
            };

            recognition.onresult = (event) => {
                const command = event.results[0][0].transcript.toLowerCase();
                console.log('Comando de voz recebido:', command);
                voiceFeedbackText.textContent = `Você disse: "${command}"`;

                if (currentVoiceCommandMode === 'transaction') {
                    pendingVoiceCommand = parseTransactionCommand(command);
                    if (pendingVoiceCommand) {
                        const matchingCategory = Object.values(categories).find(
                            cat => cat.name.toLowerCase() === pendingVoiceCommand.categoryName.toLowerCase() && cat.type === pendingVoiceCommand.type
                        );

                        if (pendingVoiceCommand.categoryName && !matchingCategory) {
                            voiceFeedbackFields.innerHTML = `<p class="text-red-400">A categoria "${pendingVoiceCommand.categoryName}" do tipo "${pendingVoiceCommand.type === 'revenue' ? 'receita' : 'despesa'}" não foi encontrada.</p>`;
                            showMessage(`Categoria "${pendingVoiceCommand.categoryName}" não encontrada.`, 'error');
                            confirmVoiceCommandBtn.disabled = true;
                        } else {
                            pendingVoiceCommand.categoryId = matchingCategory ? matchingCategory.id : null;
                            voiceFeedbackFields.innerHTML = `
                                <p><strong>Descrição:</strong> ${pendingVoiceCommand.description}</p>
                                <p><strong>Valor:</strong> R$ ${pendingVoiceCommand.amount.toFixed(2).replace('.', ',')}</p>
                                <p><strong>Tipo:</strong> ${pendingVoiceCommand.type === 'revenue' ? 'Receita' : 'Despesa'}</p>
                                <p><strong>Categoria:</strong> ${matchingCategory ? matchingCategory.name : 'N/A'}</p>
                            `;
                            confirmVoiceCommandBtn.disabled = false;
                        }
                        pendingVoiceCommand.originalType = 'add-transaction';
                    } else {
                        voiceFeedbackFields.innerHTML = '<p class="text-red-400">Comando de transação não reconhecido. Tente novamente.</p>';
                        confirmVoiceCommandBtn.disabled = true;
                    }
                } else if (currentVoiceCommandMode === 'category') {
                    pendingVoiceCommand = parseCategoryCommand(command, isCategoryEditMode);
                    if (pendingVoiceCommand) {
                        if (pendingVoiceCommand.type === 'add-category') {
                            voiceFeedbackFields.innerHTML = `
                                <p><strong>Ação:</strong> Adicionar Categoria</p>
                                <p><strong>Nome:</strong> ${pendingVoiceCommand.newName}</p>
                                <p><strong>Tipo:</strong> ${pendingVoiceCommand.categoryType === 'revenue' ? 'Receita' : 'Despesa'}</p>
                                <p><strong>Limite:</strong> R$ ${pendingVoiceCommand.limit.toFixed(2).replace('.', ',')}</p>
                            `;
                        } else if (pendingVoiceCommand.type === 'edit-category') {
                             const originalCategory = categories[pendingVoiceCommand.id];
                            voiceFeedbackFields.innerHTML = `
                                <p><strong>Ação:</strong> Editar Categoria "${originalCategory.name}"</p>
                                <p><strong>Novo Nome:</strong> ${pendingVoiceCommand.newName}</p>
                                <p><strong>Novo Tipo:</strong> ${pendingVoiceCommand.categoryType === 'revenue' ? 'Receita' : 'Despesa'}</p>
                                <p><strong>Novo Limite:</strong> R$ ${pendingVoiceCommand.limit.toFixed(2).replace('.', ',')}</p>
                            `;
                        }
                        confirmVoiceCommandBtn.disabled = false;
                    } else {
                        voiceFeedbackFields.innerHTML = '<p class="text-red-400">Comando de categoria não reconhecido. Tente novamente.</p>';
                        confirmVoiceCommandBtn.disabled = true;
                    }
                }

                voiceFeedbackDetails.style.display = 'block';
            };

            recognition.onerror = (event) => {
                console.error('Erro de reconhecimento de voz:', event.error);
                voiceFeedbackText.textContent = `Erro: ${event.error}`;
                resetVoiceUI();
                showMessage('Erro no reconhecimento de voz.', 'error');
            };

            recognition.onend = () => {
                if (voiceInputBtn) voiceInputBtn.classList.remove('listening');
                if (voiceCategoryBtn) voiceCategoryBtn.classList.remove('listening');
                if (voiceEditCategoryBtn) voiceEditCategoryBtn.classList.remove('listening');
            };

            voiceInputBtn?.addEventListener('click', () => {
                currentVoiceCommandMode = 'transaction';
                recognition.start();
                voiceInputBtn.classList.add('listening');
                voiceFeedback.style.display = 'block';
                voiceFeedbackDetails.style.display = 'block';
                voiceFeedbackText.textContent = "Diga a descrição, valor, tipo e categoria. Exemplo: 'Adicionar aluguel de 1500 reais como despesa na categoria moradia'";
                voiceFeedbackFields.innerHTML = '';
            });

            voiceCategoryBtn?.addEventListener('click', () => {
                currentVoiceCommandMode = 'category';
                isCategoryEditMode = false;
                recognition.start();
                voiceFeedback.style.display = 'block';
                voiceFeedbackDetails.style.display = 'block';
                voiceFeedbackText.textContent = "Diga o nome da categoria, tipo e limite. Exemplo: 'Criar categoria mercado como despesa com limite 500 reais'";
                voiceFeedbackFields.innerHTML = '';
            });

            voiceEditCategoryBtn?.addEventListener('click', () => {
                currentVoiceCommandMode = 'category';
                isCategoryEditMode = true;
                recognition.start();
                voiceFeedback.style.display = 'block';
                voiceFeedbackDetails.style.display = 'block';
                voiceFeedbackText.textContent = "Diga as novas informações. Exemplo: 'Mudar categoria moradia para nome Nova Moradia tipo despesa limite 1200'";
                voiceFeedbackFields.innerHTML = '';
            });

            confirmVoiceCommandBtn.addEventListener('click', async () => {
                if (pendingVoiceCommand) {
                    if (pendingVoiceCommand.originalType === 'add-transaction') { // Corrected this part to use originalType
                        await addTransaction(
                            pendingVoiceCommand.description,
                            pendingVoiceCommand.amount,
                            pendingVoiceCommand.type,
                            pendingVoiceCommand.categoryId
                        );
                        transactionForm.reset();
                    } else if (pendingVoiceCommand.type === 'add-category') {
                        await addCategory(
                            pendingVoiceCommand.newName,
                            pendingVoiceCommand.categoryType,
                            pendingVoiceCommand.limit
                        );
                        categoryForm.reset();
                    } else if (pendingVoiceCommand.type === 'edit-category') {
                        await updateCategory(
                            pendingVoiceCommand.id,
                            pendingVoiceCommand.newName,
                            pendingVoiceCommand.categoryType,
                            pendingVoiceCommand.limit
                        );
                    }
                    resetVoiceUI();
                }
            });

            cancelVoiceCommandBtn.addEventListener('click', () => {
                showMessage('Comando de voz cancelado.', 'info');
                resetVoiceUI();
            });
        }

        // Initial load setup
        window.addEventListener('load', () => {
            initVoiceRecognition();
            // onAuthStateChanged is responsible for calling updateAuthUI and subsequently loadBudgetState
            // if no user is logged in, updateAuthUI will handle anonymous login and local data load
        });

    </script>
</body>
</html>
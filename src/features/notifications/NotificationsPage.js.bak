// features/notifications/NotificationsPage.js
import { eventBus } from '@core/events/eventBus.js';
import { mountPeriodIndicator } from '../../ui/PeriodIndicator.js';
import { getSelectedPeriod } from '@core/utils/globalUtils.js';
import {
  startNotificationsFor,
  markAllAsRead as ctlMarkAll,
  deleteAllRead as ctlDeleteAll,
  markOneAsRead as ctlMarkOne,
  pinOne as ctlPinOne,
  archiveOne as ctlArchiveOne,
  archiveAllRead as ctlArchiveAllRead,
} from './notificationsController.js';
import { applyNotificationFilters as applyFiltersUtil, groupNotificationsByDay as groupByDayUtil } from './utils/filters.js';
import { renderSection, renderNotificationCard } from './ui/renderCard.js';

const FILTERS_STORAGE_KEY = 'notif_filters_v1';
const DEFAULT_TYPES = [
  'new_transaction',
  'updated_transaction',
  'deleted_transaction',
  'category_added',
  'category_updated',
  'category_deleted',
  'test_notification',
];

// Shims/Fallbacks
const renderFAB = typeof window.renderFAB === 'function' ? window.renderFAB : () => {};

function getNotifFilters() {
  if (typeof window.getNotifFilters === 'function') {
    return window.getNotifFilters();
  }
  try {
    const raw = localStorage.getItem(FILTERS_STORAGE_KEY);
    if (raw) {
      const parsed = JSON.parse(raw);
      return {
        types: Array.isArray(parsed.types) && parsed.types.length ? parsed.types : DEFAULT_TYPES.slice(),
        period: parsed.period || 'all',
        unreadOnly: !!parsed.unreadOnly,
      };
    }
  } catch {}
  return { types: DEFAULT_TYPES.slice(), period: 'all', unreadOnly: false };
}

function applyNotificationFilters(list, filters) {
  if (typeof window.applyNotificationFilters === 'function') {
    return window.applyNotificationFilters(list, filters);
  }
  return applyFiltersUtil(list, filters);
}
function groupNotificationsByDay(list) {
  if (typeof window.groupNotificationsByDay === 'function') {
    return window.groupNotificationsByDay(list);
  }
  return groupByDayUtil(list);
}

// Persist√™ncia de prefer√™ncias por or√ßamento/tipo
async function loadUserNotificationPrefs() {
  try {
    const uid = window.appState?.currentUser?.uid;
    if (!uid) {
      return {};
    }
    const { getByUser } = await import('@data/repositories/userSettingsRepo.js');
    const doc = await getByUser(uid);
    return doc?.notificationPrefs || {};
  } catch {
    return {};
  }
}
async function saveUserNotificationPrefs(prefs) {
  try {
    const uid = window.appState?.currentUser?.uid;
    if (!uid) {
      return false;
    }
    const { setNotificationPrefs } = await import('@data/repositories/userSettingsRepo.js');
    await setNotificationPrefs(uid, prefs || {});
    return true;
  } catch {
    return false;
  }
}
async function toggleBudgetTypePref(budgetId, type) {
  try {
    const prefs = await loadUserNotificationPrefs();
    const byBudget = prefs.byBudget || {};
    const cur = byBudget[budgetId] || { allow: {} };
    const allow = { ...(cur.allow || {}) };
    allow[type] = !(allow[type] !== false);
    byBudget[budgetId] = { ...cur, allow };
    const next = { ...prefs, byBudget };
    await saveUserNotificationPrefs(next);
    try {
      eventBus.emit('snackbar:show', { message: 'Prefer√™ncia salva', type: 'success', duration: 2000 });
    } catch {}
  } catch {}
}

// Estado local de filtros
let notifFilters = null;
function getFiltersState() {
  if (!notifFilters) {
    notifFilters = window.__notifFilters || getNotifFilters();
  }
  return notifFilters;
}
function saveFiltersState() {
  window.__notifFilters = notifFilters;
  try {
    localStorage.setItem(
      FILTERS_STORAGE_KEY,
      JSON.stringify({
        types: Array.isArray(notifFilters.types) ? notifFilters.types : [],
        period: notifFilters.period || 'all',
        unreadOnly: !!notifFilters.unreadOnly,
      })
    );
  } catch {}
}
function toggleNotificationTypeFilter(type) {
  notifFilters = getFiltersState();
  const set = new Set(notifFilters.types || []);
  if (set.has(type)) {
    set.delete(type);
  } else {
    set.add(type);
  }
  notifFilters.types = Array.from(set);
  saveFiltersState();
  renderNotifications();
}
function setNotificationPeriod(period) {
  notifFilters = getFiltersState();
  notifFilters.period = period;
  saveFiltersState();
  renderNotifications();
}
function toggleUnreadOnly() {
  notifFilters = getFiltersState();
  notifFilters.unreadOnly = !notifFilters.unreadOnly;
  saveFiltersState();
  renderNotifications();
}
function resetNotificationFilters() {
  notifFilters = { types: DEFAULT_TYPES.slice(), period: 'all', unreadOnly: false };
  saveFiltersState();
  try {
    eventBus.emit('snackbar:show', { message: 'Filtros redefinidos', type: 'success', duration: 2000 });
  } catch {}
  renderNotifications();
}

function runNotificationAutoClean() {
  try {
    const result = clearOldNotificationsWithToast();
    renderNotifications();
    return result;
  } catch (e) {
    console.warn('Auto clean falhou', e);
  }
}
function clearOldNotificationsWithToast(daysOverride) {
  let days = 30;
  try {
    if (typeof daysOverride === 'number' && Number.isFinite(daysOverride)) {
      days = daysOverride;
    } else {
      const v = parseInt(localStorage.getItem('notif_retention_days') || '30', 10);
      if (Number.isFinite(v)) {
        days = v;
      }
    }
  } catch {}
  if (!days || days <= 0) {
    try {
      eventBus.emit('snackbar:show', { message: 'Reten√ß√£o desativada', type: 'info', duration: 2000 });
    } catch {}
    return false;
  }
  const cutoff = Date.now() - days * 24 * 60 * 60 * 1000;
  const list = Array.isArray(window.appState?.notifications) ? window.appState.notifications : [];
  const before = list.length;
  const next = list.filter((n) => {
    const d = n.createdAt?.toDate ? n.createdAt.toDate().getTime() : new Date(n.createdAt).getTime();
    return d >= cutoff;
  });
  window.appState.notifications = next;
  const removed = Math.max(0, before - next.length);
  try {
    eventBus.emit('notifications:updated', next);
  } catch {}
  if (removed > 0) {
    try {
      eventBus.emit('snackbar:show', { message: `Notifica√ß√µes antigas removidas: ${removed}`, type: 'success', duration: 2500 });
    } catch {}
  }
  return removed > 0;
}

function openNotificationTarget(id, type) {
  if (type && type.startsWith('category_')) {
    window.location.hash = '#/categories';
  } else if (type && type.includes('transaction')) {
    window.location.hash = '#/transactions';
  } else {
    window.location.hash = '#/dashboard';
  }
}
function showConfirmationModal(cfg) {
  const ok = confirm(cfg?.message || 'Confirmar?');
  if (ok && cfg?.onConfirm) {
    try {
      if (typeof cfg.onConfirm === 'function') {
        cfg.onConfirm();
      }
    } catch (e) {
      console.error('Erro no onConfirm', e);
    }
  }
  // Support for passing a global function name instead of a function reference
  if (ok && cfg?.onConfirmFn && typeof cfg.onConfirmFn === 'string') {
    try {
      const fn = window[cfg.onConfirmFn];
      if (typeof fn === 'function') {
        fn();
      }
    } catch {}
  }
}

export async function renderNotifications() {
  const content = document.getElementById('app-content');
  if (!content) {
    return;
  }

  await loadNotifications();
  const notifications = window.appState.notifications || [];
  const filters = getNotifFilters();

  const typeLabels = {
    new_transaction: 'Nova Tx',
    updated_transaction: 'Tx Atualizada',
    deleted_transaction: 'Tx Exclu√≠da',
    category_added: 'Cat Criada',
    category_updated: 'Cat Atualizada',
    category_deleted: 'Cat Exclu√≠da',
    test_notification: 'Teste',
  };

  const typeButtonsHtml = DEFAULT_TYPES.map((t) => {
    const active = filters.types.includes(t);
    return `<button onclick="window.toggleNotificationTypeFilter && window.toggleNotificationTypeFilter('${t}')" class="px-3 py-1 rounded-full text-xs font-medium ${
      active ? 'bg-blue-600 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200'
    }">${typeLabels[t]}</button>`;
  }).join('');

  const periodButtonsHtml = ['all', 'today', '7d', '30d']
    .map((p) => {
      const label = p === 'all' ? 'Tudo' : p === 'today' ? 'Hoje' : p === '7d' ? '7 dias' : '30 dias';
      const active = filters.period === p;
      return `<button onclick="window.setNotificationPeriod && window.setNotificationPeriod('${p}')" class="px-3 py-1 rounded-full text-xs font-medium ${
        active ? 'bg-indigo-600 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200'
      }">${label}</button>`;
    })
    .join('');

  const filtered = applyNotificationFilters(notifications, filters);
  const pinned = filtered.filter((n) => !!n.pinned && !n.archivedAt);
  const inbox = filtered.filter((n) => !n.pinned && !n.archivedAt);
  const archived = filtered.filter((n) => !!n.archivedAt);

  const groupedInbox = groupNotificationsByDay(inbox);
  const groupedPinned = groupNotificationsByDay(pinned);
  const groupedArchived = groupNotificationsByDay(archived);

  const curP = typeof getSelectedPeriod === 'function' ? getSelectedPeriod() : null;
  const now = new Date();
  const selYear = (curP && curP.year) || window.appState?.selectedYear || now.getFullYear();
  const selMonth = (curP && curP.month) || window.appState?.selectedMonth || now.getMonth() + 1;
  const mesesNomes = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
  const monthName = mesesNomes[(selMonth - 1) % 12] || '';

  const totalNotificacoes = filtered.length;
  const notificacoesNaoLidas = filtered.filter((n) => !n.read && !n.archivedAt).length;
  const notificacoesLidas = totalNotificacoes - notificacoesNaoLidas;
  const notificacoesHoje = filtered.filter((n) => {
    const data = n.createdAt?.toDate ? n.createdAt.toDate() : new Date(n.createdAt);
    const hoje = new Date();
    return data.toDateString() === hoje.toDateString();
  }).length;

  if (!window.renderNotificationCard) {
    window.renderNotificationCard = renderNotificationCard;
  }

  const unreadBadge = notificacoesNaoLidas > 0
    ? `<span class=\"header-unread-badge inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-200\" aria-live=\"polite\" aria-atomic=\"true\">${notificacoesNaoLidas}</span>`
    : '';
  const unreadColorClass = notificacoesNaoLidas > 0 ? 'text-yellow-200' : 'text-green-200';
  const inboxSectionHtml = inbox.length
    ? renderSection('üì¨ Inbox', groupedInbox)
    : `
            <div class="mb-8">
              <div class="flex items-center gap-2 mb-4">
                <div class="w-1 h-6 bg-gradient-to-b from-purple-500 to-pink-500 rounded-full"></div>
                <h2 class="text-xl md:text-2xl font-bold text-gray-900 dark:text-gray-100">üì¨ Inbox</h2>
              </div>
        <div class="u-card bg-white dark:bg-gray-900 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden p-4">
                <div class="empty-state">
                  <div class="empty-icon">üì¨</div>
                  <div class="empty-text">Inbox vazia</div>
                  <div class="empty-description">Voc√™ n√£o tem notifica√ß√µes no momento</div>
          <div class="mt-2"><button onclick="window.renderNotifications()" class="u-btn u-btn--primary mobile-btn">üîÑ Atualizar</button></div>
                </div>
              </div>
            </div>
          `;
  const pinnedSectionHtml = pinned.length ? renderSection('üìå Fixadas', groupedPinned) : '';
  const archivedSectionHtml = archived.length ? renderSection('üóÉÔ∏è Arquivadas', groupedArchived) : '';

  content.innerHTML = `
    <div class="tab-container">
      <div class="tab-header flex items-center justify-between">
        <h2 class="tab-title-highlight flex items-center gap-2">üîî Notifica√ß√µes ${unreadBadge}</h2>
        <div id="notif-period-indicator"></div>
      </div>
      <div class="tab-content">
        <div class="content-spacing">

          <div class="mb-8">
            <div class="flex items-center gap-2 mb-4">
              <div class="w-1 h-6 bg-gradient-to-b from-blue-500 to-indigo-500 rounded-full"></div>
              <h2 class="text-xl md:text-2xl font-bold text-gray-900 dark:text-gray-100">üìä Vis√£o Geral</h2>
            </div>
            <div class="bg-gradient-to-br from-blue-500 via-indigo-500 to-purple-600 rounded-2xl shadow-xl p-6 md:p-8 text-white">
              <div class="flex items-center justify-between mb-6">
                <div>
                  <h3 class="text-xl md:text-2xl font-bold">Centro de Notifica√ß√µes</h3>
                  <p class="text-sm opacity-90">${totalNotificacoes} notifica√ß√µes no total</p>
                  <p class="text-xs mt-1 opacity-90">Per√≠odo: <span class="font-semibold">${monthName} / ${selYear}</span></p>
                </div>
                <div class="text-right">
                  <div class="text-2xl md:text-3xl font-bold ${unreadColorClass}">${notificacoesNaoLidas}</div>
                  <p class="text-xs opacity-90">${notificacoesNaoLidas > 0 ? 'üì¨ N√£o lidas' : '‚úÖ Todas lidas'}</p>
                </div>
              </div>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white bg-opacity-15 backdrop-blur-sm rounded-xl p-4 text-center">
                  <div class="text-2xl mb-2">üìß</div>
                  <div class="text-2xl md:text-3xl font-bold">${totalNotificacoes}</div>
                  <div class="text-sm opacity-90">Total</div>
                </div>
                <div class="bg-white bg-opacity-15 backdrop-blur-sm rounded-xl p-4 text-center">
                  <div class="text-2xl mb-2">üì¨</div>
                  <div class="text-2xl md:text-3xl font-bold text-yellow-200">${notificacoesNaoLidas}</div>
                  <div class="text-sm opacity-90">N√£o lidas</div>
                </div>
                <div class="bg-white bg-opacity-15 backdrop-blur-sm rounded-xl p-4 text-center">
                  <div class="text-2xl mb-2">‚úÖ</div>
                  <div class="text-2xl md:text-3xl font-bold text-green-200">${notificacoesLidas}</div>
                  <div class="text-sm opacity-90">Lidas</div>
                </div>
                <div class="bg-white bg-opacity-15 backdrop-blur-sm rounded-xl p-4 text-center">
                  <div class="text-2xl mb-2">üìÖ</div>
                  <div class="text-2xl md:text-3xl font-bold">${notificacoesHoje}</div>
                  <div class="text-sm opacity-90">Hoje</div>
                </div>
              </div>
            </div>
          </div>

          <div class="mb-8">
            <div class="flex items-center gap-2 mb-4">
              <div class="w-1 h-6 bg-gradient-to-b from-green-500 to-teal-500 rounded-full"></div>
              <h2 class="text-xl md:text-2xl font-bold text-gray-900 dark:text-gray-100">üîß A√ß√µes & Controles</h2>
            </div>
      <div class="u-card bg-white dark:bg-gray-900 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
              <div class="bg-gradient-to-r from-green-50 to-teal-50 dark:from-gray-800 dark:to-gray-800 p-4 border-b border-gray-200 dark:border-gray-700">
              <div class="flex flex-wrap justify-between items-center gap-2">
                  <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100">Gerenciar Notifica√ß√µes</h3>
                  <div class="flex gap-2 flex-wrap">
        <button onclick="window.showConfirmationModal({ title: 'Marcar como Lidas', message: 'Deseja marcar todas as notifica√ß√µes como lidas?', confirmText: 'Sim, Marcar', confirmColor: 'bg-blue-500 hover:bg-blue-600', onConfirmFn: 'markAllNotificationsAsRead' })" class="u-btn u-btn--primary mobile-btn">‚úÖ Marcar todas como lidas</button>
        <button onclick="window.showConfirmationModal({ title: 'Arquivar notifica√ß√µes lidas', message: 'Deseja arquivar todas as notifica√ß√µes lidas? Voc√™ poder√° restaur√°-las depois.', confirmText: 'Sim, Arquivar', confirmColor: 'bg-indigo-500 hover:bg-indigo-600', onConfirmFn: 'archiveAllReadNotifications' })" class="u-btn u-btn--outline mobile-btn">üóÉÔ∏è Arquivar lidas</button>
        <button onclick="window.showConfirmationModal({ title: 'Apagar notifica√ß√µes lidas', message: 'Deseja apagar todas as notifica√ß√µes lidas? Esta a√ß√£o n√£o pode ser desfeita.', confirmText: 'Sim, Apagar', confirmColor: 'bg-red-500 hover:bg-red-600', onConfirmFn: 'deleteAllReadNotifications' })" class="u-btn u-btn--danger mobile-btn">üóëÔ∏è Apagar lidas</button>
        <button onclick="window.renderNotifications()" class="u-btn u-btn--outline mobile-btn">üîÑ Atualizar</button>
        <button onclick="window.__sendTestToOwner && window.__sendTestToOwner()" class="u-btn u-btn--outline mobile-btn">üì£ Teste ‚Üí Dono</button>
        <button onclick="window.__sendTestToShared && window.__sendTestToShared()" class="u-btn u-btn--outline mobile-btn">üì£ Teste ‚Üí Compartilhados</button>
                  </div>
                </div>
                <div class="mt-3 flex flex-col gap-3">
                  <div class="flex flex-wrap gap-2 items-center">
                    <span class="text-sm text-gray-700 dark:text-gray-300 mr-1">Tipos:</span>
                    ${typeButtonsHtml}
                  </div>
                  <div class="flex flex-wrap gap-2 items-center">
                    <span class="text-sm text-gray-700 dark:text-gray-300 mr-1">Per√≠odo:</span>
                    ${periodButtonsHtml}
                  </div>
                  <div class="flex items-center gap-2">
                    <label class="inline-flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300" title="Atalho: U">
                      <input type="checkbox" ${filters.unreadOnly ? 'checked' : ''} onchange="window.toggleUnreadOnly && window.toggleUnreadOnly()" />
                      Apenas n√£o lidas <span class="text-xs text-gray-500 dark:text-gray-400">(Atalho: U)</span>
                    </label>
        <button onclick="window.resetNotificationFilters && window.resetNotificationFilters()" class="ml-2 u-btn u-btn--ghost text-xs">‚ôªÔ∏è Redefinir filtros</button>
                  </div>
                  <div class="mt-2 p-3 rounded-xl bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700">
                    <div class="text-xs text-gray-600 dark:text-gray-300">As prefer√™ncias de notifica√ß√µes (toasts, reten√ß√£o e por or√ßamento/tipo) foram movidas para <strong>Configura√ß√µes</strong> para manter esta aba focada em consultar notifica√ß√µes.</div>
                    <div class="mt-2"><a href="#/settings" class="inline-flex items-center gap-2 text-xs px-3 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">Abrir Configura√ß√µes</a></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          ${inboxSectionHtml}

          ${pinnedSectionHtml}
          ${archivedSectionHtml}

        </div>
      </div>
    </div>
  `;

  renderFAB();

  // Montar indicador de per√≠odo padr√£o no cabe√ßalho
  try { mountPeriodIndicator('#notif-period-indicator'); } catch {}

  try {
    const prev = window.__prevNotifHeaderCount || 0;
    const curCount = (Array.isArray(window.appState?.notifications) ? window.appState.notifications.filter((n) => !n.read && !n.archivedAt).length : 0) || 0;
    const badge = document.querySelector('.header-unread-badge');
    const prefersReduce = typeof window.matchMedia === 'function' && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (badge && curCount > 0 && curCount !== prev && !prefersReduce) {
      badge.style.transform = 'scale(1.05)';
      setTimeout(() => {
        try {
          badge.style.transform = '';
        } catch {}
      }, 180);
    }
    window.__prevNotifHeaderCount = curCount;
  } catch {}

  // Expor handlers globais necess√°rios pela UI
  try {
    if (!window.__notifUIBound) {
      window.__notifUIBound = true;
      // Mapear a√ß√µes do controller
      window.markAllNotificationsAsRead = async () => { try { await ctlMarkAll(); } catch {} };
      window.deleteAllReadNotifications = async () => { try { await ctlDeleteAll(); } catch {} };
      window.archiveAllReadNotifications = async () => { try { await ctlArchiveAllRead(); } catch {} };
      window.markNotificationAsRead = async (id) => { try { await ctlMarkOne(id); } catch {} };
      window.__pinNotification = async (id, pinned) => { try { await ctlPinOne(id, pinned); } catch {} };
      window.__archiveNotification = async (id, archived) => { try { await ctlArchiveOne(id, archived); } catch {} };

      // Bot√µes de teste: enviar notifica√ß√£o para dono/compartilhados
      const bindTestHandlers = async () => {
        const { sendTestNotificationToOwner, sendTestNotificationToShared } = await import('./NotificationService.js');
        window.__sendTestToOwner = async () => {
          try {
            const budgetId = window.appState?.currentBudget?.id || window.appState?.currentBudgetId;
            const senderUid = window.appState?.currentUser?.uid;
            if (!budgetId || !senderUid) { return; }
            await sendTestNotificationToOwner(budgetId, senderUid);
          } catch (e) { console.warn(e); }
        };
        window.__sendTestToShared = async () => {
          try {
            const budgetId = window.appState?.currentBudget?.id || window.appState?.currentBudgetId;
            const senderUid = window.appState?.currentUser?.uid;
            if (!budgetId || !senderUid) { return; }
            await sendTestNotificationToShared(budgetId, senderUid);
          } catch (e) { console.warn(e); }
        };
      };
      bindTestHandlers();
    }
  } catch {}

  try {
    const prefs = await loadUserNotificationPrefs();
    const budgets = Array.isArray(window.appState?.budgets)
      ? window.appState.budgets
      : (Array.isArray(window.appState?.or√ßamentos) ? window.appState.or√ßamentos : []);
    const container = document.getElementById('notif-budget-prefs');
    if (container && Array.isArray(budgets)) {
      const types = DEFAULT_TYPES;
      container.innerHTML = budgets
        .map((b) => {
          const byBudget = prefs.byBudget || {};
          const allow = byBudget[b.id]?.allow || {};
          const row = types
            .map((t) => {
              const checked = allow[t] !== false;
              const label = typeLabels[t];
              return `<label class=\"inline-flex items-center gap-1 text-xs mr-2\"><input type=\"checkbox\" ${
                checked ? 'checked' : ''
              } onchange=\"window.__toggleBudgetTypePref && window.__toggleBudgetTypePref('${b.id}','${t}', this.checked)\"/>${label}</label>`;
            })
            .join('');
          return `<div class=\"text-xs text-gray-700 dark:text-gray-300\"><div class=\"font-semibold mb-1\">${b.nome || b.name || 'Or√ßamento'}</div><div>${row}</div></div>`;
        })
        .join('');
    }
  } catch {}

  try {
    if (!window.__notifPeriodListenerBound) {
      window.__notifPeriodListenerBound = true;
      eventBus.on('period:changed', (p) =>
        window.queueMicrotask(() => {
          const hh = (window.location.hash || '').split('?')[0];
          if (hh === '#/notifications') {
            try {
              const y = p?.year || (window.getSelectedPeriod && window.getSelectedPeriod().year);
              const m = p?.month || (window.getSelectedPeriod && window.getSelectedPeriod().month);
              if (y && m) {
                const ym = `${y}-${String(m).padStart(2, '0')}`;
                const url = new URL(window.location.href);
                url.hash = `${hh}?ym=${ym}`;
                window.history.replaceState(null, '', url.toString());
              }
            } catch {}
            renderNotifications();
          }
        })
      );
    }
    if (!window.__notifUpdatesListenerBound) {
      window.__notifUpdatesListenerBound = true;
      eventBus.on('notifications:updated', () => {
        try {
          const hh = (window.location.hash || '').split('?')[0];
          if (hh === '#/notifications') {
            renderNotifications();
          }
        } catch {}
      });
    }
  } catch {}

  try {
    if (!window.__notifHotkeysBound) {
      window.__notifHotkeysBound = true;
      document.addEventListener('keydown', (e) => {
        try {
          const tag = (e.target && (e.target.tagName || '').toLowerCase()) || '';
          if (tag === 'input' || tag === 'textarea' || tag === 'select' || (e.target && e.target.isContentEditable)) {
            return;
          }
          const hh = (window.location.hash || '').split('?')[0];
          if (hh === '#/notifications') {
            if (e.key === 'u' || e.key === 'U') {
              e.preventDefault();
              if (typeof window.toggleUnreadOnly === 'function') {
                window.toggleUnreadOnly();
              }
            }
          }
        } catch {}
      });
    }
  } catch {}
}

async function loadNotifications() {
  try {
    const u = window.appState?.currentUser;
    if (u?.uid) {
      // First, try to fetch a fresh snapshot so the UI shows items immediately
      try {
        const { listByRecipient } = await import('@data/repositories/notificationsRepo.js');
        const items = await listByRecipient(u.uid, 100);
        window.appState = window.appState || {};
        window.appState.notifications = items || [];
      } catch (e) {
        // fallback silently - startNotificationsFor will attach realtime listener
        console.warn('Falha ao buscar lista inicial de notifica√ß√µes:', e);
      }

      // Then start realtime listener (will update UI on changes)
      await startNotificationsFor(u.uid);
    }
  } catch (error) {
    console.error('Erro ao carregar notifica√ß√µes:', error);
  }
}

function markAllAsRead() {
  ctlMarkAll().catch(() => {});
}
function deleteAllReadNotifications() {
  ctlDeleteAll()
    .then(() => renderNotifications())
    .catch(() => {});
}
function markNotificationAsRead(id) {
  ctlMarkOne(id)
    .then(() => renderNotifications())
    .catch(() => {});
}
function pinNotification(id, pinned) {
  ctlPinOne(id, pinned)
    .then(() => renderNotifications())
    .catch(() => {});
}
function archiveNotification(id, archived) {
  ctlArchiveOne(id, archived)
    .then(() => renderNotifications())
    .catch(() => {});
}
function archiveAllRead() {
  ctlArchiveAllRead()
    .then(() => renderNotifications())
    .catch(() => {});
}

export default function () {
  return renderNotifications();
}

if (!window.renderNotifications) {
  window.renderNotifications = renderNotifications;
}
if (!window.toggleNotificationTypeFilter) {
  window.toggleNotificationTypeFilter = toggleNotificationTypeFilter;
}
if (!window.setNotificationPeriod) {
  window.setNotificationPeriod = setNotificationPeriod;
}
if (!window.toggleUnreadOnly) {
  window.toggleUnreadOnly = toggleUnreadOnly;
}
if (!window.resetNotificationFilters) {
  window.resetNotificationFilters = resetNotificationFilters;
}
if (!window.runNotificationAutoClean) {
  window.runNotificationAutoClean = runNotificationAutoClean;
}
if (!window.markAllNotificationsAsRead) {
  window.markAllNotificationsAsRead = markAllAsRead;
}
if (!window.deleteAllReadNotifications) {
  window.deleteAllReadNotifications = deleteAllReadNotifications;
}
if (!window.markNotificationAsRead) {
  window.markNotificationAsRead = markNotificationAsRead;
}
if (!window.__pinNotification) {
  window.__pinNotification = pinNotification;
}
if (!window.__archiveNotification) {
  window.__archiveNotification = archiveNotification;
}
if (!window.archiveAllReadNotifications) {
  window.archiveAllReadNotifications = archiveAllRead;
}
if (!window.openNotificationTarget) {
  window.openNotificationTarget = openNotificationTarget;
}
if (!window.showConfirmationModal) {
  window.showConfirmationModal = showConfirmationModal;
}
if (!window.__toggleBudgetTypePref) {
  window.__toggleBudgetTypePref = function (budgetId, type /*, checked*/) { toggleBudgetTypePref(budgetId, type); };
}

export { applyNotificationFilters as __applyNotificationFiltersForTest };
export { getNotifFilters as __getNotifFiltersForTest };
export { resetNotificationFilters as __resetNotificationFiltersForTest };
export { clearOldNotificationsWithToast as __clearOldNotificationsWithToastForTest };
